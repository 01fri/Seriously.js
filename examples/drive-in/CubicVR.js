/*
  Javascript port of CubicVR 3D engine for WebGL
  by Charles J. Cliffe
  http://www.cubicvr.org/

  May be used under the terms of the MIT license.
  http://www.opensource.org/licenses/mit-license.php
*/

/*globals alert: false */
try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(e$$5){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}
(function(y,t,s,n,g){function c(a,b){z.registry[a]=!0;var m=b(z),e;for(e in m)m.hasOwnProperty(e)&&(d[e]=m[e])}var q="";try{for(var h=t.querySelectorAll("script"),a=0,b=h.length;a<b;a++){var f=h[a].src.lastIndexOf("/CubicVR.js");f>-1&&(q=h[a].src.substr(0,f)+"/")}}catch(e){}var d=y.CubicVR={},m={CoreShader_vs:null,CoreShader_fs:null,canvas:null,width:null,height:null,fixed_aspect:0,fixed_size:null,depth_alpha:!1,default_filter:1,mainloop:null,shadow_near:0.1,shadow_far:100,soft_shadow:!1,resize_active:!1,
emptyLight:null,resizeList:[],canvasSizeFactor:1},o;try{o=console!==void 0&&console.log?function(d){console.log("CubicVR Log: "+d)}:function(){}}catch(r){o=n}var A={quality:{LOW:0,MEDIUM:1,HIGH:2}},z={undef:g,nop:n,scriptLocation:q,GLCore:m,Textures:[],Textures_obj:[],Textures_ref:[],Images:[],ShaderPool:[],log:o,registry:{},enums:A,MAX_LIGHTS:6,features:{},quality:A.HIGH},v={low:{antiAlias:!1,lightPerPixel:!1,lightShadows:!1,texturePerPixel:!1,postProcess:!1},medium:{antiAlias:!1,lightPerPixel:!0,
lightShadows:!1,texturePerPixel:!1,postProcess:!1},high:{antiAlias:!0,lightPerPixel:!0,lightShadows:!0,texturePerPixel:!0,postProcess:!0}};z.features=v.high;m.init=function(a,b,e){var f,r=d.util;b&&e?(b=r.getScriptContents(b),e=r.getScriptContents(e)):d.CubicVRCoreVS&&d.CubicVRCoreFS?(b=d.CubicVRCoreVS,e=d.CubicVRCoreFS):(b=r.getScriptContents(q+"CubicVR_Core.vs"),e=r.getScriptContents(q+"CubicVR_Core.fs"));if(a===g){a=t.createElement("canvas");f||(f=a.getContext("experimental-webgl",{antialias:z.features.antiAlias}));
m.gl=f;if(m.fixed_size!==null)m.width=m.fixed_size[0],m.height=m.fixed_size[1],m.resizeElement(a,m.width,m.height);else if(m.addResizeable(a),m.canvasSizeFactor!==1&&a.getContext!==g){var r=s.round(y.innerWidth*m.canvasSizeFactor),h=s.round(y.innerHeight*m.canvasSizeFactor);m.resizeElement(a,r,h);a.style.top=y.innerHeight/2-h/2+"px";a.style.left=y.innerWidth/2-r/2+"px";a.style.position="absolute"}else m.resizeElement(a,y.innerWidth,y.innerHeight);t.body.appendChild(a)}if(a.getContext!==g&&a.width!==
g&&a.height!==g){try{f||(f=a.getContext("experimental-webgl")),f.viewport(0,0,a.width,a.height),m.canvas=a,m.width=a.width,m.height=a.height,f.clearColor(0,0,0,1),f.clearDepth(1),f.enable(f.DEPTH_TEST),f.depthFunc(f.LEQUAL)}catch(c){}if(!f)return null}else f=a;m.gl=f;m.CoreShader_vs=b;m.CoreShader_fs=e;f.enable(f.CULL_FACE);f.cullFace(f.BACK);f.frontFace(f.CCW);for(b=A.light.type.NULL;b<A.light.type.MAX;b++)z.ShaderPool[b]=[];e=new d.Texture;a=new d.Material;for(b=0;b<A.texture.map.MAX;b++)b!==A.texture.map.BUMP&&
a.setTexture(e,b);a.opacity=0.5;b=1;try{for(;;){a.use(A.light.type.POINT,b);if(b===8){z.MAX_LIGHTS=b;break}b++}}catch(v){z.MAX_LIGHTS=b}a=m.emptyLight=new d.Light(A.light.type.POINT);a.diffuse=[0,0,0];a.specular=[0,0,0];a.distance=0;a.intensity=0;a.cutoff=0;o("Calibrated maximum lights per pass to: "+b);for(b=A.light.type.NULL;b<A.light.type.MAX;b++)z.ShaderPool[b]=[];if(m.resizeList.length)y.addEventListener("resize",function(){d.GLCore.onResize()},!1),m.resize_active=!0;return f};m.addResizeable=
function(a){d.GLCore.resizeList.push(a)};m.onResize=function(){var a=y.innerWidth,b=y.innerHeight;m.fixed_size!==null&&(a=d.GLCore.fixed_size[0],b=d.GLCore.fixed_size[1]);for(var e=0,f=d.GLCore.resizeList.length;e<f;e++)m.resizeElement(d.GLCore.resizeList[e],a,b)};m.setFixedAspect=function(a){d.GLCore.fixed_aspect=a};m.setFixedSize=function(a,b){d.GLCore.fixed_size=[a,b]};m.getCanvas=function(){return d.GLCore.canvas};m.resizeElement=function(a,b,e){var f=m.gl;if(m.fixed_aspect!==0){var o=b*(1/d.GLCore.fixed_aspect);
o>e&&(o=e,b=e*d.GLCore.fixed_aspect);e=o}if(a.getContext!==g){a.width=b;a.height=e;if(!d.GLCore.fixed_size)a.style.left=(y.innerWidth/2-b/2|0)+"px",a.style.top=(y.innerHeight/2-e/2|0)+"px",a.style.position="absolute";f.viewport(0,0,b,e)}else a.resize(b,e)};m.setDepthAlpha=function(d,a,b){m.depth_alpha=d;m.depth_alpha_near=a;m.depth_alpha_far=b};m.setDefaultFilter=function(d){m.default_filter=d};m.setSoftShadows=function(d){m.soft_shadow=d};m.setCanvasSizeFactor=function(d){m.canvasSizeFactor=d};m.setQuality=
function(d){if(d===A.quality.HIGH)z.features=v.high;else if(d===A.quality.MEDIUM)z.features=v.medium;else if(d===A.quality.LOW)z.features=v.low;z.quality=d;return z.features};m.getQuality=function(){return z.features};var w={GLCore:m,init:m.init,addResizeable:m.addResizeable,setFixedAspect:m.setFixedAspect,setFixedSize:m.setFixedSize,setCanvasSizeFactor:m.setCanvasSizeFactor,getCanvas:m.getCanvas,enums:A,IdentityMatrix:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Textures:z.Textures,Textures_obj:z.Textures_obj,
Images:z.Images,globalAmbient:[0.1,0.1,0.1],setGlobalAmbient:function(a){d.globalAmbient=a},setGlobalDepthAlpha:m.setDepthAlpha,setDefaultFilter:m.setDefaultFilter,setSoftShadows:m.setSoftShadows,setQuality:m.setQuality,getQuality:m.getQuality,RegisterModule:c,getScriptLocation:function(){return q}};c("Core",function(){return w})})(window,window.document,Math,function(){});
(function(){function y(){for(var q=0;q<s.length;q++)importScripts(CubicVR.getScriptLocation()+"/source/CubicVR."+s[q]+".js")}var t,s=["Math","Utility","Shader","MainLoop","Texture","Material","Mesh","UVMapper","Renderer","Light","Camera","Motion","Event","Scene","PostProcess","Layout","Primitives","COLLADA","GML","Particles","Landscape","Octree","CVRXML","Worker","Polygon","ScenePhysics","CollisionMap"];try{if(typeof define==="function"&&define.amd){var n=[];for(t=0;t<s.length;t++)n.push("order!./source/CubicVR."+
s[t]);define(n,function(){})}else for(t=0;t<s.length;t++)document.write('<script type="text/javascript" src="'+CubicVR.getScriptLocation()+"/source/CubicVR."+s[t]+'.js"><\/script>')}catch(g){var c=function(q){var h=q.data.data+"";CubicVR.getScriptLocation=function(){return h};y();self.removeEventListener("message",c,!1);CubicVR.InitWorker()};self.addEventListener("message",c,!1)}})();CubicVR.RegisterModule("COLLADA",function(y){function t(h,a){function b(d){if(!d.color)return!1;return(d=d.color)?e.floatDelimArray(d.$," "):!1}function f(d){var J;if(!d["float"])return!1;return J=(d=d["float"])?parseFloat(d.$):0,d=J}var e=CubicVR.util;new CubicVR.Mesh;new CubicVR.Scene;var d,m,o,r,A;A=typeof h=="object"?h:h.indexOf(".js")!=-1?e.getJSON(h):CubicVR.util.xml2badgerfish(e.getXML(h));var z,v,w,C,g,O,x,u,F,D,B,t=A;A=null;if(!t.COLLADA)throw Error(h+" does not appear to be a valid COLLADA file.");
t=t.COLLADA;A={up_axis:1,images:[],effects:[],materials:[],meshes:[],scenes:[],lights:[],cameras:[],animations:[]};if(t.asset){var y=t.asset.up_axis.$;if(y==="X_UP")A.up_axis=0;else if(y==="Y_UP")A.up_axis=1;else if(y==="Z_UP")A.up_axis=2}y=A.up_axis;if(t.library_images){if(t.library_images.image&&!t.library_images.image.length)t.library_images.image=[t.library_images.image];if(t.library_images.image.length){m=t.library_images.image;d=0;for(u=m.length;d<u;d++){var E=m[d],G=E["@id"];C=E["@name"];E=
E.init_from;if(E.$)E=E.$,a!==s&&E.lastIndexOf("/")!==-1&&(E=E.substr(E.lastIndexOf("/")+1)),a!==s&&E.lastIndexOf("\\")!==-1&&(E=E.substr(E.lastIndexOf("\\")+1)),A.images[G]={source:E,id:G,name:C}}}}var H,N,I,R,W;if(t.library_effects){var L=t.library_effects.effect;L&&!L.length&&(L=[L]);E=0;for(H=L.length;E<H;E++){u=L[E];C=u["@id"];r={};r.id=C;r.surfaces=[];r.samplers=[];(G=u.profile_COMMON.newparam)&&!G.length&&(G=[G]);if(G){m=0;for(d=G.length;m<d;m++){var P=G[m],M=P["@sid"];if(P.surface){if(r.surfaces[M]=
{},P=P.surface.init_from.$,typeof A.images[P]==="object")r.surfaces[M].source=a+"/"+A.images[P].source}else if(P.sampler2D){r.samplers[M]={};r.samplers[M].source=P.sampler2D.source.$;if(P.sampler2D.minfilter)r.samplers[M].minfilter=P.sampler2D.minfilter.$;if(P.sampler2D.magfilter)r.samplers[M].magfiter=P.sampler2D.magfilter.$}}}(m=u.profile_COMMON.technique)&&!m.length&&(m=[m]);r.material={textures_ref:[]};u=0;for(G=m.length;u<G;u++){d=m[u].blinn;if(!d)d=m[u].phong;if(!d)d=m[u].lambert;if(d)for(x in d){var S=
d[x],M=b(S),P=f(S);S=S.texture?S.texture["@texture"]:!1;M!==!1&&M.length>3&&M.pop();if(x=="emission"){if(M!==!1)r.material.ambient=M}else if(x!="ambient")if(x=="diffuse"){if(M!==!1)r.material.color=M}else if(x=="specular"){if(M!==!1)r.material.specular=M}else if(x=="shininess"&&P!==!1)r.material.shininess=P;if(S!==!1)M=r.surfaces[r.samplers[S].source].source,x=="emission"?r.material.textures_ref.push({image:M,type:n.texture.map.AMBIENT}):x=="ambient"?r.material.textures_ref.push({image:M,type:n.texture.map.AMBIENT}):
x=="diffuse"?r.material.textures_ref.push({image:M,type:n.texture.map.COLOR}):x=="specular"?r.material.textures_ref.push({image:M,type:n.texture.map.SPECULAR}):x!="shininess"&&(x=="reflective"?r.material.textures_ref.push({image:M,type:n.texture.map.REFLECT}):x!="reflectivity"&&x=="transparent"&&r.material.textures_ref.push({image:M,type:n.texture.map.ALPHA}))}A.effects[C]=r}}}u=q.getAllOf(t,"instance_geometry");x=[];if(u.length){d=0;for(m=u.length;d<m;d++)if(G=u[d],C=q.getAllOf(G,"instance_material"),
C.length){B=0;for(O=C.length;B<O;B++)H=C[B],E=H["@symbol"],H=H["@target"].substr(1),x[G["@url"].substr(1)+":"+E]=H}}if((m=t.library_materials)&&m.material){(u=m.material)&&!u.length&&(u=[u]);m=0;for(d=u.length;m<d;m++)if(C=u[m],G=C["@id"],E=C["@name"],C=C.instance_effect)C=C["@url"].substr(1),A.materials.push({id:G,name:E,mat:A.effects[C].material})}m=t.library_geometries;var Y;if(m&&((C=m.geometry)&&!C.length&&(C=[C]),C.length)){E=0;for(H=C.length;E<H;E++){var L={id:s,points:[],parts:[]},Z=C[E].mesh;
if(Z){Y=C[E]["@id"];r=C[E]["@name"];(d=Z.source)&&!d.length&&(d=[d]);r=[];u=0;for(G=d.length;u<G;u++)if(M=d[u],m=M["@id"],P=M["@name"],(S=M.float_array)&&(r[m]={id:m,name:P,data:e.floatDelimArray(S.$?S.$:""," ")}),M=M.technique_common.accessor)if(r[m].count=M["@count"]|0,r[m].stride=M["@stride"]|0,r[m].count)r[m].data=e.repackArray(r[m].data,r[m].stride,r[m].count);m=Z.vertices;var Q=S=P=M=null,$=null;if(m&&(P=m["@id"],(d=m.input)&&!d.length&&(d=[d]),d)){w=0;for(N=d.length;w<N;w++)I=d[w],I["@semantic"]===
"POSITION"&&(M=I["@source"].substr(1))}var T=Z.triangles;T&&!T.length&&(T=[T]);if(T){u=0;for(G=T.length;u<G;u++){W={material:0,faces:[],normals:[],texcoords:[],colors:[]};m=parseInt(T[u]["@count"],10);(d=T[u].input)&&!d.length&&(d=[d]);R=[];if(d.length){w=0;for(N=d.length;w<N;w++)I=d[w],g=parseInt(I["@offset"],10),o=I["@source"].substr(1),I["@semantic"]==="VERTEX"?(o===P&&(o=M),R[g]=0):I["@semantic"]==="NORMAL"?(S=o,r[S].count&&(R[g]=1)):I["@semantic"]==="TEXCOORD"?($=o,r[$].count&&(R[g]=2)):I["@semantic"]===
"COLOR"?(Q=o,r[Q].count&&(R[g]=3)):R[g]=4}w=R.length;d=Y+":"+T[u]["@material"];d===null?W.material=0:x[d]===s?(c("missing material ["+d+"]@"+Y+"?"),W.material=0):W.material=x[d];d=T[u].p;w=[];d&&(w=e.intDelimArray(d.$," "));if(w.length&&(d=w.length/R.length/3,d===m)){if(L.points.length===0)L.points=r[M].data;d=g=0;m=w.length;for(g=R.length;d<m;d+=g*3){z=[];v=[];o=[];I=[];for(B=0;B<g*3;B++)N=B%g,R[N]===0?v.push(w[d+B]):R[N]===1?z.push(w[d+B]):R[N]===2?o.push(w[d+B]):R[N]===3&&I.push(w[d+B]);v.length&&
(W.faces.push(v),z.length===3&&W.normals.push([q.fixuaxis(A.up_axis,r[S].data[z[0]]),q.fixuaxis(A.up_axis,r[S].data[z[1]]),q.fixuaxis(A.up_axis,r[S].data[z[2]])]),o.length===3&&W.texcoords.push([r[$].data[o[0]],r[$].data[o[1]],r[$].data[o[2]]]),I.length===3&&W.colors.push([r[Q].data[I[0]],r[Q].data[I[1]],r[Q].data[I[2]]]))}}L.parts.push(W)}}T=Z.polylist;if(!T)T=Z.polygons;T&&!T.length&&(T=[T]);if(T){u=0;for(G=T.length;u<G;u++){W={material:0,faces:[],normals:[],texcoords:[],colors:[]};B=parseInt(T[u]["@count"],
10);(d=T[u].input)&&!d.length&&(d=[d]);R=[];if(d.length){w=0;for(N=d.length;w<N;w++)I=d[w],m=I["@offset"],m===null&&(m=I["@idx"]),g=parseInt(m,10),o=I["@source"].substr(1),I["@semantic"]==="VERTEX"?(o===P&&(o=M),R[g]=0):I["@semantic"]==="NORMAL"?(S=o,R[g]=1):I["@semantic"]==="TEXCOORD"?($=o,R[g]=2):I["@semantic"]==="COLOR"?(Q=o,R[g]=3):R[g]=4}m=T[u].vcount;Z=[];m&&(Z=e.intDelimArray(m.$," "));d=Y+":"+T[u]["@material"];W.material=d===s?0:x[d];I=T[u].p;w=R.length;N=[];if(I.length>1&&!Z.length){m=0;
for(d=I.length;m<d;m++)g=e.intDelimArray(I[m].$," "),Z[m]=parseInt(g.length/w,10),N.splice(N.length,0,g)}else I&&(N=e.intDelimArray(I.$," "));if(N.length)if(d=Z.length,d!==B)c("poly vcount data doesn't add up, skipping object load: "+d+" !== "+B);else{if(L.points.length===0)L.points=r[M].data;d=g=0;for(m=Z.length;d<m;d++){z=[];v=[];o=[];I=[];B=0;for(O=Z[d]*w;B<O;B++)R[B%w]===0?v.push(N[g]):R[B%w]===1?z.push(N[g]):R[B%w]===2?o.push(N[g]):R[B%w]===3&&I.push(N[g]),g++;if(v.length){W.faces.push(v);if(z.length){B=
[];O=0;for(v=z.length;O<v;O++)B.push(q.fixuaxis(A.up_axis,r[S].data[z[O]]));W.normals.push(B)}if(o.length){B=[];O=0;for(v=o.length;O<v;O++)B.push(r[$].data[o[O]]);W.texcoords.push(B)}if(I.length){B=[];O=0;for(v=I.length;O<v;O++)B.push(r[Q].data[I[O]]);W.colors.push(B)}}}}L.parts.push(W)}}if(y!==1){d=0;for(m=L.points.length;d<m;d++)L.points[d]=q.fixuaxis(A.up_axis,L.points[d])}L.id=Y;A.meshes.push(L)}}}if(m=t.library_cameras){(C=m.camera)&&!C.length&&(C=[C]);x=0;for(u=C.length;x<u;x++){m=C[x];E=m["@id"];
H=G=d=0;if(m.optics&&m.optics.technique_common&&m.optics.technique_common.perspective)d=m.optics.technique_common.perspective.yfov,G=m.optics.technique_common.perspective.znear,H=m.optics.technique_common.perspective.zfar;var V;if(!d&&!G&&!H){(G=m.param)&&!G.length&&(G=[G]);d=0;for(m=G.length;d<m;d++)H=G[d].$,L=G[d]["@name"],L=="YFOV"?V=parseFloat(H):L=="ZNEAR"?F=parseFloat(H):L=="ZFAR"&&(D=parseFloat(H))}else V=d?parseFloat(d.$):60,F=G?parseFloat(G.$):0.1,D=H?parseFloat(H.$):1E3;A.cameras.push({id:E,
targeted:!1,fov:parseFloat(V),nearclip:parseFloat(F),farclip:parseFloat(D)})}}if(V=t.library_lights)if((V=V.light)&&!V.length&&(V=[V]),V){F=0;for(D=V.length;F<D;F++)if(d=V[F],x=(m=d.technique_common.point)?m:null,m=d["@id"],x!==null)d=(d=x.intensity)?parseFloat(d.$):1,u=(u=x.distance)?parseFloat(u.$):10,x=x.color,I=[1,1,1],x&&(I=e.floatDelimArray(x.$," ")),A.lights.push({id:m,name:m,type:n.light.type.POINT,method:n.light.method.STATIC,diffuse:I,specular:[0,0,0],distance:u,intensity:d})}if(F=t.library_visual_scenes){V=
null;(V=F.visual_scene)&&!V.length&&(V=[V]);F=0;for(D=V.length;F<D;F++){C=V[F];x={id:C["@id"],sceneObjects:[],cameras:[],lights:[],parentMap:[]};u=[];var G=[],X;if(m=t.library_nodes){(H=m.node)&&!H.length&&(H=[H]);u=[];d=0;for(m=H.length;d<m;d++)E=H[d],mnodeId=E["@id"],u[X]=E;for(E=[C];E.length;){H=E.pop();if(H.node&&((B=H.node)&&!B.length&&(B=[B]),B)){d=0;for(m=B.length;d<m;d++)E.push(B[d])}if(H.instance_node){(L=H.instance_node)&&!L.length&&(L=[L]);d=0;for(m=L.length;d<m;d++)if(r=L[d]["@url"].substr(1),
u[r]){if(H.node&&H.node.length)H.node=[H.node];H.node?H.node.push(u[r]):H.node=[u[r]]}}}}for(E=[C];E.length;)if(H=E.pop(),H.node&&((B=H.node)&&!B.length&&(B=[B]),B)){d=0;for(m=B.length;d<m;d++)B[d].parentNode=H,G.push(B[d]),E.push(B[d])}if(G.length){C=0;for(E=G.length;C<E;C++){M=G[C];P=M.instance_geometry;d=G[C].instance_light;m=G[C].instance_camera;X=M["@id"];H=M["@name"];L=q.cl_getInitalTransform(A.up_axis,M);if(y===2)L.rotation=q.quaternionFilterZYYZ(L.rotation,m?[-90,0,0]:s);Q=S=null;if(P){P&&
!P.length&&(P=[P]);d=0;for(m=P.length;d<m;d++){r=P[d]["@url"].substr(1);Q={};Q.name=(H?H:X)+(d?d:"");Q.id=(X?X:H)+(d?d:"");Q.meshId=Y;Q.meshName=r;if(!S)Q.position=L.position,Q.rotation=L.rotation,Q.scale=L.scale,Q.matrix=L.matrix;x.sceneObjects.push(Q);u[Q.id]=!0;M.parentNode&&((r=M.parentNode["@id"])&&u[r]?x.parentMap.push({parent:r,child:Q.id}):P.length>1&&(S?u[S.id]&&x.parentMap.push({parent:S.id,child:Q.id}):(S=Q,Q={})))}}else m?(m=m["@url"].substr(1),x.cameras.push({name:H?H:X,id:H?H:X,source:m,
position:L.position,rotation:L.rotation})):d?(m=d["@url"].substr(1),x.lights.push({name:H?H:X,id:H?H:X,source:m,position:L.position})):(Q={position:L.position,rotation:L.rotation,scale:L.scale,matrix:L.matrix},Q.name=H?H:X,Q.id=X?X:H,x.sceneObjects.push(Q),u[Q.id]=!0,M.parentNode&&(r=M.parentNode["@id"])&&u[r]&&x.parentMap.push({parent:r,child:Q.id}))}}A.scenes.push(x)}}if(Y=t.library_animations)if((X=Y.animation)&&!X.length&&(X=[X]),X){y=0;for(V=X.length;y<V;y++){x=X[y];Y=x["@id"];A.animations[Y]=
{};A.animations[Y].sources=[];(u=x.source)&&!u.length&&(u=[u]);if(u.length){F=0;for(D=u.length;F<D;F++){d=u[F];m=d["@id"];L=d.technique_common;C=G=null;d.name_array?G=e.textDelimArray(d.name_array.$," "):d.Name_array?G=e.textDelimArray(d.Name_array.$," "):d.float_array&&(C=e.floatDelimArray(d.float_array.$," "));d=0;H="";E=1;if(L)d=L,L=d.accessor,d=parseInt(L["@count"],10),H=L["@source"].substr(1),(L=L["@stride"])&&(E=parseInt(L,10));A.animations[Y].sources[m]={data:G?G:C,count:d,source:H,stride:E};
if(E!==1)A.animations[Y].sources[m].data=e.repackArray(A.animations[Y].sources[m].data,E,d)}}(u=x.sampler)&&!u.length&&(u=[u]);if(u){A.animations[Y].samplers=[];F=0;for(D=u.length;F<D;F++)if(m=u[F],G=m["@id"],(d=m.input)&&!d.length&&(d=[d]),d){E=[];C=0;for(m=d.length;C<m;C++)I=d[C],E[I["@semantic"]]=I["@source"].substr(1);A.animations[Y].samplers[G]=E}}(F=x.channel)&&!F.length&&(F=[F]);if(F){A.animations[Y].channels=[];x=0;for(u=F.length;x<u;x++)m=F[x],D=m["@source"].substr(1),m=m["@target"],G=m.split("/"),
d=G[0],G=G[1].split("."),A.animations[Y].channels.push({source:D,target:m,targetName:d,paramName:G[0],typeName:G[1]})}}}if(t=t.scene)if(C=t.instance_visual_scene)t=C["@url"].substr(1),A.scene=t;return A}var s=y.undef,n=CubicVR.enums,g=y.GLCore,c=y.log,q={fixuaxis:function(h,a){if(h===0)return[a[1],a[0],a[2]];else if(h===1)return a;else if(h===2)return[a[0],a[2],-a[1]]},fixscaleaxis:function(h,a){if(h===0)return[a[1],a[0],a[2]];else if(h===1)return a;else if(h===2)return[a[0],a[2],a[1]]},fixukaxis:function(h,
a,b,f){if(a===n.motion.POS&&b===n.motion.Z&&h===n.motion.Z)return-f;return f},getAllOf:function(h,a){for(var b=[h],f=[],e,d,m,o;b.length;)for(d in e=b.pop(),e)if(e.hasOwnProperty(d)){if(d===a)if(e[d].length){m=0;for(o=e[d].length;m<o;m++)f.push(e[d][m])}else f.push(e[d]);if(typeof e[d]=="object")if(e[d].length){m=0;for(o=e[d].length;m<o;m++)b.push(e[d][m])}else b.push(e[d])}return f},quaternionFilterZYYZ:function(h,a){var b=CubicVR.vec3,f=h,e=new CubicVR.Quaternion;a!==s&&(f=b.add(h,a));e.fromEuler(f[0],
f[2],-f[1]);return e.toEuler()},cl_getInitalTransform:function(h,a){var b=CubicVR.util,f={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},e=a.translate,d=a.rotate,m=a.scale;if(a.matrix&&!e&&!d&&!m)return f;if(e)f.position=q.fixuaxis(h,b.floatDelimArray(e.$," "));if(d)for(var e=0,o=d.length;e<o;e++){var r=d[e],c=r["@sid"],r=b.floatDelimArray(r.$," ");if(c=="rotateX"||c=="rotationX")f.rotation[0]=r[3];else if(c=="rotateY"||c=="rotationY")f.rotation[1]=r[3];else if(c=="rotateZ"||c=="rotationZ")f.rotation[2]=
r[3]}if(m)f.scale=q.fixscaleaxis(h,b.floatDelimArray(m.$," "));return f}};return{loadCollada:function(h,a,b){var a=t(h,a,b),f=a.up_axis,e=[],d,m,o,r,c,z,v,w;m=0;for(o=a.materials.length;m<o;m++){c=a.materials[m];v=new CubicVR.Material(c.mat);z=0;for(r=c.mat.textures_ref.length;z<r;z++){w=c.mat.textures_ref[z];var C=null,C=y.Textures_ref[w.image]===void 0?new CubicVR.Texture(w.image,g.default_filter,b,h):y.Textures_obj[y.Textures_ref[w.image]];v.setTexture(C,w.type)}e[c.id]=v}z=[];m=0;for(o=a.meshes.length;m<
o;m++){var C=a.meshes[m],J=new CubicVR.Mesh(C.id);J.points=C.points;var O=!1;v=0;for(w=C.parts.length;v<w;v++){var x=C.parts[v];x.material!==0&&((r=e[x.material])||(r=new CubicVR.Material({name:x.material})),J.setFaceMaterial(r));var u=x.normals.length?!0:!1,F=x.texcoords.length?!0:!1,D=x.colors.length?!0:!1;if(D)e[x.material].color_map=!0;r=0;for(c=x.faces.length;r<c;r++){var B=J.addFace(x.faces[r]);if(u)J.faces[B].point_normals=x.normals[r];if(F)J.faces[B].uvs=x.texcoords[r];if(D)J.faces[B].point_colors=
x.colors[r]}O|=u}J.faces.length&&(b?b.addMesh(h,h+":"+meshId,J):(O||J.calcNormals(),J.triangulateQuads(),J.compile()),z[C.id]=J)}o=[];h=0;for(r=a.cameras.length;h<r;h++)o[a.cameras[h].id]=a.cameras[h];C=[];r=0;for(c=a.lights.length;r<c;r++)C[a.lights[r].id]=a.lights[r];b={};e={};m={};h={};v=0;for(w=a.scenes.length;v<w;v++){J=a.scenes[v];O=new CubicVR.Scene;r=0;for(c=J.sceneObjects.length;r<c;r++)x=J.sceneObjects[r],u=new CubicVR.SceneObject(x),u.obj=(z[x.meshName]?z[x.meshName]:z[x.meshId])||null,
x.matrix&&u.setMatrix(x.matrix),b[x.id]=u,O.bindSceneObject(u);r=0;for(c=J.lights.length;r<c;r++)x=J.lights[r],u=new CubicVR.Light(C[x.source]),u.position=x.position,e[x.id]=u,O.bindLight(u);if(J.cameras.length)r=J.cameras[0],c=new CubicVR.Camera(o[r.source]),c.position=r.position,c.rotation=r.rotation,m[r.id]=c,O.camera=c;r=0;for(c=J.parentMap.length;r<c;r++)x=J.parentMap[r],b[x.parent].bindChild(b[x.child]);h[J.id]=O}for(var U in a.animations)if(a.animations.hasOwnProperty(U)&&(z=a.animations[U],
z.channels.length)){cCount=0;for(r=z.channels.length;cCount<r;cCount++){o=z.channels[cCount];x=z.samplers[o.source];c=z.sources[x.INPUT];v=z.sources[x.OUTPUT];w=z.sources[x.INTERPOLATION];var C=z.sources[x.IN_TANGENT],J=z.sources[x.OUT_TANGENT],O=x.IN_TANGENT!==s,x=x.OUT_TANGENT!==s,u=null,D=b[o.targetName],F=m[o.targetName],K=e[o.targetName];if(D){if(D.motion===null)D.motion=new CubicVR.Motion;u=D.motion}else if(F){if(F.motion===null)F.motion=new CubicVR.Motion;u=F.motion}else if(K){if(K.motion===
null)K.motion=new CubicVR.Motion;u=K.motion}if(u!==null){D=n.motion.POS;B=n.motion.X;if(f===2)u.yzflip=!0;d=o.paramName;if(d==="rotateX"||d==="rotationX")D=n.motion.ROT,B=n.motion.X;else if(d==="rotateY"||d==="rotationY")D=n.motion.ROT,B=n.motion.Y;else if(d==="rotateZ"||d==="rotationZ")D=n.motion.ROT,B=n.motion.Z;else if(d==="location"){D=n.motion.POS;if(o.typeName==="X")B=n.motion.X;if(o.typeName==="Y")B=n.motion.Y;if(o.typeName==="Z")B=n.motion.Z}else if(d==="translate"){D=n.motion.POS;if(o.typeName===
"X")B=n.motion.X;if(o.typeName==="Y")B=n.motion.Y;if(o.typeName==="Z")B=n.motion.Z}else if(d==="LENS")continue;else if(d==="FOV")D=n.motion.FOV,B=3;else if(d==="ZNEAR")D=n.motion.NEARCLIP,B=3;else if(d==="ZFAR")D=n.motion.FARCLIP,B=3;else if(d==="intensity")D=n.motion.INTENSITY,B=3;if(K&&D<3)K.method=n.light.method.DYNAMIC;mCount=0;for(o=c.data.length;mCount<o;mCount++)if(k=null,typeof v.data[mCount]==="object"){i=0;for(iMax=v.data[mCount].length;i<iMax;i++)if(K=i,f===2&&i===2?K=1:f===2&&i===1&&(K=
2),k=u.setKey(D,K,c.data[mCount],q.fixukaxis(a.up_axis,D,K,v.data[mCount][i])),w)if(d=w.data[mCount][i],d==="LINEAR")k.shape=n.envelope.shape.LINE;else if(d==="BEZIER")k.shape=!O&&!x?n.envelope.shape.LINEAR:n.envelope.shape.BEZI}else if(K=B,ofs=0,F&&D===n.motion.ROT&&f===2&&K===0&&(ofs=-90),D===n.motion.ROT?k=u.setKey(D,K,c.data[mCount],v.data[mCount]+ofs):(f===2&&B===2?K=1:f===2&&B===1&&(K=2),k=u.setKey(D,K,c.data[mCount],q.fixukaxis(a.up_axis,D,K,v.data[mCount]))),w)if(d=w.data[mCount],d==="LINEAR")k.shape=
n.envelope.shape.LINE;else if(d==="BEZIER")if(!O&&!x)k.shape=n.envelope.shape.LINEAR,k.continutity=1;else{k.shape=n.envelope.shape.BEZ2;d=C.data[mCount][0];var E,G=J.data[mCount][0];D===n.motion.ROT?(E=C.data[mCount][1],K=J.data[mCount][1],k.param[0]=d-k.time,k.param[1]=E-k.value+ofs,k.param[2]=G-k.time,k.param[3]=K-k.value+ofs):(E=q.fixukaxis(a.up_axis,D,K,C.data[mCount][1]),K=q.fixukaxis(a.up_axis,D,K,J.data[mCount][1]),k.param[0]=d-k.time,k.param[1]=E-k.value,k.param[2]=G-k.time,k.param[3]=K-k.value)}}}}U=
null;return U=a.scene?h[a.scene]:h.pop()},parseCollada:t}});CubicVR.RegisterModule("CVRXML",function(y){function t(a,e,d,m){var o=CubicVR.util,r=null,h=null;m.triangles&&(h=o.intDelimArray(b.getTextNode(m,"triangles")," "));if(h&&(m.segments&&(r=o.intDelimArray(b.getTextNode(m,"segments")," ")),r===null&&(r=[0,parseInt(h.length/3,10)]),m=0,a.setFaceMaterial(e),h.length)){p=0;for(pMax=r.length;p<pMax;p+=2){e=r[p+1]*3;a.setSegment(r[p]);j=m;for(jMax=m+e;j<jMax;j+=3)o=a.addFace([h[j],h[j+1],h[j+2]]),d&&a.faces[o].setUV([d[j],d[j+1],d[j+2]]);m+=e}}}function s(a){var e=
CubicVR.util,d=new CubicVR.UVMapper,m=null,o=null;if(a.type)switch(m=b.getTextNode(a,"type"),m){case "planar":d.projection_mode=h.uv.projection.PLANAR;break;case "cylindrical":d.projection_mode=h.uv.projection.CYLINDRICAL;break;case "spherical":d.projection_mode=h.uv.projection.SPHERICAL;break;case "cubic":d.projection_mode=h.uv.projection.CUBIC}if(!m)return null;m==="uv"&&a.uv&&(o=b.getPoints(a,"uv"));if(a.axis)switch(b.getTextNode(a,"axis")){case "x":d.projection_axis=h.uv.axis.X;break;case "y":d.projection_axis=
h.uv.axis.Y;break;case "z":d.projection_axis=h.uv.axis.Z}if(a.center)d.center=e.floatDelimArray(b.getTextNode(a,"center"));if(a.rotation)d.rotation=e.floatDelimArray(b.getTextNode(a,"rotation"));if(a.scale)d.scale=e.floatDelimArray(b.getTextNode(a,"scale"));if(a.wrap_w)d.wrap_w_count=parseFloat(b.getTextNode(a,"wrap_w"));if(a.wrap_h)d.wrap_h_count=parseFloat(b.getTextNode(a,"wrap_h"));return m!==""&&m!=="uv"?d:o}function n(f,e){if(a[f]!==q)return a[f];var d=CubicVR.util,m,o,r,c;m=null;m=typeof f==
"object"?f:f.indexOf(".js")!=-1?d.getJSON(f):CubicVR.util.xml2badgerfish(d.getXML(f));if(m.root)m=m.root;if(m.properties)m=m.properties;d=new CubicVR.Mesh;m.points&&(r=b.getPoints(m,"points"))&&d.addPoint(r);var z=m.material;z&&!z.length&&(z=[z]);var v=[];if(z){m=0;for(r=z.length;m<r;m++){var w=z[m],C;C=w;var g=e,n=new CubicVR.Material(C.name?C.name.$:null);if(C.shininess)n.shininess=b.getFloatNode(C,"shininess",n.shininess)/100;n.opacity=b.getFloatNode(C,"alpha",n.opacity);n.max_smooth=b.getFloatNode(C,
"max_smooth",n.max_smooth);n.color=b.getFloatDelimNode(C,"color",n.color);n.ambient=b.getFloatDelimNode(C,"ambient",n.ambient);n.diffuse=b.getFloatDelimNode(C,"diffuse",n.diffuse);n.specular=b.getFloatDelimNode(C,"specular",n.specular);o=void 0;if(o=b.getTextNode(C,"texture"))o=(g?g:"")+o,tex=y.Textures_ref[o]!==q?y.Textures_obj[y.Textures_ref[o]]:new CubicVR.Texture(o),n.setTexture(tex,h.texture.map.COLOR);if(o=b.getTextNode(C,"texture_luminosity"))o=(g?g:"")+o,tex=y.Textures_ref[o]!==q?y.Textures_obj[y.Textures_ref[o]]:
new CubicVR.Texture(o),n.setTexture(tex,h.texture.map.AMBIENT);if(o=b.getTextNode(C,"texture_normal"))o=(g?g:"")+o,tex=y.Textures_ref[o]!==q?y.Textures_obj[y.Textures_ref[o]]:new CubicVR.Texture(o),n.setTexture(tex,h.texture.map.NORMAL);if(o=b.getTextNode(C,"texture_specular"))o=(g?g:"")+o,tex=y.Textures_ref[o]!==q?y.Textures_obj[y.Textures_ref[o]]:new CubicVR.Texture(o),n.setTexture(tex,h.texture.map.SPECULAR);if(o=b.getTextNode(C,"texture_bump"))o=(g?g:"")+o,tex=y.Textures_ref[o]!==q?y.Textures_obj[y.Textures_ref[o]]:
new CubicVR.Texture(o),n.setTexture(tex,h.texture.map.BUMP);if(o=b.getTextNode(C,"texture_envsphere"))o=(g?g:"")+o,tex=y.Textures_ref[o]!==q?y.Textures_obj[y.Textures_ref[o]]:new CubicVR.Texture(o),n.setTexture(tex,h.texture.map.ENVSPHERE);if(o=b.getTextNode(C,"texture_alpha"))o=(g?g:"")+o,tex=y.Textures_ref[o]!==q?y.Textures_obj[y.Textures_ref[o]]:new CubicVR.Texture(o),n.setTexture(tex,h.texture.map.ALPHA);C=n;var x=null;o=g=null;w.uvmapper&&((g=s(w.uvmapper))&&!g.length?v.push([g,C]):o=g);(n=w.part)&&
!n.length&&(n=[n]);if(n&&n.length){var u=null,F=null;o=0;for(c=n.length;o<c;o++){var D=n[o],u=null;if(x=D.uvmapper)if(u=s(x),w.triangles)F=x=d.faces.length,u&&!u.length?(t(d,C,null,D),F=d.faces.length-1,d.calcFaceNormals(x,F),u.apply(d,C,q,x,F)):u&&u.length?t(d,C,u,D):g&&!g.length&&(t(d,C,null,D),F=d.faces.length-1,d.calcFaceNormals(x,F),g.apply(d,C,q,x,F));if(D.procedural){(x=D.uvmapper)&&(u=s(x));var F=D.transform?b.getTransform(D.transform):q,x=q,D=D.procedural,B=b.getTextNode(D,"type");F&&(x=
new CubicVR.Transform,x.translate(F.position),x.pushMatrix(),x.rotate(F.rotation),x.pushMatrix(),x.scale(F.scale));g||(g=q);u={material:C,uvmapper:g||u};if(B==="box"||B==="cube")u.size=b.getFloatNode(D,"size"),d.booleanAdd(CubicVR.primitives.box(u),x);else if(B==="sphere")u.radius=b.getFloatNode(D,"radius"),u.lat=b.getIntNode(D,"lat"),u.lon=b.getIntNode(D,"lon"),d.booleanAdd(CubicVR.primitives.sphere(u),x);else if(B==="cone")u.base=b.getFloatNode(D,"base"),u.height=b.getFloatNode(D,"height"),u.lon=
b.getIntNode(D,"lon"),d.booleanAdd(CubicVR.primitives.cone(u),x);else if(B==="plane")u.size=b.getFloatNode(D,"size"),d.booleanAdd(CubicVR.primitives.plane(u),x);else if(B==="cylinder")u.radius=b.getFloatNode(D,"radius"),u.height=b.getFloatNode(D,"height"),u.lon=b.getIntNode(D,"lon"),d.booleanAdd(CubicVR.primitives.cylinder(u),x);else if(B==="torus")u.innerRadius=b.getFloatNode(D,"innerRadius"),u.outerRadius=b.getFloatNode(D,"outerRadius"),u.lat=b.getIntNode(D,"lat"),u.lon=b.getIntNode(D,"lon"),d.booleanAdd(CubicVR.primitives.torus(u),
x);else if(B==="lathe")u.points=b.getPoints(D,"p"),u.lon=b.getIntNode(D,"lon"),d.booleanAdd(CubicVR.primitives.lathe(u),x);else if(B==="polygon"){F=b.getPoints(D,"p");F=new CubicVR.Polygon(F);(B=D.cut)&&!B.length&&(B=[B]);if(B.length){o=0;for(r=B.length;o<c;o++)F.cut(new CubicVR.Polygon(b.getPoints(B[o])))}u.front=0;u.back=0;u.frontShift=0;u.backShift=0;u.frontDepth=0;u.backDepth=0;if(D.extrude){D=D.extrude;u.front=b.getFloatNode(D,"front",0);u.back=b.getFloatNode(D,"back",0);u.frontShift=b.getFloatNode(D,
"frontBevelShift",0);u.backShift=b.getFloatNode(D,"backBevelShift",0);u.frontDepth=b.getFloatNode(D,"frontBevelDepth",0);u.backDepth=b.getFloatNode(D,"backBevelDepth",0);u.depth=b.getFloatNode(D,"depth",0);u.shift=b.getFloatNode(D,"shift",0);u.bevel=b.getFloatNode(D,"bevel",0);if(u.depth&&!u.backDepth&&!u.frontDepth)u.front=-u.depth/2,u.back=u.depth/2;if(u.shift&&!u.backShift&&!u.frontShift)u.frontShift=u.shift,u.backShift=u.shift;if(u.bevel&&!u.backDepth&&!u.frontDepth)u.frontDepth=u.bevel,u.backDepth=
u.bevel}D=F.toExtrudedBeveledMesh(new CubicVR.Mesh,u);D.setFaceMaterial(u.material);d.booleanAdd(D,x)}}}}else t(d,C,o,w)}}d.triangulateQuads();d.calcNormals();m=0;for(r=v.length;m<r;m++)v[m][0].apply(d,v[m][1]);d.compile();return a[f]=d}function g(a){if(a===null)return!1;return a.getElementsByTagName("x").length||a.getElementsByTagName("y").length||a.getElementsByTagName("z").length||a.getElementsByTagName("fov").length}function c(a,b,d){var m=CubicVR.util,o=[];o[0]=a.getElementsByTagName("x");o[1]=
a.getElementsByTagName("y");o[2]=a.getElementsByTagName("z");o[3]=a.getElementsByTagName("fov");var r,c,z,v,w,g;for(g in o)if(o.hasOwnProperty(g)&&o[g]!==q&&o[g].length){r=o[g][0].getElementsByTagName("time");c=o[g][0].getElementsByTagName("value");z=o[g][0].getElementsByTagName("in");v=o[g][0].getElementsByTagName("out");w=o[g][0].getElementsByTagName("tcb");var n=null,s=null,x=null,u=a=null;z.length&&(a=m.collectTextNode(z[0]));v.length&&(u=m.collectTextNode(v[0]));r.length&&(n=m.floatDelimArray(m.collectTextNode(r[0]),
" "));c.length&&(s=m.floatDelimArray(m.collectTextNode(c[0])," "));w.length&&(x=m.floatDelimArray(m.collectTextNode(w[0])," "));if(n!==null&&s!==null){r=0;for(c=n.length;r<c;r++)if(z=d.setKey(b,g,n[r],s[r]),x)z.tension=x[r*3],z.continuity=x[r*3+1],z.bias=x[r*3+2]}s=n=h.envelope.behavior.CONSTANT;if(a)switch(a){case "reset":n=h.envelope.behavior.RESET;break;case "constant":n=h.envelope.behavior.CONSTANT;break;case "repeat":n=h.envelope.behavior.REPEAT;break;case "oscillate":n=h.envelope.behavior.OSCILLATE;
break;case "offset":n=h.envelope.behavior.OFFSET;break;case "linear":n=h.envelope.behavior.LINEAR}if(u)switch(u){case "reset":s=h.envelope.behavior.RESET;break;case "constant":s=h.envelope.behavior.CONSTANT;break;case "repeat":s=h.envelope.behavior.REPEAT;break;case "oscillate":s=h.envelope.behavior.OSCILLATE;break;case "offset":s=h.envelope.behavior.OFFSET;break;case "linear":s=h.envelope.behavior.LINEAR}d.setBehavior(b,g,n,s)}}var q=y.undef,h=CubicVR.enums,a=[],b={getPoints:function(a,e,d){a=e?
b.getTextNode(a,e):a.$;if(!a)return q;a=a.split(" ");i=0;for(iMax=a.length;i<iMax;i++){a[i]=a[i].split(",");j=0;for(jMax=a[i].length;j<jMax;j++)a[i][j]=parseFloat(a[i][j]);d&&(a[i][2]=0)}return a},getTransform:function(a){var b=CubicVR.util;if(!a)return null;var d={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},m;postition=a.position;m=a.rotation;a=a.scale;if(m)d.rotation=b.floatDelimArray(m.$);if(a)d.scale=b.floatDelimArray(a.$);if(m||a)return d;return null},getTextNode:function(a,b,d){a=a[b];
if(!a)return d;a.length&&(a=a[0]);if(a.$)return a.$;return d},getFloatNode:function(a,e,d){if(a=b.getTextNode(a,e)){a=parseFloat(a);if(a!=a)return d;return a}return d},getIntNode:function(a,e,d){if(a=b.getTextNode(a,e)){a=parseInt(a,10);if(a!=a)return d;return a}return d},getFloatDelimNode:function(a,e,d,m){var o=CubicVR.util;if(a=b.getTextNode(a,e))return o.floatDelimArray(a,m);return d},getIntDelimNode:function(a,e,d,m){var o=CubicVR.util;if(a=b.getTextNode(a,e))return o.intDelimArray(a,m);return d}};
return{loadMesh:n,loadScene:function(a,b,d){var m=CubicVR.util;b===q&&(b="");d===q&&(d="");for(var o=new CubicVR.Mesh,r=m.getXML(a),a=new CubicVR.Scene,A=[],z=r.getElementsByTagName("sceneobjects"),v,w,C,s=0,t=z[0].childNodes.length;s<t;s++){var x=z[0].childNodes[s];if(x.tagName==="sceneobject"){var u="unnamed",F="",D="",o=x.getElementsByTagName("name");o.length&&(u=m.collectTextNode(o[0]));o=x.getElementsByTagName("parent");o.length&&(F=m.collectTextNode(o[0]));o=x.getElementsByTagName("model");
o.length&&(D=m.collectTextNode(o[0]));C=w=v=null;o=x.getElementsByTagName("position");o.length&&(v=o[0]);o=x.getElementsByTagName("rotation");o.length&&(w=o[0]);o=x.getElementsByTagName("scale");o.length&&(C=o[0]);o=null;D!==""&&(o=n(b+D,d));o=new CubicVR.SceneObject(o,u);if(g(v)){if(!o.motion)o.motion=new CubicVR.Motion;c(v,h.motion.POS,o.motion)}else if(v)o.position=m.floatDelimArray(m.collectTextNode(v));if(g(w)){if(!o.motion)o.motion=new CubicVR.Motion;c(w,h.motion.ROT,o.motion)}else o.rotation=
m.floatDelimArray(m.collectTextNode(w));if(g(C)){if(!o.motion)o.motion=new CubicVR.Motion;c(C,h.motion.SCL,o.motion)}else o.scale=m.floatDelimArray(m.collectTextNode(C));a.bindSceneObject(o);F!==""&&A.push([o,F])}}for(var B in A)A.hasOwnProperty(B)&&a.getSceneObject(A[B][1]).bindChild(A[B][0]);b=r.getElementsByTagName("camera");if(b.length){w=v=null;d="";o=b[0].getElementsByTagName("name");B=a.camera;r=null;if(o.length)d=o[0].firstChild.nodeValue;o=b[0].getElementsByTagName("target");if(o.length)d=
o[0].firstChild.nodeValue;if(d!=="")B.targetSceneObject=a.getSceneObject(d);o=b[0].getElementsByTagName("position");o.length&&(v=o[0]);o=b[0].getElementsByTagName("rotation");o.length&&(w=o[0]);o=b[0].getElementsByTagName("fov");o.length&&(r=o[0]);if(g(v)){if(!B.motion)B.motion=new CubicVR.Motion;c(v,h.motion.POS,B.motion)}else if(v)B.position=m.floatDelimArray(v.firstChild.nodeValue);if(g(w)){if(!B.motion)B.motion=new CubicVR.Motion;c(w,h.motion.ROT,B.motion)}else if(w)B.rotation=m.floatDelimArray(w.firstChild.nodeValue);
if(g(r)){if(!B.motion)B.motion=new CubicVR.Motion;c(r,h.motion.FOV,B.motion)}else if(r)B.fov=parseFloat(r.firstChild.nodeValue)}return a}}});CubicVR.RegisterModule("Camera",function(y){function t(a,b,f,e,d){var m=CubicVR.mat4;this.frustum=new CubicVR.Frustum;typeof a=="object"?(this.position=a.position?a.position:[0,0,0],this.rotation=a.rotation?a.rotation:[0,0,0],this.target=a.target?a.target:[0,0,0],this.fov=a.fov?a.fov:60,this.nearclip=a.nearclip?a.nearclip:0.1,this.farclip=a.farclip?a.farclip:400,this.targeted=a.targeted?a.targeted:!0,this.calc_nmatrix=a.calcNormalMatrix?a.calcNormalMatrix:!0,this.name=a.name||"camera"+h,b=a.height?
a.height:g,a=a.width?a.width:g):(this.position=[0,0,0],this.rotation=[0,0,0],this.target=[0,0,0],this.fov=f!==g?f:60,this.nearclip=e!==g?e:0.1,this.farclip=d!==g?d:400,this.calc_nmatrix=this.targeted=!0,this.name="camera"+h);this.motion=this.targetSceneObject=null;this.transform=new CubicVR.Transform;this.manual=!1;this.setDimensions(a!==g?a:512,b!==g?b:512);this.mvMatrix=m.identity();this.pMatrix=null;this.calcProjection();this.ortho=!1;this.ortho_view={left:-1,right:1,bottom:-1,top:1};this.parent=
null;++h}function s(a){this.position=a!==g?a:[0,0,0]}function n(a,b,f){this.camPath=new CubicVR.Motion;this.targetPath=new CubicVR.Motion;this.start_position=a!==g?a:[8,8,8];this.target=b!==g?b:[0,0,0];this.bounds=f!==g?f:[[-15,3,-15],[15,20,15]];this.safe_bb=[];this.avoid_sphere=[];this.segment_time=3;this.buffer_time=20;this.path_length=this.path_time=this.current_time=this.start_time=0;this.min_distance=2;this.angle_min=this.max_distance=40;this.angle_max=180}var g=y.undef,c=CubicVR.enums,q=[1,
0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],h=0;t.prototype={trackTarget:function(a,b,f){this.position=CubicVR.vec3.trackTarget(this.position,a,b,f)},setParent:function(a){this.parent=a},hasParent:function(){return!!this.parent},getParent:function(){return this.parent},getParentedPosition:function(){return this.parent!==null&&this.mvMatrix&&this.parent.tMatrix?CubicVR.mat4.vec3_multiply(this.position,this.parent.tMatrix):this.position},setOrtho:function(a,b,f,e){this.ortho=!0;this.ortho_view.left=a;this.ortho_view.right=
b;this.ortho_view.bottom=f;this.ortho_view.top=e},control:function(a,b,f){a===c.motion.ROT?this.rotation[b]=f:a===c.motion.POS?this.position[b]=f:a===c.motion.FOV?this.setFOV(f):a===c.motion.LENS?this.setLENS(f):a===c.motion.NEARCLIP?this.setClip(f,this.farclip):a===c.motion.FARCLIP&&this.setClip(this.nearclip,f)},makeFrustum:function(a,b,f,e,d,m){return[2*d/(b-a),0,0,0,0,2*d/(e-f),0,0,(b+a)/(b-a),(e+f)/(e-f),-(m+d)/(m-d),-1,0,0,-2*m*d/(m-d),0]},setTargeted:function(a){this.targeted=a},calcProjection:function(){var a=
CubicVR.mat4,b=CubicVR.mat3;this.pMatrix=this.ortho?a.ortho(this.ortho_view.left,this.ortho_view.right,this.ortho_view.bottom,this.ortho_view.top,this.nearclip,this.farclip):a.perspective(this.fov,this.aspect,this.nearclip,this.farclip);if(!this.targeted)a.identity(this.mvMatrix),a.rotate(-this.rotation[0],-this.rotation[1],-this.rotation[2],this.mvMatrix),a.translate(-this.position[0],-this.position[1],-this.position[2],this.mvMatrix),this.parent!==null&&a.multiply(this.mvMatrix.slice(0),a.inverse(this.parent.tMatrix),
this.mvMatrix),this.calc_nmatrix?(this.nMatrix=a.inverse_mat3(this.mvMatrix),b.transpose_inline(this.nMatrix)):a.identity(this.nMatrix);this.frustum.extract(this,this.mvMatrix,this.pMatrix)},setClip:function(a,b){this.nearclip=a;this.farclip=b;this.calcProjection()},setDimensions:function(a,b){this.width=a;this.height=b;this.aspect=a/b;this.calcProjection()},resize:function(a,b){this.setDimensions(a,b)},setFOV:function(a){this.fov=a;this.ortho=!1;this.calcProjection()},setLENS:function(a){this.setFOV(2*
Math.atan(16/a)*(180/Math.PI))},lookat:function(a,b,f,e,d,m,o,r,h){var c=CubicVR.mat4,v=CubicVR.mat3;if(typeof a=="object")this.lookat(this.position[0],this.position[1],this.position[2],a[0],a[1],a[2],0,1,0);else{this.mvMatrix=c.lookat(a,b,f,e,d,m,o,r,h);if(this.rotation[2])this.transform.clearStack(),this.transform.rotate(-this.rotation[2],0,0,1),this.transform.pushMatrix(this.mvMatrix),this.mvMatrix=this.transform.getResult();this.parent!==null&&c.multiply(this.mvMatrix.slice(0),c.inverse(this.parent.tMatrix),
this.mvMatrix);this.calc_nmatrix?(this.nMatrix=c.inverse_mat3(this.mvMatrix),v.transpose_inline(this.nMatrix)):this.nMatrix=q;this.frustum.extract(this,this.mvMatrix,this.pMatrix)}},unProject:function(a,b,f){var e=CubicVR.mat4,d=CubicVR.vec3,m=[0,0,this.width,this.height],a=e.vec4_multiply(e.vec4_multiply([(a-m[0])/m[2]*2-1,-((b-m[1])/m[3]*2-1),1,1],e.inverse(this.pMatrix)),e.inverse(this.mvMatrix)),a=[a[0]/a[3],a[1]/a[3],a[2]/a[3]];if(f!==g)return b=this.getParentedPosition(),d.add(b,d.multiply(d.normalize(d.subtract(a,
b)),f));return a},project:function(a,b,f){var e=CubicVR.mat4,e=e.vec4_multiply(e.vec4_multiply([a,b,f,1],this.mvMatrix),this.pMatrix);e[2]=CubicVR.vec3.length(CubicVR.vec3.subtract([a,b,f],this.position));return[(e[0]/e[3]+1)/2*this.width,(-e[1]/e[3]+1)/2*this.height,e[2]]}};s.prototype={control:function(a,b,f){a===c.motion.POS&&(this.position[b]=f)}};n.prototype={inBounds:function(a){var b=CubicVR.vec3;if(!(a[0]>this.bounds[0][0]&&a[1]>this.bounds[0][1]&&a[2]>this.bounds[0][2]&&a[0]<this.bounds[1][0]&&
a[1]<this.bounds[1][1]&&a[2]<this.bounds[1][2]))return!1;for(var f=0,e=this.avoid_sphere.length;f<e;f++)if(b.length(a,this.avoid_sphere[f][0])<this.avoid_sphere[f][1])return!1;return!0},findNextNode:function(a,b){var f=CubicVR.vec3,e=[0,0,0],d=[0,0,0],m=e=0,o=!1;do if(d[0]=Math.random()-0.5,d[1]=Math.random()-0.5,d[2]=Math.random()-0.5,d=f.normalize(d),e=Math.random()*(this.max_distance-this.min_distance)+this.min_distance,e=f.add(b.position,f.multiply(d,e)),o=this.inBounds(e),m++,m>30){e=b.position;
break}while(!o);return e},run:function(a){this.current_time=a;if(this.path_time===0)this.path_time=this.current_time,this.camPath.setKey(c.motion.POS,c.motion.X,this.path_time,this.start_position[0]),this.camPath.setKey(c.motion.POS,c.motion.Y,this.path_time,this.start_position[1]),this.camPath.setKey(c.motion.POS,c.motion.Z,this.path_time,this.start_position[2]);for(;this.path_time<this.current_time+this.buffer_time;){this.path_time+=this.segment_time;var b=new s,f=new s;this.path_length&&this.camPath.apply(this.path_time-
this.segment_time*2,b);this.camPath.apply(this.path_time-this.segment_time,f);b=this.findNextNode(b,f);this.camPath.setKey(c.motion.POS,c.motion.X,this.path_time,b[0]);this.camPath.setKey(c.motion.POS,c.motion.Y,this.path_time,b[1]);this.camPath.setKey(c.motion.POS,c.motion.Z,this.path_time,b[2]);this.path_length++}b=new s;this.camPath.apply(a,b);return b.position},addSafeBound:function(a,b){this.safe_bb.push([a,b])},addAvoidSphere:function(a,b){this.avoid_sphere.push([a,b])}};return{Camera:t,AutoCamera:n}});CubicVR.RegisterModule("CollisionMap",function(){CubicVR.enums.collision={shape:{BOX:0,SPHERE:1,CYLINDER:2,CONE:3,CAPSULE:4,MESH:5,HEIGHTFIELD:6,CONVEX_HULL:7}};var y=function(t){this.shapes=[];this.result=null;if(t){t&&!t.length&&(t=[t]);for(var s=0,n=t.length;s<n;s++)this.addShape(t[s])}};y.prototype={addShape:function(t){t.position=t.position||[0,0,0];t.rotation=t.rotation||[0,0,0];t.size=t.size||[1,1,1];t.radius=t.radius||1;t.height=t.height||1;t.margin=t.margin||0;t.mesh=t.mesh||null;this.shapes.push(t)},
getShapes:function(){return this.shapes},setResult:function(t){this.result=t},getResult:function(){return this.result}};return{CollisionMap:y}});CubicVR.RegisterModule("GML",function(y){function t(n){var g=CubicVR.util;this.strokes=[];this.bounds=[1,1,1];this.origin=[0,0,0];this.upvector=[0,1,0];this.viewvector=[0,0,1];this.manual_pos=0;if(n!==s){var n=g.getXML(n),c=n.getElementsByTagName("header");if(!c.length)return null;var q=c[0],c=n.getElementsByTagName("environment");if(!c.length)return null;this.name=null;q=q.getElementsByTagName("name");if(q.length)this.name=g.collectTextNode(q[0]);q=c[0].getElementsByTagName("screenBounds");if(q.length)this.bounds=
[parseFloat(g.collectTextNode(q[0].getElementsByTagName("x")[0])),parseFloat(g.collectTextNode(q[0].getElementsByTagName("y")[0])),parseFloat(g.collectTextNode(q[0].getElementsByTagName("z")[0]))];q=c[0].getElementsByTagName("origin");if(q.length)this.origin=[parseFloat(g.collectTextNode(q[0].getElementsByTagName("x")[0])),parseFloat(g.collectTextNode(q[0].getElementsByTagName("y")[0])),parseFloat(g.collectTextNode(q[0].getElementsByTagName("z")[0]))];c=c[0].getElementsByTagName("up");if(c.length)this.upvector=
[parseFloat(g.collectTextNode(c[0].getElementsByTagName("x")[0])),parseFloat(g.collectTextNode(c[0].getElementsByTagName("y")[0])),parseFloat(g.collectTextNode(c[0].getElementsByTagName("z")[0]))];n=n.getElementsByTagName("drawing");c=0;for(q=n.length;c<q;c++)for(var h=n[c].getElementsByTagName("stroke"),a=0,b=0,f=0,e=0,d=0,m=h.length;d<m;d++){for(var o=h[d].getElementsByTagName("pt"),r=o.length,A=Array(r),z,v,w,C=0,J=r;C<J;C++)w=o[C],r=parseFloat(g.collectTextNode(w.getElementsByTagName("x")[0])),
z=parseFloat(g.collectTextNode(w.getElementsByTagName("y")[0])),v=parseFloat(g.collectTextNode(w.getElementsByTagName("z")[0])),w=parseFloat(g.collectTextNode(w.getElementsByTagName("time")[0])),this.upvector[0]===1?A[C]=[z!==z?0:z,r!==r?0:-r,v!==v?0:v,w]:this.upvector[1]===1?A[C]=[r!==r?0:r,z!==z?0:z,v!==v?0:v,w]:this.upvector[2]===1&&(A[C]=[r!==r?0:r,v!==v?0:-v,z!==z?0:z,w]),a<r&&(a=r),b<z&&(b=z),f<v&&(f=v),e<w&&(e=w);if(f>e){o=0;for(C=A.length;o<C;o++)r=A[o][3],A[o][3]=A[o][2],A[o][2]=r/this.bounds[2]}this.strokes[d]=
A}}}var s=y.undef;t.prototype={addStroke:function(n,g){var c=[];g===s&&(g=0.1);for(var q=0,h=n.length;q<h;q++){var a=[n[q][0],n[q][1],n[q][2]];this.manual_pos+=g;a.push(this.manual_pos);c.push(a)}this.strokes.push(c)},recenter:function(){var n=CubicVR.vec3,g=[0,0,0],c=[this.strokes[0][0][0],this.strokes[0][0][1],this.strokes[0][0][2]],q,h,a,b;a=0;for(b=this.strokes.length;a<b;a++){q=0;for(h=this.strokes[a].length;q<h;q++)g[0]>this.strokes[a][q][0]&&(g[0]=this.strokes[a][q][0]),g[1]>this.strokes[a][q][1]&&
(g[1]=this.strokes[a][q][1]),g[2]>this.strokes[a][q][2]&&(g[2]=this.strokes[a][q][2]),c[0]<this.strokes[a][q][0]&&(c[0]=this.strokes[a][q][0]),c[1]<this.strokes[a][q][1]&&(c[1]=this.strokes[a][q][1]),c[2]<this.strokes[a][q][2]&&(c[2]=this.strokes[a][q][2])}n=n.multiply(n.subtract(c,g),0.5);a=0;for(b=this.strokes.length;a<b;a++){q=0;for(h=this.strokes[a].length;q<h;q++)this.strokes[a][q][0]-=n[0],this.strokes[a][q][1]-=this.upvector[1]?n[1]:-n[1],this.strokes[a][q][2]-=n[2]}},generateObject:function(n,
g,c,q,h){var a=CubicVR.vec3;n===s&&(n=0);g===s&&(g=0);h===s&&(h=!1);q===s&&(q=0.02);c===s&&(c=0.015);for(var b=g!==0,f=0,e=0,d=new CubicVR.Mesh(this.name),m,o,r,A,z,v,w=0,C=this.strokes.length;w<C;w++){v=new CubicVR.Envelope;var J=new CubicVR.Envelope,t=new CubicVR.Envelope,x=this.strokes[w].length,u=0,F=[],D=[],B=0,y=this.strokes[w];for(z=0;z<x;z++){var K=y[z],E=v.addKey(K[3],K[0]),G=J.addKey(K[3],K[1]),H;H=h?t.addKey(K[3],K[2]):t.addKey(K[3],0);E.tension=0.5;G.tension=0.5;H.tension=0.5;z!==0?(m=
K[0]-m,o=K[1]-o,r=K[2]-r,A=K[3]-A,r=Math.sqrt(m*m+o*o+r*r),u+=r,F[z-1]=r,D[z-1]=A):B=K[3];m=K[0];o=K[1];r=K[2];A=K[3]}u=B;x=d.points.length;for(z=0;z<F.length;z++){B=D[z];y=u;K=u+B;for(E=B/Math.ceil(F[z]/q*3);y<K-E;y+=E){y===u&&(m=v.evaluate(y),o=J.evaluate(y),r=t.evaluate(y));var N,G=v.evaluate(y+E);H=J.evaluate(y+E);N=t.evaluate(y+E);var I;I=a.multiply(a.normalize(a.cross(this.viewvector,a.normalize([G-m,H-o,N-r]))),c/2);d.addPoint([m-I[0],-(o-I[1]),r-I[2]+(b?g/2:0)]);d.addPoint([m+I[0],-(o+I[1]),
r+I[2]+(b?g/2:0)]);m=G;o=H;r=N}u+=B}J=d.points.length;if(b){z=x;for(v=J;z<v;z++)d.addPoint([d.points[z][0],d.points[z][1],d.points[z][2]-(b?g/2:0)])}z=0;for(v=J-x;z<=v-4;z+=2)f%n===0&&e++,d.setSegment(e),t=[x+z,x+z+1,x+z+3,x+z+2],d.addFace(t),b&&(t=[t[3]+J-x,t[2]+J-x,t[1]+J-x,t[0]+J-x],d.addFace(t),t=[x+z,x+z+2,x+z+2+J-x,x+z+J-x],d.addFace(t),t=[x+z+1+J-x,x+z+3+J-x,x+z+3,x+z+1],d.addFace(t),z===0&&(t=[x+z+J-x,x+z+1+J-x,x+z+1,x+z],d.addFace(t)),z===v-4&&(t=[x+z+2,x+z+3,x+z+3+J-x,x+z+2+J-x],d.addFace(t))),
f++}d.calcFaceNormals();d.triangulateQuads();d.calcNormals();d.compile();return d}};return{GML:t}});CubicVR.RegisterModule("Landscape",function(y){function t(c,q,h,a){this.doTransform=function(){};this.tMatrix=n;this.parent=null;this.position=[0,0,0];this.scale=[1,1,1];this.size=c;this.divisions_w=q;this.divisions_h=h;this.matRef=a;this.children=null;this.obj=new CubicVR.Mesh;this.divisions_w>this.divisions_h?(this.size_w=c,this.size_h=c/this.divisions_w*this.divisions_h):(this.size_w=this.divisions_h>this.divisions_w?c/this.divisions_h*this.divisions_w:c,this.size_h=c);for(q=-(this.size_h/2);q<
this.size_h/2;q+=this.size_h/this.divisions_h)for(c=-(this.size_w/2);c<this.size_w/2;c+=this.size_w/this.divisions_w)this.obj.addPoint([c+this.size_w/this.divisions_w/2,0,q+this.size_h/this.divisions_h/2]);this.obj.setFaceMaterial(this.matRef);for(q=0;q<this.divisions_h-1;q++)for(c=0;c<this.divisions_w-1;c++)this.obj.addFace([c+(q+1)*this.divisions_w,c+1+q*this.divisions_w,c+q*this.divisions_w]),this.obj.addFace([c+(q+1)*this.divisions_w,c+1+(q+1)*this.divisions_w,c+1+q*this.divisions_w])}var s=y.undef,
n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],g=Math.PI/2;t.prototype={getMesh:function(){return this.obj},setIndexedHeight:function(c,q,h){obj.points[c+q*this.divisions_w][1]=h},mapGen:function(c,q,h,a,b){if(q!==s&&h!==s&&a!==s&&b!==s){if(!(q>=this.divisions_w)&&!(h>=this.divisions_h)&&(q+a>=this.divisions_w&&(a=this.divisions_w-1-q),h+b>=this.divisions_h&&(b=this.divisions_h-1-h),!(a<=0||b<=0)))for(var f=q,a=q+a;f<a;f++)for(var e=h,d=h+b;e<d;e++)q=this.obj.points[f+e*this.divisions_w],q[1]=c(q[0],q[2])}else{h=
0;for(b=this.obj.points.length;h<b;h++)q=this.obj.points[h],q[1]=c(q[0],q[2])}},getFaceAt:function(c,q){if(typeof c==="object")return this.getFaceAt(c[0],c[2]);var h=this.size_h/2-this.size_h/this.divisions_h/2,a=parseInt(Math.floor((c+(this.size_w/2-this.size_w/this.divisions_w/2))/this.size_w*this.divisions_w),10),h=parseInt(Math.floor((q+h)/this.size_h*this.divisions_h),10);if(a<0)return-1;if(a>=this.divisions_w-1)return-1;if(h<0)return-1;if(h>=this.divisions_h-1)return-1;var a=parseInt(a+h*(this.divisions_w-
1),10)*2,h=parseInt(a+1,10),b=this.obj.points[this.obj.faces[a].points[0]];return Math.abs(q-b[2])/Math.abs(c-b[0])>=1?a:h},getHeightValue:function(c,q){var h=CubicVR.triangle;if(typeof c==="object")return this.getHeightValue(c[0],c[2]);var a,b=this.getFaceAt(c,q);if(b===-1)return 0;a=this.obj.points[this.obj.faces[b].points[0]];var f=h.normal(this.obj.points[this.obj.faces[b].points[0]],this.obj.points[this.obj.faces[b].points[1]],this.obj.points[this.obj.faces[b].points[2]]),h=f[0],b=f[1],f=f[2];
return(h*c+f*q+(-(h*a[0])-b*a[1]-f*a[2]))/-b},orient:function(c,q,h,a,b,f){f===s&&(f=0);var e,d,m=[];e=h/2;var o=a/2;d=Math.sqrt(o*o+e*e);o=Math.atan2(o,e);b*=Math.PI/180;e=c+Math.sin(b)*f;f=q+Math.cos(b)*f;m[0]=this.getHeightValue([e+d*Math.cos(-o-g+b),0,f+d*-Math.sin(-o-g+b)]);m[1]=this.getHeightValue([e+d*Math.cos(o-g+b),0,f+d*-Math.sin(o-g+b)]);m[2]=this.getHeightValue([e+d*Math.cos(-o+g+b),0,f+d*-Math.sin(-o+g+b)]);m[3]=this.getHeightValue([e+d*Math.cos(o+g+b),0,f+d*-Math.sin(o+g+b)]);d=-Math.atan2(m[1]-
m[2],h);f=-Math.atan2(m[0]-m[1],a);d+=-Math.atan2(m[0]-m[3],h);f+=-Math.atan2(m[3]-m[2],a);d/=2;f/=2;return[[c,(m[2]+m[3]+m[1]+m[0])/4,q],[d*(180/Math.PI),b,f*(180/Math.PI)]]}};return{Landscape:t}});CubicVR.RegisterModule("Layout",function(){function y(s){this.texture=s.texture?s.texture:null;this.width=s.width?s.width:128;this.height=s.height?s.height:128;this.x=s.x?s.x:0;this.y=s.y?s.y:0;this.blend=s.blend?s.blend:!1;this.opacity=typeof s.opacity!=="undefined"?s.opacity:1;this.tint=s.tint?s.tint:[1,1,1];this.type="view";this.superView=null;this.childViews=[];this.panel=null}function t(s){this.texture=s.texture?s.texture:null;this.width=s.width?s.width:128;this.height=s.height?s.height:128;
this.x=s.x?s.x:0;this.y=s.y?s.y:0;this.blend=s.blend?s.blend:!1;this.opacity=typeof s.opacity!=="undefined"?s.opacity:1;this.tint=s.tint?s.tint:[1,1,1];this.type="root";this.superView=null;this.childViews=[];this.setupShader();this.panel=null;this.makePanel(this)}y.prototype={addSubview:function(s){this.childViews.push(s);s.superView=this},makePanel:function(s){return this.superView.makePanel(s)}};t.prototype={resize:function(s,n){this.width=s;this.height=n},setupShader:function(){this.shader=new CubicVR.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nuniform vec3 screen;\nuniform vec3 position;\nuniform vec3 size;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\nvPos.x *= size.x/screen.x;\nvPos.y *= size.y/screen.y;\nvPos.x += (size.x/screen.x);\nvPos.y -= (size.y/screen.y);\nvPos.x += (position.x/screen.x)*2.0 - 1.0;\nvPos.y -= (position.y/screen.y)*2.0 - 1.0;\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 tint;\nvarying vec2 vTex;\nvoid main(void) {\nvec4 color = texture2D(srcTex, vTex)*vec4(tint,1.0);\ngl_FragColor = color;\n}",init:function(s){s.setInt("srcTex",0);s.addVector("screen");s.addVector("position");s.addVector("tint");s.addVector("size")}})},addSubview:function(s){this.childViews.push(s);s.superView=this},removeSubview:function(s){s=this.childViews.indexOf(s);s>-1&&this.childViews.splice(s,
1)},makePanel:function(s){var n=CubicVR.GLCore.gl,g={};g.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);g.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);g.gl_points=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,g.gl_points);n.bufferData(n.ARRAY_BUFFER,g.vbo_points,n.STATIC_DRAW);g.gl_uvs=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,g.gl_uvs);n.bufferData(n.ARRAY_BUFFER,g.vbo_uvs,n.STATIC_DRAW);s.panel=g},renderPanel:function(s){if(!s.texture)return!1;s.texture.use(CubicVR.GLCore.gl.TEXTURE0)},
renderView:function(s){if(s.texture){var n=CubicVR.GLCore.gl,g=s.offsetLeft,c=s.offsetTop;g||(g=0);c||(c=0);var q=this.shader.shader;q.use();q.setVector("screen",[this.width,this.height,0]);q.setVector("position",[s.x+g,s.y+c,0]);q.setVector("size",[s.width,s.height,0]);q.setVector("tint",s.tint);s.blend&&(n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA));s.texture.use(n.TEXTURE0);n.drawArrays(n.TRIANGLES,0,6);s.blend&&(n.disable(n.BLEND),n.blendFunc(n.ONE,n.ZERO))}},render:function(){var s=
CubicVR.GLCore.gl;s.disable(s.DEPTH_TEST);this.texture&&this.renderView(this);var n=[];this.offsetTop=this.offsetLeft=0;n.push(this);var g=this.shader.shader;g.use();s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null);s.bindBuffer(s.ARRAY_BUFFER,this.panel.gl_points);s.vertexAttribPointer(g.uniforms.aVertex,3,s.FLOAT,!1,0,0);s.enableVertexAttribArray(g.uniforms.aVertex);s.bindBuffer(s.ARRAY_BUFFER,this.panel.gl_uvs);s.vertexAttribPointer(g.uniforms.aTex,2,s.FLOAT,!1,0,0);s.enableVertexAttribArray(g.uniforms.aTex);
for(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null);n.length;){var c=n.pop();this.renderView(c);if(c.childViews.length)for(var q=c.childViews.length-1;q>=0;q--)c.childViews[q].offsetLeft=c.x+c.offsetLeft,c.childViews[q].offsetTop=c.y+c.offsetTop,n.push(c.childViews[q])}s.disableVertexAttribArray(g.uniforms.aTex);s.enable(s.DEPTH_TEST)}};return{Layout:t,View:y}});CubicVR.RegisterModule("Light",function(y){function t(c,h){var a=CubicVR.aabb;if(c===g)c=n.light.type.POINT;if(h===g)h=n.light.method.DYNAMIC;typeof c=="object"?(this.light_type=c.type!==g?c.type:n.light.type.POINT,this.diffuse=c.diffuse!==g?c.diffuse:[1,1,1],this.specular=c.specular!==g?c.specular:[1,1,1],this.intensity=c.intensity!==g?c.intensity:1,this.position=c.position!==g?c.position:[0,0,0],this.direction=c.direction!==g?c.direction:[0,0,0],this.distance=c.distance!==g?c.distance:this.light_type===
n.light.type.AREA?30:10,this.cutoff=c.cutoff!==g?c.cutoff:60,this.map_res=c.map_res!==g?c.map_res:this.light_type===n.light.type.AREA?2048:512,this.map_res=c.mapRes!==g?c.mapRes:this.map_res,this.method=c.method!==g?c.method:h,this.areaCam=c.areaCam!==g?c.areaCam:null,this.areaCeiling=c.areaCeiling!==g?c.areaCeiling:40,this.areaFloor=c.areaFloor!==g?c.areaFloor:-40,this.areaAxis=c.areaAxis!==g?c.areaAxis:[1,1,0],this.projectorTex=c.projector!==g?c.projector:null):(this.light_type=c,this.diffuse=[1,
1,1],this.specular=[1,1,1],this.intensity=1,this.position=[0,0,0],this.direction=[0,0,0],this.distance=this.light_type===n.light.type.AREA?30:10,this.cutoff=60,this.map_res=this.light_type===n.light.type.AREA?2048:512,this.method=h,this.areaCam=null,this.areaCeiling=40,this.areaFloor=-40,this.areaAxis=[1,1,0],this.projectorTex=null);this.setType(this.light_type);this.lposition=[0,0,0];this.dirty=!0;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];this.ignore_octree=
!1;this.was_culled=this.culled=this.visible=!0;this.aabb=[[0,0,0],[0,0,0]];a.reset(this.aabb,this.position);this.adjust_octree=CubicVR.SceneObject.prototype.adjust_octree;this.motion=null;this.rotation=[0,0,0];(this.light_type===n.light.type.SPOT_SHADOW||this.light_type===n.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===n.light.type.AREA&&y.features.lightShadows)&&this.setShadow(this.map_res);this.lDir=[0,0,0];this.lPos=[0,0,0];this.parent=null}var s=y.GLCore,n=CubicVR.enums,g=y.undef,c=[1,0,
0,0,0,1,0,0,0,0,1,0,0,0,0,1];n.light={type:{NULL:0,POINT:1,DIRECTIONAL:2,SPOT:3,AREA:4,DEPTH_PACK:5,SPOT_SHADOW:6,SPOT_SHADOW_PROJECTOR:7,MAX:8},method:{GLOBAL:0,STATIC:1,DYNAMIC:2}};t.prototype={setType:function(c){if(c===n.light.type.AREA&&!y.features.lightShadows)this.dummyCam=new CubicVR.Camera,this.areaCam=new CubicVR.Camera,this.updateAreaLight(),this.areaCam=this.dummyCam=null,c=n.light.type.DIRECTIONAL;else if((c===n.light.type.SPOT_SHADOW||c===n.light.type.SPOT_SHADOW_PROJECTOR)&&!y.features.lightShadows)c=
n.light.type.SPOT;this.light_type=c},setParent:function(c){this.parent=c},setMethod:function(c){this.method=c},setDiffuse:function(c){this.diffuse=c},setSpecular:function(c){this.specular=c},setIntensity:function(c){this.intensity=c},setPosition:function(c){this.position=c},setDistance:function(c){this.distance=c},setCutoff:function(c){this.cutoff=c},prepare:function(c){var h=CubicVR.mat4,a=CubicVR.mat3,b=this.light_type;if(this.parent)if(b===n.light.type.SPOT||b===n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR)b=
h.inverse_mat3(this.parent.tMatrix),a.transpose_inline(b),this.lDir=a.vec3_multiply(this.direction,b),this.lDir=a.vec3_multiply(this.lDir,c.nMatrix),this.lPos=h.vec3_multiply(this.position,h.multiply(c.mvMatrix,this.parent.tMatrix));else{if(b===n.light.type.POINT)this.lPos=h.vec3_multiply(this.position,h.multiply(c.mvMatrix,this.parent.tMatrix))}else if(b===n.light.type.DIRECTIONAL)this.lDir=a.vec3_multiply(this.direction,c.nMatrix);else if(b===n.light.type.SPOT||b===n.light.type.SPOT_SHADOW||b===
n.light.type.SPOT_SHADOW_PROJECTOR)this.lDir=a.vec3_multiply(this.direction,c.nMatrix),this.lPos=h.vec3_multiply(this.position,c.mvMatrix);else if(b===n.light.type.POINT)this.lPos=h.vec3_multiply(this.position,c.mvMatrix);else if(b===n.light.type.AREA)this.lDir=a.vec3_multiply(this.direction,c.nMatrix)},control:function(c,h,a){if(c===n.motion.POS)this.position[h]=a;else if(c===n.motion.INTENSITY)this.intensity=a},getAABB:function(){var c=CubicVR.vec3,h=CubicVR.aabb,a=[[0,0,0],[0,0,0]];h.engulf(a,
[this.distance,this.distance,this.distance]);h.engulf(a,[-this.distance,-this.distance,-this.distance]);a[0]=c.add(a[0],this.position);a[1]=c.add(a[1],this.position);return this.aabb=a},setDirection:function(c,h,a){var b=CubicVR.vec3;if(typeof c==="object")this.setDirection(c[0],c[1],c[2]);else return this.direction=b.normalize([c,h,a]),this},lookat:function(c,h,a){var b=CubicVR.vec3;if(typeof c==="object")this.lookat(c[0],c[1],c[2]);else return this.direction=b.normalize(b.subtract([c,h,a],this.position)),
this},setRotation:function(c,h,a){var b=CubicVR.mat4,f=CubicVR.vec3;if(typeof c==="object")this.setRotation(c[0],c[1],c[2]);else{var e=new CubicVR.Transform;e.rotate([-c,-h,-a]);e.pushMatrix();this.direction=f.normalize(b.vec3_multiply([1,0,0],e.getResult()));this.rotation=[c,h,a];return this}},setupShader:function(c,h){var a=s.gl;a.uniform3fv(c.lDiff[h],this.diffuse);a.uniform3fv(c.lSpec[h],this.specular);this.lPos&&a.uniform3fv(c.lPos[h],this.lPos);this.lDir&&a.uniform3fv(c.lDir[h],this.lDir);a.uniform1f(c.lInt[h],
this.intensity);a.uniform1f(c.lDist[h],this.distance);(this.light_type===n.light.type.SPOT_SHADOW||this.light_type===n.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===n.light.type.SPOT)&&a.uniform1f(c.lCut[h],this.cutoff);if(this.light_type===n.light.type.SPOT_SHADOW||this.light_type===n.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===n.light.type.AREA)this.light_type===n.light.type.SPOT_SHADOW_PROJECTOR?(this.shadowMapTex.texture.use(s.gl.TEXTURE0+h*2),a.uniform1i(c.lDepthTex[h],h*2),this.projectorTex.use(s.gl.TEXTURE0+
h*2+1),a.uniform1i(c.lProjTex[h],h*2+1)):(this.shadowMapTex.texture.use(s.gl.TEXTURE0+h),a.uniform1i(c.lDepthTex[h],h)),a.uniform3fv(c.lDepth[h],[this.dummyCam.nearclip,this.dummyCam.farclip,1/this.map_res]),a.uniformMatrix4fv(c.spMatrix[h],!1,this.spMatrix)},setShadow:function(c){if(y.features.lightShadows)this.map_res=c,this.shadowMapTex=new CubicVR.RenderBuffer(this.map_res,this.map_res,!0),this.shadowMapTex.texture.setFilter(n.texture.filter.NEAREST),this.dummyCam=new CubicVR.Camera(this.map_res,
this.map_res,80,0.1,this.distance),this.dummyCam.calc_nmatrix=!1,this.dummyCam.setTargeted(!0),this.has_shadow=!0},hasShadow:function(){return has_shadow},setProjector:function(c){this.projectorTex=c},hasProjector:function(){return this.projectorTex!==null?!0:!1},shadowBegin:function(){var c=s.gl,h=CubicVR.mat4,a=CubicVR.mat3;this.shadowMapTex.use();c.viewport(0,0,this.map_res,this.map_res);c.clear(c.DEPTH_BUFFER_BIT|c.COLOR_BUFFER_BIT);this.light_type!==n.light.type.AREA?(this.dummyCam.setClip(0.1,
this.distance),this.dummyCam.setFOV(this.cutoff)):this.dummyCam.calcProjection();if(this.parent){var b=h.inverse_mat3(this.parent.tMatrix);a.transpose_inline(b);a.vec3_multiply(this.direction,b);h.vec3_multiply(this.position,this.parent.tMatrix);this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+this.direction[0]*10,this.position[1]+this.direction[1]*10,this.position[2]+this.direction[2]*10,0,1,0);h.multiply(this.dummyCam.mvMatrix.slice(0),h.inverse(this.parent.tMatrix),
this.dummyCam.mvMatrix)}else this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+this.direction[0]*10,this.position[1]+this.direction[1]*10,this.position[2]+this.direction[2]*10,0,1,0);c.cullFace(c.FRONT)},shadowEnd:function(){var c=s.gl;c.bindFramebuffer(c.FRAMEBUFFER,null);c.cullFace(c.BACK);this.setupTexGen()},setupTexGen:function(){var q=CubicVR.mat4;this.spMatrix=q.multiply(c,[0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1]);this.spMatrix=q.multiply(this.spMatrix,
this.dummyCam.pMatrix);this.spMatrix=q.multiply(this.spMatrix,this.dummyCam.mvMatrix)},setAreaAxis:function(c){this.areaAxis=c},updateAreaLight:function(){var c=CubicVR.vec3,h=this.areaCeiling-this.areaFloor;this.dummyCam.ortho=!0;this.dummyCam.setClip(0.01,1);var a=0,a=Math.tan(this.areaCam.fov/2*(Math.PI/180)),b=c.subtract(this.areaCam.target,this.areaCam.position);b[1]=0;b=c.normalize(b);c.normalize(c.cross(b,[0,1,0]));var f=-Math.atan2(b[2],b[0]),a=this.distance/2*Math.abs(a)-this.distance/2;
a<this.distance/3/2&&(a=this.distance/3/2);b=c.multiply(b,a);a=[Math.tan(this.areaAxis[1]*(Math.PI/180)),0,Math.tan(this.areaAxis[0]*(Math.PI/180))];f-=Math.atan2(a[0],a[2]);this.position=c.add(c.add(this.areaCam.position,b),c.multiply(a,h));this.position[1]=this.areaCeiling;this.target=c.add(c.add(this.areaCam.position,b),c.multiply(a,-h));this.target[1]=this.areaFloor;this.direction=c.normalize(c.subtract(this.target,this.position));this.dummyCam.rotation[2]=f*(180/Math.PI);c=this.dummyCam.nearclip;
h=this.dummyCam.farclip*Math.abs(this.direction[1])*h;c=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.nearclip);c=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.farclip);c[1][1]>this.areaFloor&&(c=c[1][1]-this.areaFloor,h+=c/Math.abs(this.direction[1]));this.dummyCam.nearclip=0.01;this.dummyCam.farclip=h;this.dummyCam.setOrtho(-this.distance/2,this.distance/
2,-this.distance/2,this.distance/2)},orthoBounds:function(c,h,a,b,f,e){var b=CubicVR.vec3,d=b.normalize([f[0],f[4],f[8]]),m=b.normalize([f[1],f[5],f[9]]),f=b.normalize(b.cross(m,d)),o;o=a/2;a=[];h=b.multiply(d,h/2);d=b.multiply(m,o);e=b.multiply(f,e);a[0]=b.add(b.subtract(c,h),b.add(d,e));a[1]=b.add(b.add(c,h),b.add(d,e));a[2]=b.subtract(b.subtract(c,h),b.add(d,e));a[3]=b.subtract(b.add(c,h),b.add(d,e));aabb1=a[0];aabb2=a[0];for(c=1;c<4;c++)aabb1[0]>a[c][0]&&(aabb1[0]=a[c][0]),aabb1[1]>a[c][1]&&(aabb1[1]=
a[c][1]),aabb1[2]>a[c][2]&&(aabb1[2]=a[c][2]),aabb2[0]<a[c][0]&&(aabb2[0]=a[c][0]),aabb2[1]<a[c][1]&&(aabb2[1]=a[c][1]),aabb2[2]<a[c][2]&&(aabb2[2]=a[c][2]);return[aabb1,aabb2]}};return{Light:t}});CubicVR.RegisterModule("MainLoop",function(y){function t(){this.paused_state=this.offset=this.paused_time=this.last_update=this.end_time=this.start_time=this.system_milliseconds=this.time_elapsed=0}function s(){CubicVR.GLCore.mainloop!==null&&(window.requestAnimationFrame&&window.requestAnimationFrame(s),CubicVR.GLCore.mainloop.interval())}function n(a,b,f){if(window.requestAnimationFrame===c)window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||
window.msRequestAnimationFrame||null;if(CubicVR.GLCore.mainloop!==null)!window.requestAnimationFrame&&CubicVR.GLCore.mainloop&&clearInterval(CubicVR.GLCore.mainloop.interval),CubicVR.GLCore.mainloop=null;if(a===null)CubicVR.GLCore.mainloop=null;else{this.renderList=[];var e=this.renderStack=[{scenes:[],update:function(){},start:function(){},stop:function(){}}],d=new t;d.start();this.timer=d;this.func=a;this.doclear=b!==c?b:!0;CubicVR.GLCore.mainloop=this;if(h.resizeList.length&&!CubicVR.GLCore.resize_active)window.addEventListener("resize",
function(){CubicVR.GLCore.onResize()},!1),CubicVR.GLCore.resize_active=!0;b=function(){return function(){var b=CubicVR.GLCore.gl;d.update();CubicVR.GLCore.mainloop.doclear&&b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT);a(d,CubicVR.GLCore.gl);var f=e[e.length-1],c=f.scenes;f.update&&f.update(d,b);if(c){b=0;for(f=c.length;b<f;++b){var h=c[b];h.paused||(h.update&&h.update(d,CubicVR.GLCore.gl),h.render())}}}}();f?this.loopFunc=b:window.requestAnimationFrame?(this.interval=b,window.requestAnimationFrame(s)):
this.interval=setInterval(b,20)}}function g(a,b,f){this.canvas=a;this.camera=b;this.mpos=[0,0];this.mdown=!1;var e=this;this.mEvents={};this.keyState=[];for(var d in q.keyboard)this.keyState[d]=!1;this.onMouseDown=function(){return function(a){e.mdown=!0;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];e.mEvents.mouseDown&&e.mEvents.mouseDown(e,e.mpos,e.keyState)}}();this.onMouseUp=function(){return function(a){e.mdown=!1;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];
e.mEvents.mouseUp&&e.mEvents.mouseUp(e,e.mpos,e.keyState)}}();this.onMouseMove=function(){return function(a){var d=[],a=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];d[0]=a[0]-e.mpos[0];d[1]=a[1]-e.mpos[1];e.mpos=a;e.mEvents.mouseMove&&e.mEvents.mouseMove(e,e.mpos,d,e.keyState)}}();this.onMouseWheel=function(){return function(a){a=a.wheelDelta?a.wheelDelta:-a.detail*100;e.mEvents.mouseWheel&&e.mEvents.mouseWheel(e,e.mpos,a,e.keyState)}}();this.onKeyDown=function(){return function(a){var a=
a.keyCode,d=null;e.mEvents.keyPress?(d=e.mEvents.keyPress(e,e.mpos,a,e.keyState),e.keyState[a]=d!==c?!!d:!0):e.keyState[a]=!0;e.keyState[a]&&e.mEvents.keyDown&&(d=e.mEvents.keyDown(e,e.mpos,a,e.keyState),e.keyState[a]=d!==c?!!d:!0)}}();this.onKeyUp=function(){return function(a){a=a.keyCode;e.mEvents.keyUp&&e.mEvents.keyUp(e,e.mpos,a,e.keyState);e.keyState[a]=!1}}();this.eventDefaults={mouseMove:function(a,d,b){a.mdown&&a.orbitView(b)},mouseWheel:function(a,d,b){a.zoomView(b)},mouseDown:null,mouseUp:null,
keyDown:null,keyUp:null,keyPress:null};f!==!1&&this.setEvents(f===c?this.eventDefaults:f);this.bind()}var c=y.undef,q=CubicVR.enums,h=y.GLCore;q.keyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESCAPE:27,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,
KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,LEFT_META:91,RIGHT_META:92,SELECT:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,
SEMICOLON:186,EQUALS:187,COMMA:188,DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};t.prototype={start:function(){this.update();this.num_updates=0;this.last_update=this.start_time=this.system_milliseconds;this.lock_state=this.paused_state=!1;this.offset=this.paused_time=this.lock_rate=0},stop:function(){this.end_time=this.system_milliseconds},reset:function(){this.start()},lockFramerate:function(){this.lock_rate=1/this.f_rate;
this.lock_state=!0},unlock:function(){var a=this.system_milliseconds;this.lock_state=!1;this.update();this.last_update=this.system_milliseconds-this.lock_rate;this.offset+=a-this.system_milliseconds;this.lock_rate=0},locked:function(){return this.lock_state},update:function(){this.num_updates++;this.last_update=this.system_milliseconds;this.lock_state?this.system_milliseconds+=lock_rate*1E3|0:this.system_milliseconds=Date.now();this.paused_state&&(this.paused_time+=this.system_milliseconds-this.last_update);
this.time_elapsed=this.system_milliseconds-this.start_time-this.paused_time+this.offset},getMilliseconds:function(){return this.time_elapsed},getSeconds:function(){return this.getMilliseconds()/1E3},setMilliseconds:function(a){this.offset-=this.system_milliseconds-this.start_time-this.paused_time+this.offset-a},setSeconds:function(a){this.setMilliseconds(a*1E3|0)},getLastUpdateSeconds:function(){return this.getLastUpdateMilliseconds()/1E3},getLastUpdateMilliseconds:function(){return this.system_milliseconds-
this.last_update},getTotalMilliseconds:function(){return this.system_milliseconds-this.start_time},getTotalSeconds:function(){return this.getTotalMilliseconds()/1E3},getNumUpdates:function(){return this.num_updates},setPaused:function(a){this.paused_state=a},getPaused:function(){return this.paused_state}};n.prototype={setPaused:function(a){this.timer.setPaused(a)},getPaused:function(){return this.timer.getPaused()},setTimerSeconds:function(a){this.timer.setSeconds(a)},getTimerSeconds:function(){return this.timer.getSeconds()},
resetTimer:function(){this.timer.reset()},addScene:function(a){this.renderStack[this.renderStack.length-1].scenes.push(a);return a},pushSceneGroup:function(a){a.scenes=a.scenes||[];this.renderStack.push(a);for(var b=0;b<a.scenes.length;++b)a.scenes[b].enable();a.start&&a.start()},popSceneGroup:function(){for(var a=this.renderStack[this.renderStack.length-1],b=0;b<a.scenes.length;++b)a.scenes[b].disable();this.renderStack.length>1&&this.renderStack.pop();a.stop&&a.stop()},getScene:function(a){for(var b=
renderStack[renderStack.length-1],f,e=0,d=b.scenes.length;e<d;++e)if(b.scenes[e].scene.name===a){f=b.scenes[e];break}return f},resumeScene:function(a){typeof a==="string"&&(a=this.getScene(a));a.enable();a.paused=!1},pauseScene:function(a){typeof a==="string"&&(a=this.getScene(a));a.paused=!0;a.disable()},removeScene:function(a){var b=renderStack[renderStack.length-1];typeof a==="string"&&(a=this.getScene(a));var f=b.scenes.indexOf(a);f>-1&&b.scenes.splice(f,1);return a},runOnce:function(){this.loopFunc()}};
g.prototype={isKeyPressed:function(a){return this.keyState[a]},setEvents:function(a){this.mEvents={};for(var b in a)this.bindEvent(b,a[b])},orbitView:function(a){var b=CubicVR.vec3,f=b.subtract(this.camera.target,this.camera.position),f=b.length(f);this.camera.position=b.moveViewRelative(this.camera.position,this.camera.target,-f*a[0]/300,0);this.camera.position[1]+=f*a[1]/300;this.camera.position=b.add(this.camera.target,b.multiply(b.normalize(b.subtract(this.camera.position,this.camera.target)),
f))},panView:function(a,b){var f=CubicVR.vec3;b||(b=!1);var e=f.subtract(this.camera.target,this.camera.position),e=f.length(e),d=this.camera.position;b?this.camera.position=f.moveViewRelative(this.camera.position,this.camera.target,-e*a[0]/300,-e*a[1]/300):(this.camera.position=f.moveViewRelative(this.camera.position,this.camera.target,-e*a[0]/300,0),this.camera.position[1]+=e*a[1]/300);e=f.subtract(this.camera.position,d);this.camera.target=f.add(this.camera.target,e)},zoomView:function(a,b,f){var e=
CubicVR.vec3,d=e.subtract(this.camera.target,this.camera.position),d=e.length(d);d-=a/1E3;b||(b=0.1);f||(f=1E3);d<b&&(d=b);d>f&&(d=f);this.camera.position=e.add(this.camera.target,e.multiply(e.normalize(e.subtract(this.camera.position,this.camera.target)),d))},bindEvent:function(a,b){this.mEvents[a]=b===c?this.eventDefaults[a]:b},unbindEvent:function(a){this.bindEvent(a,null)},bind:function(){this.canvas.addEventListener("mousemove",this.onMouseMove,!1);this.canvas.addEventListener("mousedown",this.onMouseDown,
!1);this.canvas.addEventListener("mouseup",this.onMouseUp,!1);this.canvas.addEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.addEventListener("keydown",this.onKeyDown,!1);window.addEventListener("keyup",this.onKeyUp,!1)},unbind:function(){this.canvas.removeEventListener("mousemove",this.onMouseMove,!1);this.canvas.removeEventListener("mousedown",this.onMouseDown,!1);this.canvas.removeEventListener("mouseup",this.onMouseUp,
!1);this.canvas.removeEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.removeEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.removeEventListener("keydown",this.onKeyDown,!1);window.removeEventListener("keyup",this.onKeyUp,!1)},setCamera:function(a){this.camera=a},getMousePosition:function(){return this.mpos}};return{Timer:t,MainLoop:n,MouseViewController:g,setMainLoop:function(a){CubicVR.GLCore.mainloop=a}}});CubicVR.RegisterModule("Texture",function(y){function t(a){var d=CubicVR.GLCore.gl;if(a.nodeName==="CANVAS"||a.nodeName==="IMG")this.canvasSource=a;else{this.canvasSource=document.createElement("CANVAS");if(a.width===void 0||a.height===void 0)throw Error("Width and height must be specified for generating a new CanvasTexture.");this.canvasSource.width=a.width;this.canvasSource.height=a.height;this.canvasContext=this.canvasSource.getContext("2d")}var b=this.canvasSource,f=b.width,b=b.height,c=!0;if(f===
1||b===1)c=!1;else{if(f!==1)for(;f%2===0;)f/=2;if(b!==1)for(;b%2===0;)b/=2;f>1&&(c=!1);b>1&&(c=!1)}this.updateFunction=a.update;this.texture=new CubicVR.Texture;this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;c?(this.setFilter(h.texture.filter.LINEAR_MIP),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.REPEAT),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.REPEAT)):(this.setFilter(h.texture.filter.LINEAR),
d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE));a.nodeName==="IMG"&&this.update()}function s(a,d,b){var f=CubicVR.GLCore.gl;this.texture=new CubicVR.Texture;this.canvas=document.createElement("CANVAS");this.canvas.width=d;this.canvas.height=b;this.pjs=new Processing(this.canvas,CubicVR.util.getURL(a));this.pjs.noLoop();this.pjs.redraw();a=this.canvas.width;d=this.canvas.height;b=!0;if(a===1||d===1)b=!1;else{if(a!==1)for(;a%
2===0;)a/=2;if(d!==1)for(;d%2===0;)d/=2;a>1&&(b=!1);d>1&&(b=!1)}this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;b?this.setFilter(h.texture.filter.LINEAR_MIP):(this.setFilter(h.texture.filter.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE))}function n(a,d,b){var f=q.gl;this.width=d;this.height=b;this.srcTex=
a;this.outTex=new CubicVR.RenderBuffer(d,b);var a=d,c=b;if(!(a===1||c===1)){if(a!==1)for(;a%2===0;)a/=2;if(c!==1)for(;c%2===0;)c/=2}a=[1/d,1/b,0];this.outputBuffer=new CubicVR.RenderBuffer(d,b,!1);this.fsQuad=CubicVR.fsQuad.make(d,b);shaderNMap=new CubicVR.Shader("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\n  vTex = aTex;\n  vec4 vPos = vec4(aVertex.xyz,1.0);\n  gl_Position = vPos;\n}","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main(void)\n{\n vec3 color;\n color.r = (texture2D(srcTex,vTex + vec2(texel.x,0)).r-texture2D(srcTex,vTex + vec2(-texel.x,0)).r)/2.0 + 0.5;\n color.g = (texture2D(srcTex,vTex + vec2(0,-texel.y)).r-texture2D(srcTex,vTex + vec2(0,texel.y)).r)/2.0 + 0.5;\n color.b = 1.0;\n gl_FragColor.rgb = color;\n gl_FragColor.a = 1.0;\n}");
shaderNMap.use();shaderNMap.addUVArray("aTex");shaderNMap.addVertexArray("aVertex");shaderNMap.addInt("srcTex",0);shaderNMap.addVector("texel");shaderNMap.setVector("texel",a);this.shaderNorm=shaderNMap;this.setFilter=this.outputBuffer.texture.setFilter;this.clear=this.outputBuffer.texture.clear;this.use=this.outputBuffer.texture.use;this.tex_id=this.outputBuffer.texture.tex_id;this.filterType=this.outputBuffer.texture.filterType;this.outTex.use(f.TEXTURE0);this.setFilter(h.texture.filter.LINEAR);
f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.REPEAT);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.REPEAT)}function g(a,d,b){var f=q.gl;this.width=a;this.height=d;this.outTex=new CubicVR.RenderBuffer(a,d,b);this.texture=this.outTex.texture;var c=a,A=d,z=!0;if(c===1||A===1)z=!1;else{if(c!==1)for(;c%2===0;)c/=2;if(A!==1)for(;A%2===0;)A/=2;c>1&&(z=!1);A>1&&(z=!1)}this.setFilter=this.outTex.texture.setFilter;this.clear=this.outTex.texture.clear;this.use=this.outTex.texture.use;this.tex_id=this.outTex.texture.tex_id;
this.filterType=this.outTex.texture.filterType;this.texture.use(f.TEXTURE0);z?(this.setFilter(h.texture.filter.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.REPEAT),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.REPEAT)):(this.setFilter(h.texture.filter.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE));this.dims=[a,d];this.depth=b?!0:!1}function c(a,d){this.scene=a;this.renderTex=new g(d?d.width:a.camera.width,
d?d.height:a.camera.height,!0);this.setFilter=this.renderTex.texture.setFilter;this.clear=this.renderTex.texture.clear;this.use=this.renderTex.texture.use;this.tex_id=this.renderTex.texture.tex_id;this.filterType=this.renderTex.texture.filterType}var q=y.GLCore,h=CubicVR.enums,a=y.undef;h.texture={map:{COLOR:0,ENVSPHERE:1,NORMAL:2,BUMP:3,REFLECT:4,SPECULAR:5,AMBIENT:6,ALPHA:7,MAX:8},filter:{LINEAR:0,LINEAR_MIP:1,NEAREST:2,NEAREST_MIP:3}};var b=function(a,d){this.img_path=a;this.filter_type=d};b.prototype=
{getTexture:function(a,d){return new f(this.img_path,this.filter_type,a,d)}};var f=function(b,d,m,f,c){var A=q.gl;this.tex_id=y.Textures.length;this.filterType=-1;this.onready=c;this.loaded=!1;y.Textures[this.tex_id]=A.createTexture();y.Textures_obj[this.tex_id]=this;if(b)typeof b==="string"?y.Images[this.tex_id]=new Image:typeof b==="object"&&b.nodeName==="IMG"&&(y.Images[this.tex_id]=b),y.Textures_ref[b]=this.tex_id;A.bindTexture(A.TEXTURE_2D,y.Textures[this.tex_id]);A.texParameteri(A.TEXTURE_2D,
A.TEXTURE_MAG_FILTER,A.LINEAR);A.texParameteri(A.TEXTURE_2D,A.TEXTURE_MIN_FILTER,A.LINEAR);if(b){var z=this.tex_id,v=d!==a?d:q.default_filter,w=this;y.Images[this.tex_id].onload=function(){A.bindTexture(A.TEXTURE_2D,y.Textures[z]);A.pixelStorei(A.UNPACK_FLIP_Y_WEBGL,!0);A.pixelStorei(A.UNPACK_COLORSPACE_CONVERSION_WEBGL,A.NONE);var a=y.Images[z];A.texImage2D(A.TEXTURE_2D,0,A.RGBA,A.RGBA,A.UNSIGNED_BYTE,a);var d=a.width,a=a.height,b=!0;if(d===1||a===1)b=!1;else{if(d!==1)for(;d%2===0;)d/=2;if(a!==1)for(;a%
2===0;)a/=2;d>1&&(b=!1);a>1&&(b=!1)}b||(A.texParameteri(A.TEXTURE_2D,A.TEXTURE_WRAP_S,A.CLAMP_TO_EDGE),A.texParameteri(A.TEXTURE_2D,A.TEXTURE_WRAP_T,A.CLAMP_TO_EDGE));if(y.Textures_obj[z].filterType===-1){if(!b&&v===h.texture.filter.LINEAR_MIP)v=h.texture.filter.LINEAR;y.Textures_obj[z].filterType===-1&&y.Textures_obj[z].setFilter(v)}else y.Textures_obj[z].setFilter(y.Textures_obj[z].filterType);A.bindTexture(A.TEXTURE_2D,null);if(w.onready)w.onready();w.loaded=!0};if(m)y.Images[this.tex_id].deferredSrc=
b,m.addImage(f,b,y.Images[this.tex_id]);else if(typeof b==="string")y.Images[this.tex_id].src=b}this.active_unit=-1};f.prototype={setFilter:function(a){var d=CubicVR.GLCore.gl;d.bindTexture(d.TEXTURE_2D,y.Textures[this.tex_id]);a===h.texture.filter.LINEAR?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR)):a===h.texture.filter.LINEAR_MIP?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,
d.LINEAR_MIPMAP_NEAREST),d.generateMipmap(d.TEXTURE_2D)):a===h.texture.filter.NEAREST?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST)):a===h.texture.filter.NEAREST_MIP&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST_MIPMAP_LINEAR),d.generateMipmap(d.TEXTURE_2D));this.filterType=a},use:function(a){q.gl.activeTexture(a);q.gl.bindTexture(q.gl.TEXTURE_2D,
y.Textures[this.tex_id]);this.active_unit=a},clear:function(){if(this.active_unit!==-1)q.gl.activeTexture(this.active_unit),q.gl.bindTexture(q.gl.TEXTURE_2D,null),this.active_unit=-1}};t.prototype={update:function(){this.updateFunction&&this.updateFunction(this.canvasSource,this.canvasContext);var a=CubicVR.GLCore.gl;a.bindTexture(a.TEXTURE_2D,y.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);this.filterType===
h.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};s.prototype={update:function(){var a=CubicVR.GLCore.gl;this.pjs.redraw();a.bindTexture(a.TEXTURE_2D,y.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas);this.filterType===h.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};n.prototype={update:function(){var a=q.gl,d=a.getParameter(a.VIEWPORT);
this.outputBuffer.use();a.viewport(0,0,this.width,this.height);a.clearColor(0,0,0,1);a.clear(a.COLOR_BUFFER_BIT);this.srcTex.use(a.TEXTURE0);CubicVR.fsQuad.render(this.shaderNorm,this.fsQuad);a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(d[0],d[1],d[2],d[3])}};g.prototype={begin:function(){var a=q.gl;this.dims=a.getParameter(a.VIEWPORT);this.outTex.use();a.viewport(0,0,this.width,this.height);this.depth?a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT):a.clear(a.COLOR_BUFFER_BIT)},end:function(){var a=
q.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(this.dims[0],this.dims[1],this.dims[2],this.dims[3])}};c.prototype={update:function(){this.renderTex.begin();this.scene.updateShadows();this.scene.render();this.renderTex.end()}};return{Texture:f,DeferredLoadTexture:b,CanvasTexture:t,TextTexture:function(b,d){var m=d&&d.color||"#fff",f=d&&d.bgcolor,c=d&&d.font||"18pt Arial",h=d&&d.align||"start",z=d&&d.y||0,v=d&&d.width||a,w=d&&d.height||a,g,q=document.createElement("CANVAS"),n=q.getContext("2d"),
s=0,s=typeof b==="string"?1:b.length;n.font=c;var u=d&&d.lineHeight||n.measureText("OO").width,F;if(s===1)F=n.measureText(b).width;else for(g=F=0;g<s;++g){var D=n.measureText(b[g]).width;D>F&&(F=D)}q.width=v||F;q.height=w||u*s;if(f)n.fillStyle=f,n.fillRect(0,0,q.width,q.height);n.fillStyle=m;n.font=c;n.textAlign=h;n.textBaseline="top";if(s===1)m=d&&d.x||h==="center"?q.width/2:h==="right"?q.width:0,n.fillText(b,m,z);else for(g=0;g<s;++g)m=d&&d.x||h==="center"?q.width/2:h==="right"?q.width:0,n.fillText(b[g],
m,z+g*u);n.fill();this.use=t.prototype.use;this.clear=t.prototype.clear;this.update=t.prototype.update;t.apply(this,[q]);this.update();this.canvasSource=null},PJSTexture:s,NormalMapGen:n,RenderTexture:g,SceneRenderTexture:c}});CubicVR.RegisterModule("Material",function(y){function t(c){this.initialized=!1;this.textures=[];this.shader=[];this.customShader=null;c=c||{};this.diffuse=c.diffuse||[1,1,1];this.specular=c.specular||[0.1,0.1,0.1];this.color=c.color||[1,1,1];this.ambient=c.ambient||[0,0,0];this.name=c.name||null;this.opacity=c.opacity===s?1:c.opacity;this.shininess=c.shininess===s?1:c.shininess;this.max_smooth=c.max_smooth===s?60:c.max_smooth;this.env_amount=c.env_amount===s?0.75:c.env_amount;this.morph=c.morph===
s?!1:c.morph;this.color_map=c.colorMap===s?!1:c.colorMap;this.uvOffset=c.uvOffset===s?null:c.uvOffset;c.textures&&(c.textures.color&&this.setTexture(c.textures.color,g.texture.map.COLOR),c.textures.envsphere&&this.setTexture(c.textures.envsphere,g.texture.map.ENVSPHERE),c.textures.normal&&this.setTexture(c.textures.normal,g.texture.map.NORMAL),c.textures.bump&&this.setTexture(c.textures.bump,g.texture.map.BUMP),c.textures.reflect&&this.setTexture(c.textures.reflect,g.texture.map.REFLECT),c.textures.specular&&
this.setTexture(c.textures.specular,g.texture.map.SPECULAR),c.textures.ambient&&this.setTexture(c.textures.ambient,g.texture.map.AMBIENT),c.textures.alpha&&this.setTexture(c.textures.alpha,g.texture.map.ALPHA))}var s=y.undef,n=y.GLCore,g=CubicVR.enums,c=[g.texture.map.REFLECT,g.texture.map.SPECULAR,g.texture.map.NORMAL,g.texture.map.BUMP],q=[];t.prototype={clone:function(){var c=new CubicVR.Material({diffuse:this.diffuse,specular:this.specular,color:this.color,ambient:this.ambient,opacity:this.opacity,
shininess:this.shininess,max_smooth:this.max_smooth,env_amount:this.env_amount,morph:this.morph,colorMap:this.color_map,name:this.name}),a;for(a in this.textures)c.setTexture(this.textures[a],a);return c},setTexture:function(h,a){a===s&&(a=0);if(y.features.texturePerPixel||c.indexOf(a)===-1)this.textures[a]=h},calcShaderMask:function(){var c=0;c+=typeof this.textures[g.texture.map.COLOR]==="object"?g.shader.map.COLOR:0;c+=typeof this.textures[g.texture.map.SPECULAR]==="object"?g.shader.map.SPECULAR:
0;c+=typeof this.textures[g.texture.map.NORMAL]==="object"?g.shader.map.NORMAL:0;c+=typeof this.textures[g.texture.map.BUMP]==="object"?g.shader.map.BUMP:0;c+=typeof this.textures[g.texture.map.REFLECT]==="object"?g.shader.map.REFLECT:0;c+=typeof this.textures[g.texture.map.ENVSPHERE]==="object"?g.shader.map.ENVSPHERE:0;c+=typeof this.textures[g.texture.map.AMBIENT]==="object"?g.shader.map.AMBIENT:0;c+=typeof this.textures[g.texture.map.ALPHA]==="object"?g.shader.map.ALPHA:0;c+=this.opacity!==1?g.shader.map.ALPHA:
0;c+=this.color_map?g.shader.map.COLORMAP:0;return c},getShaderHeader:function(c,a){return(a!==s?"#define loopCount "+a+"\n":"")+"#define hasColorMap "+(typeof this.textures[g.texture.map.COLOR]==="object"?1:0)+"\n#define hasSpecularMap "+(typeof this.textures[g.texture.map.SPECULAR]==="object"?1:0)+"\n#define hasNormalMap "+(typeof this.textures[g.texture.map.NORMAL]==="object"?1:0)+"\n#define hasBumpMap "+(typeof this.textures[g.texture.map.BUMP]==="object"?1:0)+"\n#define hasReflectMap "+(typeof this.textures[g.texture.map.REFLECT]===
"object"?1:0)+"\n#define hasEnvSphereMap "+(typeof this.textures[g.texture.map.ENVSPHERE]==="object"?1:0)+"\n#define hasAmbientMap "+(typeof this.textures[g.texture.map.AMBIENT]==="object"?1:0)+"\n#define hasAlphaMap "+(typeof this.textures[g.texture.map.ALPHA]==="object"?1:0)+"\n#define hasAlpha "+(this.opacity!==1?1:0)+"\n#define lightPoint "+(c===g.light.type.POINT?1:0)+"\n#define lightDirectional "+(c===g.light.type.DIRECTIONAL?1:0)+"\n#define lightSpot "+(c===g.light.type.SPOT||c===g.light.type.SPOT_SHADOW||
c===g.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define hasShadow "+(c===g.light.type.SPOT_SHADOW||c===g.light.type.SPOT_SHADOW_PROJECTOR||c===g.light.type.AREA?1:0)+"\n#define hasProjector "+(c===g.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define softShadow "+(n.soft_shadow?1:0)+"\n#define lightArea "+(c===g.light.type.AREA?1:0)+"\n#define depthPack "+(c===g.light.type.DEPTH_PACK?1:0)+"\n#define alphaDepth "+(n.depth_alpha?1:0)+"\n#define hasMorph "+(this.morph?1:0)+"\n#define hasVertexColorMap "+
(this.color_map?1:0)+"\n#define perPixel "+(y.features.lightPerPixel?1:0)+"\n\n"},bindObject:function(c,a){var b=n.gl,f=a.aVertexPosition,e=a.aTextureCoord,d=a.aNormal,m=a.aColor;b.bindBuffer(b.ARRAY_BUFFER,c.compiled.gl_points);b.vertexAttribPointer(f,3,b.FLOAT,!1,0,0);b.enableVertexAttribArray(f);e!==null&&c.compiled.gl_uvs!==null&&e!==-1&&(b.bindBuffer(b.ARRAY_BUFFER,c.compiled.gl_uvs),b.vertexAttribPointer(e,2,b.FLOAT,!1,0,0),b.enableVertexAttribArray(e));q.uv=e;d!==null&&c.compiled.gl_normals!==
null&&d!==-1&&(b.bindBuffer(b.ARRAY_BUFFER,c.compiled.gl_normals),b.vertexAttribPointer(d,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(d));q.un=d;m!==null&&c.compiled.gl_colors!==null&&m!==-1&&(b.bindBuffer(b.ARRAY_BUFFER,c.compiled.gl_colors),b.vertexAttribPointer(m,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(m));q.uc=m;if(c.morphTarget)f=a.amVertexPosition,d=a.amNormal,b.bindBuffer(b.ARRAY_BUFFER,c.morphTarget.gl_points),b.vertexAttribPointer(f,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(f),d!==
null&&c.morphTarget.gl_normals!==null&&d!==-1&&(b.bindBuffer(b.ARRAY_BUFFER,c.morphTarget.gl_normals),b.vertexAttribPointer(d,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(d)),b.uniform1f(a.morphWeight,c.morphWeight);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,c.compiled.gl_elements)},clearObject:function(c,a){var b=n.gl;q.uv!==s&&q.uv!==-1&&b.disableVertexAttribArray(q.uv);q.un!==s&&q.un!==-1&&b.disableVertexAttribArray(q.un);q.uc!==s&&q.uc!==-1&&b.disableVertexAttribArray(q.uc);if(c.morphTarget&&a)up=a.amVertexPosition,
b.disableVertexAttribArray(up),un=a.amNormal,un!==null&&c.compiled.gl_normals!==null&&un!==-1&&b.disableVertexAttribArray(un)},use:function(c,a){var b,f=n.gl,e=this.textures,a=a||0,c=c||0;if(this.customShader)this.customShader.use(c,a);else{this.shader[c]||(this.shader[c]=[]);var d=this.shader[c][a];if(d)d.use();else{b=this.calcShaderMask(c);y.ShaderPool[c][b]||(y.ShaderPool[c][b]=[]);d=y.ShaderPool[c][b][a];if(!d){d=this.getShaderHeader(c,a);d=new CubicVR.Shader(d+n.CoreShader_vs,d+n.CoreShader_fs);
y.ShaderPool[c][b][a]=d;b=0;if(c!==g.light.type.DEPTH_PACK){if(c===g.light.type.SPOT_SHADOW||c===g.light.type.SPOT_SHADOW_PROJECTOR||c===g.light.type.AREA)b+=a,c===g.light.type.SPOT_SHADOW_PROJECTOR&&(b+=a);typeof e[g.texture.map.COLOR]==="object"&&d.addInt("colorMap",b++);typeof e[g.texture.map.ENVSPHERE]==="object"&&d.addInt("envSphereMap",b++);typeof e[g.texture.map.NORMAL]==="object"&&d.addInt("normalMap",b++);typeof e[g.texture.map.BUMP]==="object"&&d.addInt("bumpMap",b++);typeof e[g.texture.map.REFLECT]===
"object"&&d.addInt("reflectMap",b++);typeof e[g.texture.map.SPECULAR]==="object"&&d.addInt("specularMap",b++);typeof e[g.texture.map.AMBIENT]==="object"&&d.addInt("ambientMap",b++)}typeof e[g.texture.map.ALPHA]==="object"&&d.addInt("alphaMap",b++);d.addMatrix("uMVMatrix");d.addMatrix("uPMatrix");d.addMatrix("uOMatrix");d.addMatrix("uNMatrix");d.addVertexArray("aVertexPosition");d.addVertexArray("aNormal");this.color_map&&d.addVertexArray("aColor");this.morph&&(d.addVertexArray("amVertexPosition"),
d.addVertexArray("amNormal"),d.addFloat("morphWeight",0));for(b=0;b<a;b++)if(d.addVector("lDiff["+b+"]"),d.addVector("lSpec["+b+"]"),d.addFloat("lInt["+b+"]"),d.addFloat("lDist["+b+"]"),d.addVector("lPos["+b+"]"),d.addVector("lDir["+b+"]"),(c===g.light.type.SPOT_SHADOW||c===g.light.type.SPOT_SHADOW_PROJECTOR||c===g.light.type.SPOT)&&d.addFloat("lCut["+b+"]"),c===g.light.type.SPOT_SHADOW||c===g.light.type.SPOT_SHADOW_PROJECTOR||c===g.light.type.AREA)d.addInt("lDepthTex["+b+"]"),c===g.light.type.SPOT_SHADOW_PROJECTOR&&
d.addInt("lProjTex["+b+"]"),d.addVector("lDepth["+b+"]"),d.addMatrix("spMatrix["+b+"]");c!==g.light.type.DEPTH_PACK&&(d.addVector("lAmb"),d.addVector("mDiff"),d.addVector("mColor"),d.addVector("mAmb"),d.addVector("mSpec"),d.addFloat("mShine"),d.addFloat("envAmount"));d.addFloat("mAlpha");(n.depth_alpha||c===g.light.type.DEPTH_PACK||c===g.light.type.SPOT_SHADOW||c===g.light.type.SPOT_SHADOW_PROJECTOR||c===g.light.type.AREA)&&d.addVector("depthInfo");d.addUVArray("aTextureCoord");d.addVector("uTexOffset")}this.shader[c][a]=
d;d.use();d.uTexOffset!=-1&&f.uniform2fv(d.uTexOffset,[0,0])}b=0;var m;if(c!==g.light.type.DEPTH_PACK){if(c===g.light.type.SPOT_SHADOW||c===g.light.type.SPOT_SHADOW_PROJECTOR||c===g.light.type.AREA)b+=a,c===g.light.type.SPOT_SHADOW_PROJECTOR&&(b+=a);if(m=e[g.texture.map.COLOR])m.use(n.gl.TEXTURE0+b),b++;if(m=e[g.texture.map.ENVSPHERE])m.use(n.gl.TEXTURE0+b),b++,f.uniform1f(d.envAmount,this.env_amount);if(m=e[g.texture.map.NORMAL])m.use(n.gl.TEXTURE0+b),b++;if(m=e[g.texture.map.BUMP])m.use(n.gl.TEXTURE0+
b),b++;if(m=e[g.texture.map.REFLECT])m.use(n.gl.TEXTURE0+b),b++;if(m=e[g.texture.map.SPECULAR])m.use(n.gl.TEXTURE0+b),b++;if(m=e[g.texture.map.AMBIENT])m.use(n.gl.TEXTURE0+b),b++}(m=e[g.texture.map.ALPHA])&&m.use(n.gl.TEXTURE0+b);c!==g.light.type.DEPTH_PACK?(f.uniform3fv(d.mColor,this.color),f.uniform3fv(d.mDiff,this.diffuse),f.uniform3fv(d.mAmb,this.ambient),f.uniform3fv(d.mSpec,this.specular),f.uniform1f(d.mShine,this.shininess*128),f.uniform3fv(d.lAmb,CubicVR.globalAmbient),this.opacity!==1&&f.uniform1f(d.mAlpha,
this.opacity),(n.depth_alpha||c===g.light.type.SPOT_SHADOW||c===g.light.type.SPOT_SHADOW_PROJECTOR||c===g.light.type.AREA)&&f.uniform3fv(d.depthInfo,[n.depth_alpha_near,n.depth_alpha_far,0])):f.uniform3fv(d.depthInfo,[n.shadow_near,n.shadow_far,0]);this.uvOffset&&f.uniform2fv(d.uTexOffset,this.uvOffset)}}};return{Material:t}});CubicVR.RegisterModule("Math",function(y){function t(a){return this.clearStack(a)}function s(){if(arguments.length===1)this.x=arguments[0][0],this.y=arguments[0][1],this.z=arguments[0][2],this.w=arguments[0][3];if(arguments.length===4)this.x=arguments[0],this.y=arguments[1],this.z=arguments[2],this.w=arguments[3]}var n=y.undef,g=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],c=Math.PI/2,q={length:function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},normalize:function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*
a[1]+a[2]*a[2]);if(b===0)return[0,0,0];return[a[0]/b,a[1]/b,a[2]/b]},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},angle:function(a,b){return Math.acos((a[0]*b[0]+a[1]*b[1]+a[2]*b[2])/(Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])*Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])))},cross:function(a,b){return[a[1]*b[2]-b[1]*a[2],a[2]*b[0]-b[2]*a[0],a[0]*b[1]-b[0]*a[1]]},multiply:function(a,b){return[a[0]*b,a[1]*b,a[2]*b]},add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},subtract:function(a,b){return[a[0]-
b[0],a[1]-b[1],a[2]-b[2]]},equal:function(a,b,f){f===n&&(f=1.0E-7);if(a===n&&b===n)return!0;if(a===n||b===n)return!1;return Math.abs(a[0]-b[0])<f&&Math.abs(a[1]-b[1])<f&&Math.abs(a[2]-b[2])<f},moveViewRelative:function(a,b,f,e,d){var m=Math.sqrt(f*f+e*e),b=Math.atan2(b[2]-a[2],b[0]-a[0])+Math.atan2(e,f)+c;if(typeof d==="object")return[d[0]+m*Math.cos(b),d[1],d[2]+m*Math.sin(b)];return[a[0]+m*Math.cos(b),a[1],a[2]+m*Math.sin(b)]},trackTarget:function(a,b,f,e){var b=q.subtract(b,a),d=q.length(b),m;
m=q.normalize(b);m=q.multiply(m,f*(1/(1/(d-e))));d>e?a=q.add(a,m):d<e?(m=q.normalize(b),m=q.multiply(m,f*(1/(1/Math.abs(d-e)))),a=q.subtract(a,m)):a=[a[0],a[1]+m[2],a[2]];return a},getClosestTo:function(a,b,f){b=q.subtract(b,a);f=q.subtract(f,a);return q.add(q.multiply(b,q.dot(b,f)/q.dot(b,b)),a)},linePlaneIntersect:function(a,b,f,e){var d=-a[0]*b[0]-a[1]*b[1]-a[2]*b[2],b=a[0]*(e[0]-f[0])+a[1]*(e[1]-f[1])+a[2]*(e[2]-f[2]);if(Math.abs(b)<0.0010)return!1;a=-(d+a[0]*f[0]+a[1]*f[1]+a[2]*f[2])/b;return[f[0]+
a*(e[0]-f[0]),f[1]+a*(e[1]-f[1]),f[2]+a*(e[2]-f[2])]}},h={lookat:function(a,b,f,e,d,m,c,r,h){var g=[],v=[],w=[],v=[];g[0]=e-a;g[1]=d-b;g[2]=m-f;w[0]=c;w[1]=r;w[2]=h;g=q.normalize(g);v=q.cross(g,w);v=q.normalize(v);w=q.cross(v,g);v=[v[0],w[0],-g[0],0,v[1],w[1],-g[1],0,v[2],w[2],-g[2],0,0,0,0,1];e=new CubicVR.Transform(v);e.translate([-a,-b,-f]);return e.getResult()},multiply:function(a,b,f){f===n&&(f=[]);f[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3];f[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13]*b[3];f[2]=
a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]*b[3];f[3]=a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3];f[4]=a[0]*b[4]+a[4]*b[5]+a[8]*b[6]+a[12]*b[7];f[5]=a[1]*b[4]+a[5]*b[5]+a[9]*b[6]+a[13]*b[7];f[6]=a[2]*b[4]+a[6]*b[5]+a[10]*b[6]+a[14]*b[7];f[7]=a[3]*b[4]+a[7]*b[5]+a[11]*b[6]+a[15]*b[7];f[8]=a[0]*b[8]+a[4]*b[9]+a[8]*b[10]+a[12]*b[11];f[9]=a[1]*b[8]+a[5]*b[9]+a[9]*b[10]+a[13]*b[11];f[10]=a[2]*b[8]+a[6]*b[9]+a[10]*b[10]+a[14]*b[11];f[11]=a[3]*b[8]+a[7]*b[9]+a[11]*b[10]+a[15]*b[11];f[12]=a[0]*b[12]+a[4]*b[13]+a[8]*
b[14]+a[12]*b[15];f[13]=a[1]*b[12]+a[5]*b[13]+a[9]*b[14]+a[13]*b[15];f[14]=a[2]*b[12]+a[6]*b[13]+a[10]*b[14]+a[14]*b[15];f[15]=a[3]*b[12]+a[7]*b[13]+a[11]*b[14]+a[15]*b[15];return f},vec4_multiply:function(a,b,f){f===n&&(f=[]);f[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12]*a[3];f[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13]*a[3];f[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14]*a[3];f[3]=b[3]*a[0]+b[7]*a[1]+b[11]*a[2]+b[15]*a[3];return f},vec3_multiply:function(a,b,f){f===n&&(f=[]);f[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+
b[12];f[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13];f[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14];return f},perspective:function(a,b,f,e){a=Math.tan(a*Math.PI/360);return[1/(a*b),0,0,0,0,1/a,0,0,0,0,-(e+f)/(e-f),-1,0,0,-(2*e*f)/(e-f),0]},ortho:function(a,b,f,e,d,m){return[2/(b-a),0,0,0,0,2/(e-f),0,0,0,0,-2/(m-d),0,-(a+b)/(b-a),-(e+f)/(e-f),-(m+d)/(m-d),1]},determinant:function(a){return(a[0]*a[5]-a[1]*a[4])*(a[10]*a[15]-a[11]*a[14])-(a[0]*a[6]-a[2]*a[4])*(a[9]*a[15]-a[11]*a[13])+(a[0]*a[7]-a[3]*a[4])*(a[9]*
a[14]-a[10]*a[13])+(a[1]*a[6]-a[2]*a[5])*(a[8]*a[15]-a[11]*a[12])-(a[1]*a[7]-a[3]*a[5])*(a[8]*a[14]-a[10]*a[12])+(a[2]*a[7]-a[3]*a[6])*(a[8]*a[13]-a[9]*a[12])},coFactor:function(){},transpose:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},inverse_mat3:function(a){var b=[],f=a[0],e=a[1],d=a[2],m=a[4],c=a[5],r=a[6],h=a[8],g=a[9],a=a[10],v=a*c-r*g,w=-a*m+r*h,q=g*m-c*h,n=f*v+e*w+d*q;if(!n)return null;n=1/n;b[0]=v*n;b[1]=(-a*e+d*g)*n;b[2]=(r*
e-d*c)*n;b[3]=w*n;b[4]=(a*f-d*h)*n;b[5]=(-r*f+d*m)*n;b[6]=q*n;b[7]=(-g*f+e*h)*n;b[8]=(c*f-e*m)*n;return b},inverse:function(a,b){var f=a[0]*a[5]-a[1]*a[4],e=a[0]*a[6]-a[2]*a[4],d=a[0]*a[7]-a[3]*a[4],m=a[1]*a[6]-a[2]*a[5],c=a[1]*a[7]-a[3]*a[5],r=a[2]*a[7]-a[3]*a[6],h=a[8]*a[13]-a[9]*a[12],g=a[8]*a[14]-a[10]*a[12],v=a[8]*a[15]-a[11]*a[12],w=a[9]*a[14]-a[10]*a[13],q=a[9]*a[15]-a[11]*a[13],s=a[10]*a[15]-a[11]*a[14],t=f*s-e*q+d*w+m*v-c*g+r*h;if(t!==0)return b===n&&(b=[]),b[0]=0+a[5]*s-a[6]*q+a[7]*w,b[4]=
0-a[4]*s+a[6]*v-a[7]*g,b[8]=0+a[4]*q-a[5]*v+a[7]*h,b[12]=0-a[4]*w+a[5]*g-a[6]*h,b[1]=0-a[1]*s+a[2]*q-a[3]*w,b[5]=0+a[0]*s-a[2]*v+a[3]*g,b[9]=0-a[0]*q+a[1]*v-a[3]*h,b[13]=0+a[0]*w-a[1]*g+a[2]*h,b[2]=0+a[13]*r-a[14]*c+a[15]*m,b[6]=0-a[12]*r+a[14]*d-a[15]*e,b[10]=0+a[12]*c-a[13]*d+a[15]*f,b[14]=0-a[12]*m+a[13]*e-a[14]*f,b[3]=0-a[9]*r+a[10]*c-a[11]*m,b[7]=0+a[8]*r-a[10]*d+a[11]*e,b[11]=0-a[8]*c+a[9]*d-a[11]*f,b[15]=0+a[8]*m-a[9]*e+a[10]*f,f=1/t,b[0]*=f,b[1]*=f,b[2]*=f,b[3]*=f,b[4]*=f,b[5]*=f,b[6]*=f,
b[7]*=f,b[8]*=f,b[9]*=f,b[10]*=f,b[11]*=f,b[12]*=f,b[13]*=f,b[14]*=f,b[15]*=f,b;return null},identity:function(a){if(a==n)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1},translate:function(a,b,f,e){a=[1,0,0,0,0,1,0,0,0,0,1,0,a,b,f,1];if(e===n)return a;h.multiply(e.slice(0),a,e)},rotateAxis:function(a,b,f,e,d){var m=Math.sin(a*(Math.PI/180)),a=Math.cos(a*(Math.PI/180)),b=[a+b*b*(1-a),b*f*
(1-a)-e*m,b*e*(1-a)+f*m,0,f*b*(1-a)+e*m,a+f*f*(1-a),f*e*(1-a)-b*m,0,e*b*(1-a)-f*m,e*f*(1-a)+b*m,a+e*e*(1-a),0,0,0,0,1];if(d===n)return b;h.multiply(d.slice(0),b,d)},rotate:function(a,b,f,e){var d;e===n&&(e=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);f!==0&&(d=Math.sin(f*(Math.PI/180)),f=Math.cos(f*(Math.PI/180)),h.multiply(e.slice(0),[f,d,0,0,-d,f,0,0,0,0,1,0,0,0,0,1],e));b!==0&&(d=Math.sin(b*(Math.PI/180)),f=Math.cos(b*(Math.PI/180)),h.multiply(e.slice(0),[f,0,-d,0,0,1,0,0,d,0,f,0,0,0,0,1],e));a!==0&&(d=
Math.sin(a*(Math.PI/180)),f=Math.cos(a*(Math.PI/180)),h.multiply(e.slice(0),[1,0,0,0,0,f,d,0,0,-d,f,0,0,0,0,1],e));return e},scale:function(a,b,f,e){if(e===n)return[a,0,0,0,0,b,0,0,0,0,f,0,0,0,0,1];h.multiply(e.slice(0),[a,0,0,0,0,b,0,0,0,0,f,0,0,0,0,1],e)}};t.prototype={setIdentity:function(){this.m_stack[this.c_stack]=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},invalidate:function(){this.valid=
0;this.result=null;return this},getResult:function(){var a=CubicVR.mat4;if(!this.c_stack)return this.m_stack[0];var b=g;if(this.valid>this.c_stack-1)this.valid=this.c_stack-1;for(var f=this.valid;f<this.c_stack+1;f++)b=a.multiply(b,this.m_stack[f]),this.m_cache[f]=b;this.valid=this.c_stack-1;return this.result=this.m_cache[this.c_stack]},pushMatrix:function(a){this.c_stack++;this.m_stack[this.c_stack]=a?a:g;return this},popMatrix:function(){if(this.c_stack!==0)return this.c_stack--,this},clearStack:function(a){this.m_stack=
[];this.m_cache=[];this.valid=this.c_stack=0;this.result=null;a!==n?this.m_stack[0]=a:this.setIdentity();return this},translate:function(a,b,f){var e=CubicVR.mat4;if(typeof a==="object")return this.translate(a[0],a[1],a[2]);var d=this.getIdentity();d[12]=a;d[13]=b;d[14]=f;this.m_stack[this.c_stack]=e.multiply(this.m_stack[this.c_stack],d);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},scale:function(a,b,f){var e=CubicVR.mat4;if(typeof a==="object")return this.scale(a[0],a[1],a[2]);
var d=this.getIdentity();d[0]=a;d[5]=b;d[10]=f;this.m_stack[this.c_stack]=e.multiply(this.m_stack[this.c_stack],d);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},rotate:function(a,b,f,e){var d=CubicVR.mat4;if(typeof a==="object")return this.rotate(a[0],1,0,0),this.rotate(a[1],0,1,0),this.rotate(a[2],0,0,1),this;var m,c;if(b||f||e)m=Math.sin(-a*(Math.PI/180)),c=Math.cos(-a*(Math.PI/180));b&&(a=this.getIdentity(),a[5]=c*b,a[9]=m*b,a[6]=-m*b,a[10]=c*b,this.m_stack[this.c_stack]=d.multiply(a,
this.m_stack[this.c_stack]));f&&(b=this.getIdentity(),b[0]=c*f,b[8]=-m*f,b[2]=m*f,b[10]=c*f,this.m_stack[this.c_stack]=d.multiply(b,this.m_stack[this.c_stack]));e&&(f=this.getIdentity(),f[0]=c*e,f[4]=m*e,f[1]=-m*e,f[5]=c*e,this.m_stack[this.c_stack]=d.multiply(f,this.m_stack[this.c_stack]));this.valid===this.c_stack&&this.c_stack&&this.valid--;return this}};s.prototype={length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var a=Math.sqrt(this.length());
this.x/=a;this.y/=a;this.z/=a;this.w/=a},fromMatrix:function(a){var b=1+a[0]+a[5]+a[10],c,e,d;b>1.0E-8?(c=Math.sqrt(b)*2,b=(a[9]-a[6])/c,e=(a[2]-a[8])/c,d=(a[4]-a[1])/c,a=0.25*c):a[0]>a[5]&&a[0]>a[10]?(c=Math.sqrt(1+a[0]-a[5]-a[10])*2,b=0.25*c,e=(a[4]+a[1])/c,d=(a[2]+a[8])/c,a=(a[9]-a[6])/c):a[5]>a[10]?(c=Math.sqrt(1+a[5]-a[0]-a[10])*2,b=(a[4]+a[1])/c,e=0.25*c,d=(a[9]+a[6])/c,a=(a[2]-a[8])/c):(c=Math.sqrt(1+a[10]-a[0]-a[5])*2,b=(a[2]+a[8])/c,e=(a[9]+a[6])/c,d=0.25*c,a=(a[4]-a[1])/c);this.x=b;this.y=
e;this.z=d;this.w=a},fromEuler:function(a,b,c){var e=Math.cos(Math.PI/180*b/2),b=Math.sin(Math.PI/180*b/2),d=Math.cos(Math.PI/180*c/2),c=Math.sin(Math.PI/180*c/2),m=Math.cos(Math.PI/180*a/2),a=Math.sin(Math.PI/180*a/2),o=e*d,r=b*c;this.w=o*m-r*a;this.x=o*a+r*m;this.y=b*d*m+e*c*a;this.z=e*c*m-b*d*a},toEuler:function(){var a=this.w*this.w,b=this.x*this.x,c=this.y*this.y,e=this.z*this.z;return[180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-b-c+e+a),180/Math.PI*Math.asin(-2*(this.x*this.z-this.y*
this.w)),180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),b-c-e+a)]},multiply:function(a,b){b===n&&(b=a,a=this);return new s(a.x*b.w+a.w*b.x+a.y*b.z-a.z*b.y,a.y*b.w+a.w*b.y+a.z*b.x-a.x*b.z,a.z*b.w+a.w*b.z+a.x*b.y-a.y*b.x,a.w*b.w-a.x*b.x-a.y*b.y-a.z*b.z)}};return{vec2:{equal:function(a,b,c){c===n&&(c=1.0E-8);if(a===n&&b===n)return!0;if(a===n||b===n)return!1;return Math.abs(a[0]-b[0])<c&&Math.abs(a[1]-b[1])<c}},vec3:q,mat3:{transpose_inline:function(a){var b=a[1],c=a[2],e=a[5];a[1]=a[3];a[2]=
a[6];a[3]=b;a[5]=a[7];a[6]=c;a[7]=e},vec3_multiply:function(a,b,c){c===n&&(c=[]);c[0]=b[0]*a[0]+b[3]*a[1]+b[6]*a[2];c[1]=b[1]*a[0]+b[4]*a[1]+b[7]*a[2];c[2]=b[2]*a[0]+b[5]*a[1]+b[8]*a[2];return c}},mat4:h,aabb:{engulf:function(a,b){a[0][0]>b[0]&&(a[0][0]=b[0]);a[0][1]>b[1]&&(a[0][1]=b[1]);a[0][2]>b[2]&&(a[0][2]=b[2]);a[1][0]<b[0]&&(a[1][0]=b[0]);a[1][1]<b[1]&&(a[1][1]=b[1]);a[1][2]<b[2]&&(a[1][2]=b[2])},reset:function(a,b){b===void 0&&(b=[0,0,0]);a[0][0]=b[0];a[0][1]=b[1];a[0][2]=b[2];a[1][0]=b[0];
a[1][1]=b[1];a[1][2]=b[2]},size:function(a){return[a[0][0]<a[1][0]?a[1][0]-a[0][0]:a[0][0]-a[1][0],a[0][1]<a[1][1]?a[1][1]-a[0][1]:a[0][1]-a[1][1],a[0][2]<a[1][2]?a[1][2]-a[0][2]:a[0][2]-a[1][2]]}},plane:{classifyPoint:function(a,b){var c=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3];if(c<0)return-1;else if(c>0)return 1;return 0},normalize:function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=b;a[1]/=b;a[2]/=b;a[3]/=b}},sphere:{intersects:function(a,b){var c=CubicVR.vec3.subtract([a[0],a[1],a[2]],
[b[0],b[1],b[2]]),c=Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]),e=a[3]+b[3];if(c*c<e*e)return!0;return!1}},triangle:{normal:function(a,b,c,e){e===n&&(e=[]);var d=a[0]-b[0],m=a[1]-b[1],a=a[2]-b[2],o=b[0]-c[0],r=b[1]-c[1],b=b[2]-c[2];e[0]=m*b-a*r;e[1]=a*o-d*b;e[2]=d*r-m*o;return e}},Transform:t,Quaternion:s}});CubicVR.RegisterModule("Mesh",function(y){function t(){this.points=[];this.point_normals=[];this.point_colors=[];this.uvs=[];this.normal=[0,0,0];this.segment=this.material=0}function s(c){this.points=[];this.faces=[];this.currentFace=-1;this.currentSegment=this.currentMaterial=0;this.bb=this.originBuffer=this.compiled=null;this.name=c?c:null;this.materials=[];this.morphTarget=this.morphTargets=this.bb=null;this.morphWeight=0;this.morphTargetIndex=this.morphSourceIndex=-1;this.instanceMaterials=null}
var n=y.undef,g=y.GLCore;t.prototype={setUV:function(c,g){g!==n?this.uvs[g]=c:c.length!==2?this.uvs=c:this.uvs.push(c)},setColor:function(c,g){g!==n?this.point_colors[g]=c:typeof c[0]!=="number"?this.point_colors=c:this.point_colors.push(c)},flip:function(){for(var c=0,g=this.point_normals.length;c<g;c++)this.point_normals[c]=[-this.point_normals[c][0],-this.point_normals[c][1],-this.point_normals[c][2]];this.points.reverse();this.point_normals.reverse();this.uvs.reverse();this.normal=[-this.normal[0],
-this.normal[1],-this.normal[2]]}};s.prototype={showAllSegments:function(){for(var c in this.segment_state)this.segment_state.hasOwnProperty(c)&&(this.segment_state[c]=!0)},hideAllSegments:function(){for(var c in this.segment_state)this.segment_state.hasOwnProperty(c)&&(this.segment_state[c]=!1)},setSegment:function(c,g){g!==n?this.segment_state[c]=g:this.currentSegment=c},addPoint:function(c){if(c.length!==3||typeof c[0]==="object")for(var g=0,h=c.length;g<h;g++)this.points.push(c[g]);else this.points.push(c);
return this.points.length-1},getMaterialIndex:function(c){return this.materials.indexOf(c)},setFaceMaterial:function(c,g){var h;typeof c=="number"?h=c:(h=this.materials.indexOf(c),h===-1&&(this.materials.push(c),h=this.materials.length-1));if(g!==n){if(this.faces[g]!==n)this.faces[g].material=h}else this.currentMaterial=h;return this},addFace:function(c,g,h,a){if(typeof c[0]!=="number"){g=0;for(h=c.length;g<h;g++)this.addFace(c[g])}else{g===n?(this.currentFace=this.faces.length,this.faces.push(new t)):
(this.faces[g]===n&&(this.faces[g]=new t),this.currentFace=g);if(typeof c==="object")this.faces[this.currentFace].points=c;h!==n?this.setFaceMaterial(h,this.currentFace):this.faces[this.currentFace].material=this.currentMaterial;this.faces[this.currentFace].segment=a!==n?a:this.currentSegment;return this.currentFace}},flipFaces:function(){for(var c=0,g=this.faces.length;c<g;c++)this.faces[c].flip()},triangulateQuads:function(){for(var c=0,g=this.faces.length;c<g;c++)if(this.faces[c].points.length===
4){var h=this.faces.length;this.addFace([this.faces[c].points[2],this.faces[c].points[3],this.faces[c].points[0]],this.faces.length,this.faces[c].material,this.faces[c].segment);this.faces[c].points.pop();this.faces[h].normal=this.faces[c].normal.slice(0);if(this.faces[c].point_colors.length===4)this.faces[h].point_colors=this.faces[c].point_colors.slice(0);this.faces[c].uvs.length===4&&(this.faces[h].setUV(this.faces[c].uvs[2],0),this.faces[h].setUV(this.faces[c].uvs[3],1),this.faces[h].setUV(this.faces[c].uvs[0],
2),this.faces[c].uvs.pop());this.faces[c].point_normals.length===4&&(this.faces[h].point_normals[0]=this.faces[c].point_normals[2],this.faces[h].point_normals[1]=this.faces[c].point_normals[3],this.faces[h].point_normals[2]=this.faces[c].point_normals[0],this.faces[c].point_normals.pop())}return this},booleanAdd:function(c,g){var h=CubicVR.mat4,a=this.points.length,b,f,e,d;if(g!==n){f=g.getResult();b=0;for(e=c.points.length;b<e;b++)this.addPoint(h.vec3_multiply(c.points[b],f))}else{b=0;for(e=c.points.length;b<
e;b++)this.addPoint([c.points[b][0],c.points[b][1],c.points[b][2]])}h=[];b=0;for(e=c.materials.length;b<e;b++)f=this.materials.indexOf(c.materials[b]),f===-1?(this.materials.push(c.materials[b]),h[b]=this.materials.length-1):h[b]=f;b=0;for(e=c.faces.length;b<e;b++){var m=[];f=0;for(d=c.faces[b].points.length;f<d;f++)m.push(c.faces[b].points[f]+a);m=this.faces[this.addFace(m)];m.segment=c.faces[b].segment;m.material=h[c.faces[b].material];if(m.material===n)m.material=0;f=0;for(d=c.faces[b].uvs.length;f<
d;f++)m.uvs[f]=[c.faces[b].uvs[f][0],c.faces[b].uvs[f][1]];f=0;for(d=c.faces[b].point_normals.length;f<d;f++)m.point_normals[f]=[c.faces[b].point_normals[f][0],c.faces[b].point_normals[f][1],c.faces[b].point_normals[f][2]]}return this},calcFaceNormals:function(c,g){var h=CubicVR.vec3,a=CubicVR.triangle,b=0,f=this.faces.length;c&&(b=c);for(g&&(f=g+1);b<f;b++)this.faces[b].normal=this.faces[b].points.length<3?[0,0,0]:h.normalize(a.normal(this.points[this.faces[b].points[0]],this.points[this.faces[b].points[1]],
this.points[this.faces[b].points[2]]));return this},getMaterial:function(c){for(var g=0,h=this.materials.length;g<h;g++)if(this.materials[g].name===c)return this.materials[g];return null},bindInstanceMaterials:function(c){this.instanceMaterials=c},calcNormals:function(c){var g=CubicVR.vec3,h=!1;c!==n&&(h=!0);this.calcFaceNormals();var a,b,f,e,d=Array(this.points.length);a=0;for(e=d.length;a<e;a++)d[a]=[];f=this.faces.length;for(a=0;a<f;a++){e=this.faces[a].points.length;for(b=0;b<e;b++)d[this.faces[a].points[b]].push([a,
b])}a=0;for(e=this.points.length;a<e;a++){var m=d[a].length;for(b=0;b<m;b++){var o=1,r=d[a][b][0],A=d[a][b][1],z=this.materials.length?this.materials[this.faces[r].material].max_smooth:60,v=this.faces[r];h&&(c[r]===n&&(c[r]=[]),c[r][A]===n&&(c[r][A]=[]));var w=Array(3);w[0]=v.normal[0];w[1]=v.normal[1];w[2]=v.normal[2];if(z!==0)for(f=0;f<m;f++)if(b!==f){var C=d[a][f][0],s=this.faces[C],t=g.angle(s.normal,v.normal);if(t!==t||t*(180/Math.PI)<=z)h&&c[r][A].push(C),w[0]+=s.normal[0],w[1]+=s.normal[1],
w[2]+=s.normal[2],o++}w[0]/=o;w[1]/=o;w[2]/=o;this.faces[r].point_normals[A]=g.normalize(w)}}return this},recalcNormals:function(c){this.calcFaceNormals();for(var g=0,h=this.faces.length;g<h;g++)for(var a=this.faces[g],b=0,f=a.points.length;b<f;b++){var e=c[g][b],d=a.point_normals[b];d[0]=a.normal[0];d[1]=a.normal[1];d[2]=a.normal[2];for(var m=e.length,o=0;o<m;o++){var r=this.faces[e[o]];d[0]+=r.normal[0];d[1]+=r.normal[1];d[2]+=r.normal[2]}m!==0&&(d[0]/=m+1,d[1]/=m+1,d[2]/=m+1,e=Math.sqrt(d[0]*d[0]+
d[1]*d[1]+d[2]*d[2]),d[0]/=e,d[1]/=e,d[2]/=e)}return this},removeDoubles:function(){var c=[],g=[],h,a,b,f;h=0;for(a=this.points.length;h<a;h++){var e=-1,d=this.points[h];b=0;for(f=c.length;b<f;b++)if(CubicVR.vec3.equal(d,c[b])){e=b;break}e!=-1?g[h]=e:(g[h]=c.length,c.push(this.points[h]))}this.points=c;h=0;for(a=this.faces.length;h<a;h++){c=this.faces[h];b=0;for(f=c.points.length;b<f;b++)c.points[b]=g[c.points[b]]}},prepare:function(c){c===n&&(c=!0);this.calcNormals().triangulateQuads().compile();
c&&this.clean();return this},clean:function(){var c,g;c=0;for(g=this.points.length;c<g;c++)delete this.points[c],this.points[c]=null;this.points=[];c=0;for(g=this.faces.length;c<g;c++)delete this.faces[c].points,delete this.faces[c].point_normals,delete this.faces[c].uvs,delete this.faces[c].normal,delete this.faces[c],this.faces[c]=null;this.faces=[];return this},compileMap:function(c){var g=CubicVR.vec3,h=CubicVR.vec2;c===n&&(c=1.0E-5);var a={segments:[],bounds:[]},b=[],f,e,d,m,o,r,A,z;this.materials.length||
this.materials.push(new CubicVR.Material);f=0;for(r=this.materials.length;f<r;f++)b[f]=[];f=0;for(r=this.faces.length;f<r;f++)if(this.faces[f].points.length===3)d=this.faces[f].material,m=this.faces[f].segment,b[d][m]===n&&(b[d][m]=[],a.segments.push(m)),b[d][m].push(f);var v=[],w=0,C=!1,s=!1,t=!1,x;f=0;for(r=b.length;f<r;f++)for(e in b[f])if(b[f].hasOwnProperty(e))for(d=0;d<b[f][e].length;d++)x=b[f][e][d],C=C||this.faces[x].uvs.length!==0,s=s||this.faces[x].point_normals.length!==0,t=t||this.faces[x].point_colors.length!==
0;if(C)for(f=0;f<this.faces.length;f++)if(!this.faces[f].uvs.length)for(e=0;e<this.faces[f].points.length;e++)this.faces[f].uvs.push([0,0]);if(s)for(f=0;f<this.faces.length;f++)if(!this.faces[f].point_normals.length)for(e=0;e<this.faces[f].points.length;e++)this.faces[f].point_normals.push([0,0,0]);if(t)for(f=0;f<this.faces.length;f++)if(!this.faces[f].point_colors.length)for(e=0;e<this.faces[f].points.length;e++)this.faces[f].point_colors.push([0,0,0]);f=0;for(r=b.length;f<r;f++)for(e in b[f])if(b[f].hasOwnProperty(e)){d=
0;for(A=b[f][e].length;d<A;d++){x=b[f][e][d];for(m=0;m<3;m++){var u=this.faces[x].points[m],F=-1;if(v[u]!==n){o=0;for(z=v[u].length;o<z;o++){var D=v[u][o][0],B=v[u][o][1],F=v[u][o][2];s&&(F=g.equal(this.faces[D].point_normals[B],this.faces[x].point_normals[m],c)?F:-1);C&&(F=h.equal(this.faces[D].uvs[B],this.faces[x].uvs[m],c)?F:-1);t&&(F=g.equal(this.faces[D].point_colors[B],this.faces[x].point_colors[m],c)?F:-1)}}if(F!==-1){if(a.elements===n)a.elements=[];a.elements[f]===n&&(a.elements[f]=[]);a.elements[f][e]===
n&&(a.elements[f][e]=[]);a.elements[f][e].push(F)}else{if(a.points===n)a.points=[];a.points.push(u);a.bounds.length===0?(a.bounds[0]=[this.points[u][0],this.points[u][1],this.points[u][2]],a.bounds[1]=[this.points[u][0],this.points[u][1],this.points[u][2]]):(this.points[u][0]<a.bounds[0][0]&&(a.bounds[0][0]=this.points[u][0]),this.points[u][1]<a.bounds[0][1]&&(a.bounds[0][1]=this.points[u][1]),this.points[u][2]<a.bounds[0][2]&&(a.bounds[0][2]=this.points[u][2]),this.points[u][0]>a.bounds[1][0]&&(a.bounds[1][0]=
this.points[u][0]),this.points[u][1]>a.bounds[1][1]&&(a.bounds[1][1]=this.points[u][1]),this.points[u][2]>a.bounds[1][2]&&(a.bounds[1][2]=this.points[u][2]));if(s){if(a.normals===n)a.normals=[];a.normals.push([x,m])}if(t){if(a.colors===n)a.colors=[];a.colors.push([x,m])}if(C){if(a.uvs===n)a.uvs=[];a.uvs.push([x,m])}if(a.elements===n)a.elements=[];a.elements[f]===n&&(a.elements[f]=[]);a.elements[f][e]===n&&(a.elements[f][e]=[]);a.elements[f][e].push(w);v[u]===n&&(v[u]=[]);v[u].push([x,m,w]);w++}}}}return a},
compileVBO:function(c,g,h,a,b,f){typeof g=="object"?(g=g.element!==n?g.element:!0,h=g.vertex!==n?g.vertex:!0,f=g.color!==n?g.color:!0,a=g.normal!==n?g.normal:!0,b=g.uv!==n?g.uv:!0):(g===n&&(g=!0),h===n&&(h=!0),f===n&&(f=!0),a===n&&(a=!0),b===n&&(b=!0));var e={},d,m,o;if(c.points&&h){d=c.points.length;e.vbo_points=new Float32Array(d*3);for(h=m=0;h<d;h++)o=c.points[h],e.vbo_points[m++]=this.points[o][0],e.vbo_points[m++]=this.points[o][1],e.vbo_points[m++]=this.points[o][2]}if(c.normals&&a){d=c.normals.length;
e.vbo_normals=new Float32Array(d*3);for(h=m=0;h<d;h++)o=c.normals[h],e.vbo_normals[m++]=this.faces[o[0]].point_normals[o[1]][0],e.vbo_normals[m++]=this.faces[o[0]].point_normals[o[1]][1],e.vbo_normals[m++]=this.faces[o[0]].point_normals[o[1]][2]}if(c.colors&&f){d=c.colors.length;e.vbo_colors=new Float32Array(d*3);for(h=m=0;h<d;h++)o=c.colors[h],e.vbo_colors[m++]=this.faces[o[0]].point_colors[o[1]][0],e.vbo_colors[m++]=this.faces[o[0]].point_colors[o[1]][1],e.vbo_colors[m++]=this.faces[o[0]].point_colors[o[1]][2]}if(c.uvs&&
b){d=c.uvs.length;e.vbo_uvs=new Float32Array(d*2);for(h=m=0;h<d;h++)o=c.uvs[h],e.vbo_uvs[m++]=this.faces[o[0]].uvs[o[1]][0],e.vbo_uvs[m++]=this.faces[o[0]].uvs[o[1]][1]}if(g){e.elements_ref=[];e.vbo_elements=[];h=0;for(d=c.elements.length;h<d;h++){e.elements_ref[h]=[];var b=0,r;for(r in c.elements[h])if(c.elements[h].hasOwnProperty(r)){f=c.elements[h][r];g=0;for(a=f.length;g<a;g++)e.vbo_elements.push(f[g]);e.elements_ref[h][b]=[r|0,f.length|0];b++}}e.vbo_elements=new Uint16Array(e.vbo_elements)}e.segments=
c.segments;e.bounds=c.bounds;return e},bufferVBO:function(c,q){var h=g.gl,a={};q===n&&(q={});a.gl_points=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,a.gl_points);h.bufferData(h.ARRAY_BUFFER,c.vbo_points,h.STATIC_DRAW);c.vbo_normals?(a.gl_normals=h.createBuffer(),h.bindBuffer(h.ARRAY_BUFFER,a.gl_normals),h.bufferData(h.ARRAY_BUFFER,c.vbo_normals,h.STATIC_DRAW)):a.gl_normals=q.gl_normals?q.gl_normals:null;c.vbo_uvs?(a.gl_uvs=h.createBuffer(),h.bindBuffer(h.ARRAY_BUFFER,a.gl_uvs),h.bufferData(h.ARRAY_BUFFER,
c.vbo_uvs,h.STATIC_DRAW)):a.gl_uvs=q.gl_uvs?q.gl_uvs:null;c.vbo_colors?(a.gl_colors=h.createBuffer(),h.bindBuffer(h.ARRAY_BUFFER,a.gl_colors),h.bufferData(h.ARRAY_BUFFER,c.vbo_colors,h.STATIC_DRAW)):a.gl_colors=q.gl_colors?q.gl_colors:null;!c.vbo_elements&&q.gl_elements?(a.gl_elements=q.gl_elements,a.elements_ref=q.elements_ref):(a.gl_elements=h.createBuffer(),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,a.gl_elements),h.bufferData(h.ELEMENT_ARRAY_BUFFER,c.vbo_elements,h.STATIC_DRAW),a.elements_ref=c.elements_ref);
a.segments=c.segments;a.bounds=c.bounds;q.elements_ref&&!c.elements_ref&&h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null);return a},bindBuffer:function(c){if(this.originBuffer===null)this.originBuffer=c;this.compiled=c;this.segment_state=[];for(var g=0,h=c.segments.length;g<h;g++)this.segment_state[c.segments[g]]=!0;this.bb=c.bounds},compile:function(c){this.bindBuffer(this.bufferVBO(this.compileVBO(this.compileMap(c))));return this},addMorphTarget:function(c){if(this.morphTargets===null)this.morphTargets=
[];this.morphTargets.push(c)},setMorphSource:function(c){if(this.morphSourceIndex!==c)this.morphSourceIndex=c,this.bindBuffer(this.morphTargets[c])},setMorphTarget:function(c){if(this.morphTargetIndex!==c)this.morphTargetIndex=c,this.morphTarget=this.morphTargets[c]},setMorphWeight:function(c){this.morphWeight=c},morphTargetCount:function(){return this.morphTargets!==null?this.morphTargets.length:0}};return{Mesh:s,Face:t}});CubicVR.RegisterModule("Motion",function(y){function t(){this.time=this.value=0;this.shape=c.envelope.shape.TCB;this.bias=this.continuity=this.tension=0;this.next=this.prev=null;this.param=[0,0,0,0]}function s(a){this.nKeys=0;this.lastKey=this.firstKey=this.keys=null;a?(this.in_behavior=a.in_behavior?a.in_behavior:c.envelope.behavior.CONSTANT,this.out_behavior=a.out_behavior?a.out_behavior:c.envelope.behavior.CONSTANT):this.out_behavior=this.in_behavior=c.envelope.behavior.CONSTANT}function n(a,d){this.env_init=
a;this.key_init=d;this.controllers=[];this.yzflip=!1}var g=y.undef,c=CubicVR.enums;c.motion={POS:0,ROT:1,SCL:2,FOV:3,LENS:4,NEARCLIP:5,FARCLIP:6,INTENSITY:7,X:0,Y:1,Z:2,V:3};c.envelope={shape:{TCB:0,HERM:1,BEZI:2,LINE:3,STEP:4,BEZ2:5},behavior:{RESET:0,CONSTANT:1,REPEAT:2,OSCILLATE:3,OFFSET:4,LINEAR:5}};var q=function(a,d,b){var c=0,c=b-d;if(c===0)return[d,0];d=a-c*Math.floor((a-d)/c);c=-parseInt((d-a)/c+(d>a?0.5:-0.5),10);return[d,c]},h=function(a,d,b,c,f){var g,h;h=f*f;g=3*(d-a);d=3*(b-d)-g;return(c-
a-g-d)*h*f+d*h+g*f+a},a=function(b,d,c,f,r,g,n){var v,w;w=g+(n-g)*0.5;v=h(b,d,c,f,w);return Math.abs(r-v)>1.0E-4?(v>r?n=w:g=w,a(b,d,c,f,r,g,n)):w},b=function(a,d){var b,f,r,g;a.shape===c.envelope.shape.TCB?(b=(1-a.tension)*(1+a.continuity)*(1+a.bias),f=(1-a.tension)*(1-a.continuity)*(1-a.bias),r=d.value-a.value,a.prev?(g=(d.time-a.time)/(d.time-a.prev.time),b=g*(b*(a.value-a.prev.value)+f*r)):b=f*r):a.shape===c.envelope.shape.LINE?(r=d.value-a.value,a.prev?(g=(d.time-a.time)/(d.time-a.prev.time),
b=g*(a.value-a.prev.value+r)):b=r):a.shape===c.envelope.shape.BEZI||a.shape===c.envelope.shape.HERM?(b=a.param[1],a.prev&&(b*=(d.time-a.time)/(d.time-a.prev.time))):a.shape===c.envelope.shape.BEZ2?(b=a.param[3]*(d.time-a.time),Math.abs(a.param[2])>1.0E-5?b/=a.param[2]:b*=1E5):b=0;return b},f=function(a,d){var b,f,r,g;d.shape===c.envelope.shape.LINE?(r=d.value-a.value,d.next?(g=(d.time-a.time)/(d.next.time-a.time),b=g*(d.next.value-d.value+r)):b=r):d.shape===c.envelope.shape.TCB?(b=(1-d.tension)*(1-
d.continuity)*(1+d.bias),f=(1-d.tension)*(1+d.continuity)*(1-d.bias),r=d.value-a.value,d.next?(g=(d.time-a.time)/(d.next.time-a.time),b=g*(f*(d.next.value-d.value)+b*r)):b*=r):d.shape===c.envelope.shape.HERM||d.shape===c.envelope.shape.BEZI?(b=d.param[0],d.next&&(b*=(d.time-a.time)/(d.next.time-a.time))):d.shape===c.envelope.shape.BEZ2?(b=d.param[1]*(d.time-a.time),Math.abs(d.param[0])>1.0E-5?b/=d.param[0]:b*=1E5):b=0;return b};s.prototype={setBehavior:function(a,d){this.in_behavior=a;this.out_behavior=
d},empty:function(){return this.nKeys===0},addKey:function(a,d,b){var f=typeof a=="object"?a:b;d||(d=0);a||(a=0);f?(f=a,a=f.time,b=this.insertKey(a),b.value=f.value?f.value:d,b.time=f.time?f.time:a,b.shape=f.shape?f.shape:c.envelope.shape.TCB,b.tension=f.tension?f.tension:0,b.continuity=f.continuity?f.continuity:0,b.bias=f.bias?f.bias:0,b.param=f.param?f.param:[0,0,0,0]):(b=this.insertKey(a),b.value=d);return b},insertKey:function(a){var d=new t;d.time=a;if(!this.nKeys)return this.lastKey=this.firstKey=
this.keys=d,this.nKeys++,d;for(var b=this.keys;b;){if(this.firstKey.time>a)this.firstKey=d;else if(this.lastKey.time<a)this.lastKey=d;if(b.time>d.time){d.prev=b.prev;if(d.prev)d.prev.next=d;d.next=b;d.next.prev=d;this.nKeys++;return d}else if(!b.next)return d.prev=b,b.next=d,this.nKeys++,d;b=b.next}return null},evaluate:function(e){var d,m,o,r,g,n=0;if(this.nKeys===0)return 0;if(this.nKeys===1)return this.keys.value;m=this.firstKey;d=this.lastKey;if(e<m.time)if(r=this.in_behavior,r===c.envelope.behavior.RESET)return 0;
else if(r===c.envelope.behavior.CONSTANT)return m.value;else if(r===c.envelope.behavior.REPEAT)r=q(e,m.time,d.time),e=r[0];else if(r===c.envelope.behavior.OCILLATE)r=q(e,m.time,d.time),e=r[0],r=r[1],r%2&&(e=d.time-m.time-e);else if(r===c.envelope.behavior.OFFSET)r=q(e,m.time,d.time),e=r[0],r=r[1],n=r*(d.value-m.value);else{if(r===c.envelope.behavior.LINEAR)return g=b(m,m.next)/(m.next.time-m.time),g*(e-m.time)+m.value}else if(e>d.time)if(r=this.out_behavior,r===c.envelope.behavior.RESET)return 0;
else if(r===c.envelope.behavior.CONSTANT)return d.value;else if(r===c.envelope.behavior.REPEAT)r=q(e,m.time,d.time),e=r[0];else if(r===c.envelope.behavior.OCILLATE)r=q(e,m.time,d.time),e=r[0],r=r[1],r%2&&(e=d.time-m.time-e);else if(r===c.envelope.behavior.OFFSET)r=q(e,m.time,d.time),e=r[0],r=r[1],n=r*(d.value-m.value);else if(r===c.envelope.behavior.LINEAR)return r=f(d.prev,d)/(d.time-d.prev.time),r*(e-d.time)+d.value;if(this.lastKey0)if(e>this.lastKey0.time)d=this.lastKey0;else if(e<this.lastKey0.time)for(d=
this.lastKey;e<d.time&&d.prev;)d=d.prev;else d=this.keys;else d=this.keys;for(;e>d.next.time;)d=d.next;m=d.next;this.lastKey0=d;if(e===d.time)return d.value+n;else if(e===m.time)return m.value+n;o=(e-d.time)/(m.time-d.time);r=m.shape;if(r===c.envelope.shape.TCB||r===c.envelope.shape.BEZI||r===c.envelope.shape.HERM){g=b(d,m);r=f(d,m);var v,w;w=o*o;v=o*w;e=3*w-v-v;v-=w;e=[1-e,e,v-w+o,v];return e[0]*d.value+e[1]*m.value+e[2]*g+e[3]*r+n}else return r===c.envelope.shape.BEZ2?(e=a(d.time,d.shape===c.envelope.shape.BEZ2?
d.time+d.param[2]:d.time+(m.time-d.time)/3,m.time+m.param[0],m.time,e,0,1),n=h(d.value,d.shape===c.envelope.shape.BEZ2?d.value+d.param[3]:d.value+d.param[1]/3,m.param[1]+m.value,m.value,e)+n):n=r===c.envelope.shape.LINE?d.value+o*(m.value-d.value)+n:r===c.envelope.shape.STEP?d.value+n:n,n}};n.prototype={envelope:function(a,d){this.controllers[a]===g&&(this.controllers[a]=[]);this.controllers[a][d]===g&&(this.controllers[a][d]=new s(this.env_init));return this.controllers[a][d]},evaluate:function(a){var d=
[],b;for(b in this.controllers)if(this.controllers.hasOwnProperty(b)){d[b]=[];for(var c in this.controllers[b])this.controllers[b].hasOwnProperty(c)&&(d[b][c]=this.controllers[b][c].evaluate(a))}return d},apply:function(a,d){for(var b in this.controllers)if(this.controllers.hasOwnProperty(b)){var f=parseInt(b,10);if(this.yzflip&&f===c.motion.ROT){if(!this.q)this.q=new CubicVR.Quaternion;var r=this.q,g=this.controllers[b][0].evaluate(a),h=this.controllers[b][1].evaluate(a),v=this.controllers[b][2].evaluate(a);
r.fromEuler(g,v,-h);r=r.toEuler();d.control(f,0,r[0]);d.control(f,1,r[1]);d.control(f,2,r[2])}else for(var n in this.controllers[b])this.controllers[b].hasOwnProperty(n)&&d.control(f,parseInt(n,10),this.controllers[b][n].evaluate(a))}},setKey:function(a,d,b,c,f){return this.envelope(a,d).addKey(b,c,f?f:this.key_init)},setArray:function(a,d,b,c){var f=[],g;for(g in b)if(b.hasOwnProperty(g)){var h=this.envelope(a,g);f[g]=h.addKey(d,b[g],c?c:this.key_init)}return f},setBehavior:function(a,d,b,c){this.envelope(a,
d).setBehavior(b,c)},setBehaviorArray:function(a,d,b){for(var c in this.controllers[a])this.controllers[a].hasOwnProperty(c)&&this.envelope(a,c).setBehavior(d,b)}};return{Motion:n,Envelope:s,EnvelopeKey:t}});CubicVR.RegisterModule("Octree",function(y){function t(a,c,e,d,m){var o=this._children=[];this._dirty=!1;o[0]=null;o[1]=null;o[2]=null;o[3]=null;o[4]=null;o[5]=null;o[6]=null;o[7]=null;this._child_index=m||-1;this._root=e||null;this._max_depth=c||0;a=this._size=a||0;d=this._position=d||[0,0,0];this._nodes=[];this._lights=[];this._static_lights=[];this._sphere=[d[0],d[1],d[2],Math.sqrt(3*(this._size/2*this._size/2))];c=this._bbox=[[0,0,0],[0,0,0]];e=CubicVR.aabb;e.reset(c,d);a/=2;e.engulf(c,[d[0]+
a,d[1]+a,d[2]+a]);e.engulf(c,[d[0]-a,d[1]-a,d[2]-a]);this._debug_visible=!1}function s(){this.position=[0,0,0];this.visible=!1;this._object=null}function n(){this.last_in=[];this._planes=[];this.sphere=null;for(var a=0;a<6;++a)this._planes[a]=[0,0,0,0]}var g=y.undef,c=CubicVR.plane,q=CubicVR.sphere,h=CubicVR.enums;h.frustum={plane:{LEFT:0,RIGHT:1,TOP:2,BOTTOM:3,NEAR:4,FAR:5}};h.octree={TOP_NW:0,TOP_NE:1,TOP_SE:2,TOP_SW:3,BOTTOM_NW:4,BOTTOM_NE:5,BOTTOM_SE:6,BOTTOM_SW:7};var a=function(a,c,e){e=a.slice((e||
c)+1||a.length);a.length=c<0?a.length+c:c;return a.push.apply(a,e)};t.prototype.destroy=function(){var a,c,e;a=0;for(c=this._static_lights.length;a<c;++a)e=this._static_lights[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null;a=0;for(c=this._lights.length;a<c;++a)e=this._lights[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null;this._lights=this._static_lights=null;a=0;for(c=this._children.length;a<c;++a)this._children[a]!==null&&this._children[a].destroy();a=
0;for(c=this._nodes.length;a<c;++a)e=this._nodes[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null,e.dynamic_lights=[],e.static_lights=[];this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=null;this._children[4]=null;this._children[5]=null;this._children[6]=null;this._bbox=this._sphere=this._static_lights=this._lights=this._nodes=this._position=this._root=this._children=this._children[7]=null};t.prototype.toString=function(){return"[Octree: @"+
this._position+", depth: "+this._max_depth+", size: "+this._size+", nodes: "+this._nodes.length+", measured size:"+[this._bbox[1][0]-this._bbox[0][0],this._bbox[1][2]-this._bbox[0][2]]+"]"};t.prototype.remove=function(b){var c=!1,e=this._nodes.length,d;d=e-1;for(e=this._nodes.length;d>=0;--d)if(b===this._nodes[d]){a(this._nodes,d);this.dirty_lineage();c=!0;break}if(!c)for(d=e-1;d>=0;--d)if(b===this._lights[d]){a(this._lights,d);this.dirty_lineage();break}};t.prototype.dirty_lineage=function(){this._dirty=
!0;this._root!==null&&this._root.dirty_lineage()};t.prototype.cleanup=function(){for(var a=this._children.length,c=0,e=0;e<a;++e){var d=this._children[e];if(d!==null){var m=!0;d._dirty===!0&&(m=d.cleanup());m?++c:this._children[e]=null}}if(this._nodes.length===0&&this._static_lights.length===0&&this._lights.length===0&&(c===0||a===0))return!1;return!0};t.prototype.insert_light=function(a){this.insert(a,!0)};t.prototype.propagate_static_light=function(a){var c,e;c=0;for(e=this._nodes.length;c<e;++c)this._nodes[c].static_lights.indexOf(a)===
-1&&this._nodes[c].static_lights.push(a);for(c=0;c<8;++c)this._children[c]!==null&&this._children[c].propagate_static_light(a)};t.prototype.collect_static_lights=function(a){var c,e;c=0;for(e=this._static_lights.length;c<e;++c)a.static_lights.indexOf(this._static_lights[c])===-1&&a.static_lights.push(this._static_lights[c]);for(c=0;c<8;++c)this._children[c]!==null&&this._children[c].collect_static_lights(a)};t.prototype.insert=function(a,c){function e(a,d,b,c){var m,e;if(b)if(d.method===h.light.method.STATIC){a._static_lights.indexOf(d)===
-1&&a._static_lights.push(d);b=0;for(m=a._nodes.length;b<m;++b)a._nodes[b].static_lights.indexOf(d)===-1&&a._nodes[b].static_lights.push(d);for(e=a._root;e!==null;){b=0;for(l=e._nodes.length;b<l;++b)m=e._nodes[b],m.static_lights.indexOf(d)===-1&&m.static_lights.push(d);e=e._root}}else a._lights.indexOf(d)===-1&&a._lights.push(d);else{a._nodes.push(d);b=0;for(m=a._static_lights.length;b<m;++b)d.static_lights.indexOf(a._static_lights[b])===-1&&d.static_lights.push(a._static_lights[b]);for(e=a._root;e!==
null;){b=0;for(m=e._static_lights.length;b<m;++b){var f=e._static_lights[b];d.static_lights.indexOf(f)===-1&&d.static_lights.push(f)}e=e._root}}d.octree_leaves.push(a);d.octree_common_root=c;c=CubicVR.aabb;c.engulf(d.octree_aabb,a._bbox[0]);c.engulf(d.octree_aabb,a._bbox[1])}c===g&&(c=!1);if(this._root===null)a.octree_leaves=[],a.octree_common_root=null;if(this._max_depth===0)e(this,a,c,this._root);else{var d=this._position,m,o,r,n,z,v,w;o=a.getAABB();w=[o[0][0],o[0][1],o[0][2]];var q=[o[1][0],o[1][1],
o[1][2]];m=w[0]<d[0]&&w[1]<d[1]&&w[2]<d[2];o=q[0]>d[0]&&w[1]<d[1]&&w[2]<d[2];z=w[0]<d[0]&&q[1]>d[1]&&w[2]<d[2];v=q[0]>d[0]&&q[1]>d[1]&&w[2]<d[2];r=w[0]<d[0]&&w[1]<d[1]&&q[2]>d[2];n=q[0]>d[0]&&w[1]<d[1]&&q[2]>d[2];w=w[0]<d[0]&&q[1]>d[1]&&q[2]>d[2];d=q[0]>d[0]&&q[1]>d[1]&&q[2]>d[2];if(m&&o&&z&&v&&r&&n&&w&&d)e(this,a,c,this),c?a.method==h.light.method.STATIC&&this.propagate_static_light(a):this.collect_static_lights(a);else{for(var q=0,s=this._static_lights.length;q<s;++q){if(a.static_lights===g)a.static_lights=
[];a.static_lights.indexOf(this._static_lights[q])===-1&&a.static_lights.push(this._static_lights[q])}var q=this._size/2,s=this._size/4,y=0,x=this._position[0],u=this._position[1],F=this._position[2];m&&(m=[x-s,u-s,F-s],this._children[h.octree.TOP_NW]===null&&(this._children[h.octree.TOP_NW]=new t(q,this._max_depth-1,this,m,h.octree.TOP_NW)),this._children[h.octree.TOP_NW].insert(a,c),++y);o&&(m=[x+s,u-s,F-s],this._children[h.octree.TOP_NE]===null&&(this._children[h.octree.TOP_NE]=new t(q,this._max_depth-
1,this,m,h.octree.TOP_NE)),this._children[h.octree.TOP_NE].insert(a,c),++y);z&&(m=[x-s,u+s,F-s],this._children[h.octree.BOTTOM_NW]===null&&(this._children[h.octree.BOTTOM_NW]=new t(q,this._max_depth-1,this,m,h.octree.BOTTOM_NW)),this._children[h.octree.BOTTOM_NW].insert(a,c),++y);v&&(m=[x+s,u+s,F-s],this._children[h.octree.BOTTOM_NE]===null&&(this._children[h.octree.BOTTOM_NE]=new t(q,this._max_depth-1,this,m,h.octree.BOTTOM_NE)),this._children[h.octree.BOTTOM_NE].insert(a,c),++y);r&&(m=[x-s,u-s,
F+s],this._children[h.octree.TOP_SW]===null&&(this._children[h.octree.TOP_SW]=new t(q,this._max_depth-1,this,m,h.octree.TOP_SW)),this._children[h.octree.TOP_SW].insert(a,c),++y);n&&(m=[x+s,u-s,F+s],this._children[h.octree.TOP_SE]===null&&(this._children[h.octree.TOP_SE]=new t(q,this._max_depth-1,this,m,h.octree.TOP_SE)),this._children[h.octree.TOP_SE].insert(a,c),++y);w&&(m=[x-s,u+s,F+s],this._children[h.octree.BOTTOM_SW]===null&&(this._children[h.octree.BOTTOM_SW]=new t(q,this._max_depth-1,this,
m,h.octree.BOTTOM_SW)),this._children[h.octree.BOTTOM_SW].insert(a,c),++y);d&&(m=[x+s,u+s,F+s],this._children[h.octree.BOTTOM_SE]===null&&(this._children[h.octree.BOTTOM_SE]=new t(q,this._max_depth-1,this,m,h.octree.BOTTOM_SE)),this._children[h.octree.BOTTOM_SE].insert(a,c),++y);if(y>1||a.octree_common_root===null)a.octree_common_root=this}}};t.prototype.draw_on_map=function(a,c,e){function d(a,d,b,e,r){var g=a<b?a:b,h=d<e?d:e,a=a<b?b-a:a-b,d=d<e?e-d:d-e;c.save();if(r!==void 0)c.fillStyle=r,c.fillRect(m+
g,o+h,a,d);c.strokeRect(m+g,o+h,a,d);c.restore()}var m=a.width/2,o=a.height/2,r,h,n,v,w,q,s;if(e===g||e==="map")c.save(),this._debug_visible!==!1?(c.fillStyle="rgba(0,0,0,0)",c.strokeStyle="#FF0000"):(c.fillStyle="rgba(0,0,0,0)",c.strokeStyle="rgba(0,0,0,0)"),c.beginPath(),w=this._size/2,r=this._position[0],h=this._position[2],c.moveTo(m+r-w,m+h-w),c.lineTo(m+r-w,m+h+w),c.lineTo(m+r+w,m+h+w),c.lineTo(m+r+w,m+h-w),c.stroke(),c.fill(),c.restore();if(e===g||e==="objects"){c.save();w=0;for(s=this._nodes.length;w<
s;++w)q=this._nodes[w],c.fillStyle="#5500FF",c.strokeStyle=q.visible===!0&&q.culled===!1?"#FFFFFF":"#000000",c.beginPath(),r=q.aabb[0][0],h=q.aabb[0][2],n=q.aabb[1][0]-r,v=q.aabb[1][2]-h,c.rect(m+r,o+h,n,v),c.stroke();c.restore()}if(e===g||e==="lights"){w=0;for(s=this._lights.length;w<s;++w)v=this._lights[w],c.fillStyle=v.culled===!1&&v.visible===!0?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.0)",c.strokeStyle="#FFFF00",c.beginPath(),q=v.distance,r=v.position[0],h=v.position[2],c.arc(m+r,o+
h,q,0,Math.PI*2,!0),c.closePath(),c.stroke(),c.fill(),c.beginPath(),r=v.aabb[0][0],h=v.aabb[0][2],n=v.aabb[1][0]-r,v=v.aabb[1][2]-h,c.rect(m+r,o+h,n,v),c.closePath(),c.stroke();w=0;for(s=this._static_lights.length;w<s;++w)v=this._static_lights[w],c.fillStyle=v.culled===!1&&v.visible===!0?"rgba(255, 255, 255, 0.01)":"rgba(255, 255, 255, 0.0)",c.strokeStyle="#FF66BB",c.beginPath(),q=v.distance,r=v.position[0],h=v.position[2],c.arc(m+r,o+h,q,0,Math.PI*2,!0),c.closePath(),c.stroke(),c.fill(),c.beginPath(),
r=v.aabb[0][0],h=v.aabb[0][2],n=v.aabb[1][0]-r,v=v.aabb[1][2]-h,c.rect(m+r,o+h,n,v),c.closePath(),c.stroke()}if(e!="lights"&&e!="objects"&&e!="map"){c.save();r=this._nodes;w=0;for(v=r.length;w<v;++w)if(q=r[w],q.name==e){c.strokeStyle="#FFFF00";c.lineWidth=3;c.beginPath();r=q.aabb[0][0];h=q.aabb[0][2];n=q.aabb[1][0]-r;v=q.aabb[1][2]-h;c.rect(m+r,o+h,n,v);c.closePath();c.stroke();r=q.octree_aabb;c.strokeStyle="#0000FF";d(r[0][0],r[0][2],r[1][0],r[1][2]);c.lineWidth=1;if(q.common_root!==null)c.strokeStyle=
"#00FF00";break}c.lineWidth=1;c.strokeStyle="#FFFF00";d(this._bbox[0][0],this._bbox[0][2],this._bbox[1][0],this._bbox[1][2],"#444444");c.fill();c.restore()}w=0;for(s=this._children.length;w<s;++w)this._children[w]!==null&&this._children[w].draw_on_map(a,c,e)};t.prototype.contains_point=function(a){return a[0]<=this._position[0]+this._size/2&&a[1]<=this._position[1]+this._size/2&&a[2]<=this._position[2]+this._size/2&&a[0]>=this._position[0]-this._size/2&&a[1]>=this._position[1]-this._size/2&&a[2]>=
this._position[2]-this._size/2};t.prototype.get_frustum_hits=function(a,c){var e={objects:[],lights:[]};if((c===g||c===!0)&&!this.contains_point(a.position)){if(q.intersects(a.frustum.sphere,this._sphere)===!1)return e;var d=a.frustum.contains_sphere(this._sphere);if(d===-1)return this._debug_visible=!1,e;else if(d===1)this._debug_visible=2,c=!1;else if(d===0)if(this._debug_visible=!0,d=a.frustum.contains_box(this._bbox),d===-1)return this._debug_visible=!1,e;else if(d===1)this._debug_visible=3,c=
!1}var m,o,d=0;for(m=this._nodes.length;d<m;++d)o=this._nodes[d],e.objects.push(o),o.dynamic_lights=[].concat(this._lights),o.was_culled=o.culled,o.culled=!1,o.drawn_this_frame=!1;this._debug_visible=this._lights.length>0?4:this._debug_visible;d=0;for(m=this._lights.length;d<m;++d)if(o=this._lights[d],o.visible===!0)e.lights.push(o),o.was_culled=o.culled,o.culled=!1;d=0;for(m=this._static_lights.length;d<m;++d)if(o=this._static_lights[d],o.visible===!0)o.culled=!1;for(d=0;d<8;++d)if(this._children[d]!==
null){m=this._children[d].get_frustum_hits(a,c);var r;o=0;for(r=m.objects.length;o<r;++o){e.objects.push(m.objects[o]);for(var h=m.objects[o].dynamic_lights,n=0,v=this._lights.length;n<v;++n)h.indexOf(this._lights[n])<0&&h.push(this._lights[n])}o=0;for(r=m.lights.length;o<r;++o)e.lights.indexOf(m.lights[o])<0&&e.lights.push(m.lights[o])}return e};t.prototype.reset_node_visibility=function(){this._debug_visible=!1;var a,c;a=0;for(c=this._nodes.length;a<c;++a)this._nodes[a].culled=!0;a=0;for(c=this._lights.length;a<
c;++a)this._lights[a].culled=!0;a=0;for(c=this._static_lights.length;a<c;++a)this._static_lights[a].culled=!0;a=0;for(c=this._children.length;a<c;++a)this._children[a]!==null&&this._children[a].reset_node_visibility()};s.prototype.toString=function(){return"[OctreeNode "+this.position+"]"};s.prototype.attach=function(a){this._object=a};n.prototype.extract=function(a,f,e){var d=CubicVR.vec3;if(!(f===g||e===g)){var m=CubicVR.mat4.multiply(e,f),f=this._planes;f[h.frustum.plane.LEFT][0]=m[3]+m[0];f[h.frustum.plane.LEFT][1]=
m[7]+m[4];f[h.frustum.plane.LEFT][2]=m[11]+m[8];f[h.frustum.plane.LEFT][3]=m[15]+m[12];f[h.frustum.plane.RIGHT][0]=m[3]-m[0];f[h.frustum.plane.RIGHT][1]=m[7]-m[4];f[h.frustum.plane.RIGHT][2]=m[11]-m[8];f[h.frustum.plane.RIGHT][3]=m[15]-m[12];f[h.frustum.plane.TOP][0]=m[3]-m[1];f[h.frustum.plane.TOP][1]=m[7]-m[5];f[h.frustum.plane.TOP][2]=m[11]-m[9];f[h.frustum.plane.TOP][3]=m[15]-m[13];f[h.frustum.plane.BOTTOM][0]=m[3]+m[1];f[h.frustum.plane.BOTTOM][1]=m[7]+m[5];f[h.frustum.plane.BOTTOM][2]=m[11]+
m[9];f[h.frustum.plane.BOTTOM][3]=m[15]+m[13];f[h.frustum.plane.NEAR][0]=m[3]+m[2];f[h.frustum.plane.NEAR][1]=m[7]+m[6];f[h.frustum.plane.NEAR][2]=m[11]+m[10];f[h.frustum.plane.NEAR][3]=m[15]+m[14];f[h.frustum.plane.FAR][0]=m[3]-m[2];f[h.frustum.plane.FAR][1]=m[7]-m[6];f[h.frustum.plane.FAR][2]=m[11]-m[10];f[h.frustum.plane.FAR][3]=m[15]-m[14];for(var o=0;o<6;++o)c.normalize(f[o]);o=-f[h.frustum.plane.NEAR][3];f=f[h.frustum.plane.FAR][3]-o;e=f*(1/e[5]);e=d.subtract([0,0,o+f*0.5],[e,e,o+f]);e=d.length(e);
m=[m[3],m[9],m[10]];o=d.length(m);m=d.multiply(m,1/o);a=[a.position[0],a.position[1],a.position[2]];a=d.add(a,d.multiply(m,f*0.5));a=d.add(a,d.multiply(m,1));this.sphere=[a[0],a[1],a[2],e]}};n.prototype.contains_sphere=function(a){for(var c=CubicVR.vec3,e=this._planes,d=0;d<6;++d){var m=e[d],m=c.dot([m[0],m[1],m[2]],[a[0],a[1],a[2]])+m.d;this.last_in[d]=1;if(m<-a[3])return-1;if(Math.abs(m)<a[3])return 0}return 1};n.prototype.draw_on_map=function(a,c){var e=a.width/2,d=a.height/2;c.save();for(var m=
this._planes,o=[0,1,4,5],r=0,g=o.length;r<g;++r){var h=m[o[r]];c.strokeStyle="#FF00FF";if(r<this.last_in.length&&this.last_in[r])c.strokeStyle="#FFFF00";var v=-e,n=e,q=(-h[3]-h[0]*n)/h[2];c.moveTo(e+v,d+(-h[3]-h[0]*v)/h[2]);c.lineTo(e+n,d+q);c.stroke()}c.strokeStyle="#0000FF";c.beginPath();c.arc(e+this.sphere[0],d+this.sphere[2],this.sphere[3],0,Math.PI*2,!1);c.closePath();c.stroke();c.restore()};n.prototype.contains_box=function(a){var f=0,e=[];e[0]=a[0];e[1]=[a[0][0],a[0][1],a[1][2]];e[2]=[a[0][0],
a[1][1],a[0][2]];e[3]=[a[0][0],a[1][1],a[1][2]];e[4]=[a[1][0],a[0][1],a[0][2]];e[5]=[a[1][0],a[0][1],a[1][2]];e[6]=[a[1][0],a[1][1],a[0][2]];e[7]=a[1];for(var a=this._planes,d=0;d<6;++d){for(var m=8,o=1,r=0;r<8;++r)c.classifyPoint(a[d],e[r])===-1&&(o=0,--m);this.last_in[d]=o;if(m===0)return-1;f+=o}if(f===6)return 1;return 0};return{Frustum:n,Octree:t}});CubicVR.RegisterModule("Particles",function(y){function t(g,c,n,h,a,b,f){if(g){this.last_particle=this.particles=null;this.pTex=n!==s?n:null;this.vWidth=h;this.vHeight=a;this.alpha=b!==s?b:!1;this.alphaCut=f!==s?f:0;this.pfunc=function(a,d){var b=d-a.start_time;if(b<0)return 0;if(b>a.life_time&&a.life_time)return-1;a.pos[0]=a.startpos[0]+b*a.velocity[0]+b*b*a.accel[0];a.pos[1]=a.startpos[1]+b*a.velocity[1]+b*b*a.accel[1];a.pos[2]=a.startpos[2]+b*a.velocity[2]+b*b*a.accel[2];this.pgov!==null&&this.pgov(a,
d);return 1};this.pgov=null;this.hasColor=c===s?!1:c;n=this.pTex!==null;this.vs=["#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;",this.hasColor?"attribute vec3 aColor;":"","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec4 color;\nvarying vec2 screenPos;",n?"varying float pSize;":"","void main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);",n?"screenPos=vec2(position.x/position.w,position.y/position.w);":"","gl_Position = position;",
this.hasColor?"color = vec4(aColor.r,aColor.g,aColor.b,1.0);":"color = vec4(1.0,1.0,1.0,1.0);",n?"pSize=200.0/position.z;":"float pSize=200.0/position.z;","gl_PointSize = pSize;\n}"].join("\n");this.fs=["#ifdef GL_ES\nprecision highp float;\n#endif",n?"uniform sampler2D pMap;":"","varying vec4 color;",n?"varying vec2 screenPos;":"",n?"uniform vec3 screenDim;":"",n?"varying float pSize;":"","void main(void) {\nvec4 c = color;",n?"vec2 screen=vec2((gl_FragCoord.x/screenDim.x-0.5)*2.0,(gl_FragCoord.y/screenDim.y-0.5)*2.0);":
"",n?"vec2 pointCoord=vec2( ((screen.x-screenPos.x)/(pSize/screenDim.x))/2.0+0.5,((screen.y-screenPos.y)/(pSize/screenDim.y))/2.0+0.5);":"",n?"vec4 tc = texture2D(pMap,pointCoord); gl_FragColor = vec4(c.rgb*tc.rgb,1.0);":"gl_FragColor = c;","}"].join("\n");this.maxPoints=g;this.numParticles=0;this.arPoints=new Float32Array(g*3);this.glPoints=null;if(c)this.arColor=new Float32Array(g*3),this.glColor=null;this.shader_particle=new CubicVR.Shader(this.vs,this.fs);this.shader_particle.use();this.shader_particle.addVertexArray("aVertexPosition");
this.hasColor&&this.shader_particle.addVertexArray("aColor");this.shader_particle.addMatrix("uMVMatrix");this.shader_particle.addMatrix("uPMatrix");this.pTex!==null&&(this.shader_particle.addInt("pMap",0),this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[h,a,0]));this.genBuffer()}}var s=y.undef,n=y.GLCore;t.prototype={resizeView:function(g,c){this.vWidth=g;this.vHeight=c;this.pTex!==null&&(this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",
[g,c,0]))},addParticle:function(g){this.last_particle===null?this.particles=g:this.last_particle.nextParticle=g;this.last_particle=g},genBuffer:function(){var g=n.gl;this.glPoints=g.createBuffer();g.bindBuffer(g.ARRAY_BUFFER,this.glPoints);g.bufferData(g.ARRAY_BUFFER,this.arPoints,g.DYNAMIC_DRAW);if(this.hasColor)this.glColor=g.createBuffer(),g.bindBuffer(g.ARRAY_BUFFER,this.glColor),g.bufferData(g.ARRAY_BUFFER,this.arColor,g.DYNAMIC_DRAW)},updatePoints:function(){var g=n.gl;g.bindBuffer(g.ARRAY_BUFFER,
this.glPoints);g.bufferData(g.ARRAY_BUFFER,this.arPoints,g.DYNAMIC_DRAW)},updateColors:function(){var g=n.gl;this.hasColor&&(g.bindBuffer(g.ARRAY_BUFFER,this.glColor),g.bufferData(g.ARRAY_BUFFER,this.arColor,g.DYNAMIC_DRAW))},draw:function(g,c,q){var h=n.gl;this.shader_particle.use();this.pTex!==null&&this.pTex.use(h.TEXTURE0);this.shader_particle.setMatrix("uMVMatrix",g);this.shader_particle.setMatrix("uPMatrix",c);h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null);h.bindBuffer(h.ARRAY_BUFFER,this.glPoints);
h.vertexAttribPointer(this.shader_particle.uniforms.aVertexPosition,3,h.FLOAT,!1,0,0);h.enableVertexAttribArray(this.shader_particle.uniforms.aVertexPosition);this.hasColor&&(h.bindBuffer(h.ARRAY_BUFFER,this.glColor),h.vertexAttribPointer(this.shader_particle.uniforms.aColor,3,h.FLOAT,!1,0,0),h.enableVertexAttribArray(this.shader_particle.uniforms.aColor));if(q!==s){this.numParticles=0;if(this.particles===null){h.disable(h.BLEND);return}for(var g=this.particles,c=null,a=0;g!==null;){var b=this.numParticles*
3,f=this.pfunc(g,q);if(f===1){if(this.arPoints[b]=g.pos[0],this.arPoints[b+1]=g.pos[1],this.arPoints[b+2]=g.pos[2],g.color!==null&&this.arColor!==s&&(this.arColor[b]=g.color[0],this.arColor[b+1]=g.color[1],this.arColor[b+2]=g.color[2]),this.numParticles++,a++,this.numParticles===this.maxPoints)break}else if(f===-1){if(c!==null)c.nextParticle=g.nextParticle}else f===0&&a++;c=g;g=g.nextParticle}if(!a)this.last_particle=this.particles=null;this.updatePoints();this.hasColor&&this.updateColors()}this.alpha&&
(h.enable(h.BLEND),h.enable(h.DEPTH_TEST),h.depthMask(0),h.blendFunc(h.ONE,h.ONE_MINUS_SRC_COLOR));h.drawArrays(h.POINTS,0,this.numParticles);this.alpha&&(h.disable(h.BLEND),h.depthMask(1),h.blendFunc(h.ONE,h.ONE));this.hasColor&&h.disableVertexAttribArray(this.shader_particle.uniforms.aColor)}};return{ParticleSystem:t,Particle:function(g,c,n,h,a){this.startpos=new Float32Array(g);this.pos=new Float32Array(g);this.velocity=new Float32Array(h!==s?h:[0,0,0]);this.accel=new Float32Array(a!==s?a:[0,0,
0]);this.start_time=c!==s?c:0;this.life_time=n!==s?n:0;this.nextParticle=this.color=null}}});CubicVR.RegisterModule("PostProcess",function(y){function t(a){if(a.shader_vertex===g)return null;if(a.shader_fragment===g)return null;this.outputMode=a.outputMode===g?q.post.output.REPLACE:a.outputMode;this.onresize=a.onresize===g?null:a.onresize;this.onupdate=a.onupdate===g?null:a.onupdate;this.init=a.init===g?null:a.init;this.enabled=a.enabled===g?!0:a.enabled;this.outputDivisor=a.outputDivisor===g?1:a.outputDivisor;this.shader=new CubicVR.Shader(a.shader_vertex,a.shader_fragment);this.shader.use();
this.shader.addUVArray("aTex");this.shader.addVertexArray("aVertex");this.shader.addInt("srcTex",0);this.shader.addInt("captureTex",1);this.shader.addVector("texel");this.init!==null&&this.init(this.shader)}function s(a,f,e){var d=c.gl;this.width=a;this.height=f;this.accum=e===g?!1:!0;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer=new CubicVR.RenderBuffer(a,f,!0);this.bufferA=new CubicVR.RenderBuffer(a,f,!1);this.bufferB=new CubicVR.RenderBuffer(a,f,!1);this.bufferC=new CubicVR.RenderBuffer(a,
f,!1);this.accumOpacity=1;this.accumIntensity=0.3;if(this.accum)this.accumBuffer=new CubicVR.RenderBuffer(a,f,!1),this.accumBuffer.use(),d.clearColor(0,0,0,1),d.clear(d.COLOR_BUFFER_BIT),this.blur_shader=new t({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{ gl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}",
init:function(a){a.addFloat("opacity");a.setFloat("opacity",1)}});this.bufferA.use();d.clearColor(0,0,0,1);d.clear(d.COLOR_BUFFER_BIT);this.bufferB.use();d.clearColor(0,0,0,1);d.clear(d.COLOR_BUFFER_BIT);this.end();this.fsQuad=this.makeFSQuad(this.width,this.height);this.shaders=[];this.copy_shader=new t({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void) {\ngl_FragColor = texture2D(srcTex, vTex);\n}"});
this.resize(a,f)}function n(a,c,e){this.createBuffer(a,c,e)}var g=y.undef,c=y.GLCore,q=CubicVR.enums;q.post={output:{REPLACE:0,BLEND:1,ADD:2,ALPHACUT:3}};var h=[],a=[];s.prototype={setBlurOpacity:function(a){this.accumOpacity=a},setBlurIntensity:function(a){this.accumIntensity=a},makeFSQuad:function(a,f){var e=c.gl,d=[],m=a/a,o=f/f;d.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);d.vbo_uvs=new Float32Array([0,0,m,0,m,o,0,o,0,0,m,o]);d.gl_points=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,
d.gl_points);e.bufferData(e.ARRAY_BUFFER,d.vbo_points,e.STATIC_DRAW);d.gl_uvs=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,d.gl_uvs);e.bufferData(e.ARRAY_BUFFER,d.vbo_uvs,e.STATIC_DRAW);return d},destroyFSQuad:function(a){var f=c.gl;f.deleteBuffer(a.gl_points);f.deleteBuffer(a.gl_uvs)},renderFSQuad:function(a,f){var e=c.gl;a.use();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);e.bindBuffer(e.ARRAY_BUFFER,f.gl_points);e.vertexAttribPointer(a.aVertex,3,e.FLOAT,!1,0,0);e.enableVertexAttribArray(a.aVertex);
e.bindBuffer(e.ARRAY_BUFFER,f.gl_uvs);e.vertexAttribPointer(a.aTex,2,e.FLOAT,!1,0,0);e.enableVertexAttribArray(a.aTex);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);e.drawArrays(e.TRIANGLES,0,6)},addShader:function(b){this.shaders[this.shaders.length]=b;b.shader.use();b.shader.setVector("texel",this.vTexel);if(b.outputDivisor&&b.outputDivisor!=1&&h[b.outputDivisor]===g){var c=this.width/b.outputDivisor|0,e=this.height/b.outputDivisor|0;h[b.outputDivisor]=new CubicVR.RenderBuffer(c,e,!1);a[b.outputDivisor]=
this.makeFSQuad(c,e)}},resize:function(b,f){var e=c.gl;this.width=b;this.height=f;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer.destroyBuffer();this.captureBuffer.createBuffer(this.width,this.height,!0);this.bufferA.destroyBuffer();this.bufferA.createBuffer(this.width,this.height,!1);this.bufferB.destroyBuffer();this.bufferB.createBuffer(this.width,this.height,!1);this.bufferC.destroyBuffer();this.bufferC.createBuffer(this.width,this.height,!1);this.accum&&(this.accumBuffer.destroyBuffer(),
this.accumBuffer.createBuffer(this.width,this.height,!1),this.accumBuffer.use(),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT));for(var d in h){var e=this.width/d|0,m=this.height/d|0;h[d].destroyBuffer();h[d].createBuffer(e,m,!1);this.destroyFSQuad(a[d]);a[d]=this.makeFSQuad(e,m)}this.inputBuffer=this.bufferA;this.outputBuffer=this.bufferB;d=0;for(e=this.shaders.length;d<e;d++)if(this.shaders[d].shader.use(),this.shaders[d].shader.setVector("texel",this.vTexel),this.shaders[d].onresize!==null)this.shaders[d].onresize(this.shaders[d].shader,
this.width,this.height);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(this.width,this.height)},swap:function(){var a=this.inputBuffer;this.inputBuffer=this.outputBuffer;this.outputBuffer=a},begin:function(){this.captureBuffer.use()},end:function(){var a=c.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)},render:function(){var b=c.gl;this.captureBuffer.texture.use(b.TEXTURE1);this.outputBuffer.use();this.captureBuffer.texture.use(b.TEXTURE0);b.clearColor(0,0,0,1);b.clear(b.COLOR_BUFFER_BIT);
this.renderFSQuad(this.copy_shader.shader,this.fsQuad);this.end();for(var f=0,e=0,d=this.shaders.length;e<d;e++){var m=this.shaders[e];if(m.enabled){this.swap();this.inputBuffer.texture.use(b.TEXTURE0);var o=m.outputMode;if(o===q.post.output.REPLACE)m.outputDivisor!==1?h[m.outputDivisor].use():this.outputBuffer.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT);else if(o===q.post.output.ADD||o===q.post.output.BLEND)m.outputDivisor!==1?h[m.outputDivisor].use():this.bufferC.use(),b.clearColor(0,
0,0,1),b.clear(b.COLOR_BUFFER_BIT);m.onupdate!==null&&(m.shader.use(),m.onupdate(m.shader));m.outputDivisor!==1?(b.viewport(0,0,h[m.outputDivisor].width,h[m.outputDivisor].height),this.renderFSQuad(m.shader,a[m.outputDivisor]),m.outputMode===q.post.output.REPLACE?(this.outputBuffer.use(),h[m.outputDivisor].texture.use(b.TEXTURE0),b.viewport(0,0,this.width,this.height),this.renderFSQuad(this.copy_shader.shader,this.fsQuad)):b.viewport(0,0,this.width,this.height)):this.renderFSQuad(m.shader,this.fsQuad);
o===q.post.output.BLEND?(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE_MINUS_SRC_ALPHA),this.inputBuffer.texture.use(b.TEXTURE0),m.outputDivisor!==1?h[m.outputDivisor].texture.use(b.TEXTURE0):this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND)):o===q.post.output.ADD&&(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE),m.outputDivisor!==1?h[m.outputDivisor].texture.use(b.TEXTURE0):
this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND));this.end();f++}}f===0?this.captureBuffer.texture.use(b.TEXTURE0):this.outputBuffer.texture.use(b.TEXTURE0);this.accum&&this.accumOpacity!==1?(this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumOpacity),this.accumBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),this.end(),b.disable(b.BLEND),
this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumIntensity),this.accumBuffer.texture.use(b.TEXTURE0),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),b.disable(b.BLEND)):this.renderFSQuad(this.copy_shader.shader,this.fsQuad)}};n.prototype={createBuffer:function(a,f,e){this.texture=this.depth=this.fbo=null;this.width=parseInt(a,10);this.height=
parseInt(f,10);var a=this.sizeParam(a),f=this.sizeParam(f),d=c.gl;this.fbo=d.createFramebuffer();if(e)this.depth=d.createRenderbuffer();d.bindFramebuffer(d.FRAMEBUFFER,this.fbo);e&&(d.bindRenderbuffer(d.RENDERBUFFER,this.depth),navigator.appVersion.indexOf("Windows")!==-1?(d.renderbufferStorage(d.RENDERBUFFER,d.DEPTH_COMPONENT16,a,f),d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_ATTACHMENT,d.RENDERBUFFER,this.depth)):(d.renderbufferStorage(d.RENDERBUFFER,d.DEPTH_STENCIL,a,f),d.framebufferRenderbuffer(d.FRAMEBUFFER,
d.DEPTH_STENCIL_ATTACHMENT,d.RENDERBUFFER,this.depth)));this.texture=new CubicVR.Texture;d.bindTexture(d.TEXTURE_2D,y.Textures[this.texture.tex_id]);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,a,f,0,d.RGBA,d.UNSIGNED_BYTE,null);d.framebufferTexture2D(d.FRAMEBUFFER,
d.COLOR_ATTACHMENT0,d.TEXTURE_2D,y.Textures[this.texture.tex_id],0);d.bindFramebuffer(d.FRAMEBUFFER,null)},destroyBuffer:function(){var a=c.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteRenderbuffer(this.depth);a.deleteFramebuffer(this.fbo);a.deleteTexture(y.Textures[this.texture.tex_id]);y.Textures[this.texture.tex_id]=null},sizeParam:function(a){return a},use:function(){var a=c.gl;a.bindFramebuffer(a.FRAMEBUFFER,this.fbo)}};return{RenderBuffer:n,PostProcessShader:t,PostProcessChain:s,fsQuad:{make:s.prototype.makeFSQuad,
destroy:s.prototype.destroyFSQuad,render:s.prototype.renderFSQuad}}});CubicVR.RegisterModule("Polygon",function(y){function t(a){var b=[],c=a.length;if(c<3)return null;var f=[],g;g=a.length;for(var h=0,v=g-1,n=0;n<g;v=n++)h+=a[v][0]*a[n][1]-a[n][0]*a[v][1];if(0<h*0.5)for(g=0;g<c;g++)f[g]=g;else for(g=0;g<c;g++)f[g]=c-1-g;n=2*c;h=0;for(g=c-1;c>2;){if(0>=n--)return null;var q=g;c<=q&&(q=0);g=q+1;c<=g&&(g=0);v=g+1;c<=v&&(v=0);var s;a:{s=a;var t=q,x=g,u=v,y=c,D=f,B=void 0,U=void 0,K=void 0,E=void 0,G=void 0,H=void 0,N=void 0,I=void 0,R=void 0,U=s[D[t]][0],K=s[D[t]][1],
E=s[D[x]][0],G=s[D[x]][1],H=s[D[u]][0],N=s[D[u]][1];if(e>(E-U)*(N-K)-(G-K)*(H-U))s=!1;else{for(B=0;B<y;B++)if(!(B==t||B==x||B==u)){var I=s[D[B]][0],R=s[D[B]][1],W=void 0,L=void 0,P=void 0,M=void 0,S=void 0,Y=void 0,Z=void 0,Q=void 0,$=void 0,T=void 0,V=void 0,X=void 0,W=P=S=void 0,W=H-E,L=N-G,P=U-H,M=K-N,S=E-U,Y=G-K,Z=I-U,Q=R-K,$=I-E,T=R-G,V=I-H,X=R-N,W=W*T-L*$,S=S*Q-Y*Z,P=P*X-M*V;if(W>=0&&P>=0&&S>=0){s=!1;break a}}s=!0}}if(s){n=f[q];q=f[g];v=f[v];b.push(n);b.push(q);b.push(v);h++;v=g;for(n=g+1;n<
c;v++,n++)f[v]=f[n];c--;n=2*c}}return b}function s(a,b,c){c===f&&(c=0);var e;e=t(b);var g=CubicVR.util.repackArray(e,3,e.length/3),h=[],v=a.points.length;e=0;for(iMax=b.length;e<iMax;e++)h.push([b[e][0],b[e][1],c]);a.addPoint(h);e=0;for(iMax=g.length;e<iMax;e++)a.addFace([g[e][0]+v,g[e][1]+v,g[e][2]+v])}function n(a,b){var c=b[0]-a[0],e=b[1]-a[1];return Math.sqrt(c*c+e*e)}function g(a,b){var c,e,f=[],g=a.length,h=b.length,w=[];for(c=0;c<g;c++)for(e=0;e<h;e++){var q=n(a[c],b[e]);f.push([q,c,e])}f.sort(function(a,
d){return a[0]>d[0]});for(c=0;c<5;c++)for(e=0;e<f.length;e++)c!=e&&f[c][1]!=f[e][1]&&f[c][2]!=f[e][2]&&f[c][1]<f[e][1]&&f[c][2]<f[e][2]&&Math.abs(f[c][1]-f[e][1])<4&&Math.abs(f[c][2]-f[e][2])<4&&w.push([c,e]);w.sort(function(a,d){return f[a[0]][0]+f[a[1]][0]>f[d[0]][0]+f[d[1]][0]});if(w.length>10)w.length=10;e=[];for(c=0;c<w.length;c++)e.push([f[w[c][0]],f[w[c][1]]]);return e}function c(a,b){var c=g(a,b),e;if(!c.length)return null;e=c[0][0];var f=c[0][1],c=f[1]-e[1],f=f[2]-e[2],h=a.slice(e[1]),h=
h.concat(a.slice(0,e[1])),v=b.slice(e[2]),v=v.concat(b.slice(0,e[2])),n=[];for(e=c;e<h.length;e++)n.push(h[e]);n.push(h[0]);for(e=f;e<v.length;e++)n.push(v[e]);n.push(v[0]);var q=[];for(e=0;e<=c;e++)q.push(h[e]);for(e=0;e<=f;e++)q.push(v[e]);return[n,q]}function q(a){for(var b=[0,0],c=0;c<a.length;c++)b[0]+=a[c][0],b[1]+=a[c][1];b[0]/=a.length;b[1]/=a.length;return b}function h(a,b,c){for(var e=[],f=0;f<a.length;f++){var g=[a[f][0]-b[0],a[f][1]-b[1]],h=Math.sqrt(g[0]*g[0]+g[1]*g[1])+c,g=Math.atan2(g[1],
g[0]);e[f]=[b[0]+Math.cos(g)*h,b[1]+Math.sin(g)*h]}return e}function a(a,b,c,e,f){var g,h=a.points.length;if(b.length!=c.length)return null;var n=b.length;for(g=0;g<n;g++)a.addPoint([b[g][0],b[g][1],e]);for(g=0;g<n;g++)a.addPoint([c[g][0],c[g][1],f]);for(g=0;g<n-1;g++)a.addFace([h+g,h+g+1,h+(g+n+1),h+(g+n)]);g=n-1;a.addFace([h+g,h,h+n,h+(g+n)])}function b(a){this.points=a;this.cuts=[];this.result=[]}var f=y.undef,e=1.0E-10;b.prototype={cut:function(a){this.cuts.push(a)},toMesh:function(a){if(this.points.length!==
0){var b;a||(a=new CubicVR.Mesh);this.result=[this.points];for(b=0;b<this.cuts.length;b++){var e=this.cuts[b].points.slice(0),e=e.reverse(),e=c(this.result[0],e);this.result[0]=e[0];this.result.push(e[1])}for(b=0;b<this.result.length;b++)s(a,this.result[b]);a.removeDoubles();return a}},toExtrudedMesh:function(d,b,e){if(this.points.length!==0){var g,h;b===f&&(b=0);e===f&&(e=0);var n=b!=e;d||(d=new CubicVR.Mesh);this.result=[this.points];for(h=0;h<this.cuts.length;h++)g=this.cuts[h].points.slice(0),
g=g.reverse(),g=c(this.result[0],g),this.result[0]=g[0],this.result.push(g[1]);g=new CubicVR.Mesh;for(h=0;h<this.result.length;h++)s(g,this.result[h],e);d.booleanAdd(g);g.flipFaces();if(n)for(h=0;h<g.points.length;h++)g.points[h][2]=b;d.booleanAdd(g);if(n){a(d,this.points,this.points,b,e);for(h=0;h<this.cuts.length;h++)g=this.cuts[h].points.slice(0),g=g.reverse(),a(d,g,g,b,e)}d.removeDoubles();return d}},toExtrudedBeveledMesh:function(d,b,e,f,g,n,v){var w=[],C=[],t,y,x,u;if(this.points.length!==0){typeof b===
"object"&&(v=b,b=v.front||0,e=v.back||0,f=v.frontDepth||0,g=v.frontShift||0,n=v.backDepth||0,v=v.backShift||0);var F=b!==e,D=n!==0,B=f!==0;d||(d=new CubicVR.Mesh);B?(y=q(this.points),y=h(this.points,y,-g),this.result=[y.slice(0)]):this.result=[this.points.slice(0)];for(u=0;u<this.cuts.length;u++)x=q(this.cuts[u].points),x=h(this.cuts[u].points,x,g),x=x.reverse(),w.push(x),x=c(this.result[0],x),this.result[0]=x[0],this.result.push(x[1]);g=new CubicVR.Mesh;for(u=0;u<this.result.length;u++)s(g,this.result[u],
b-f);g.flipFaces();d.booleanAdd(g);if(D||B){t=q(this.points);t=h(this.points,t,-v);this.result=[t.slice(0)];for(u=0;u<this.cuts.length;u++)x=q(this.cuts[u].points),x=h(this.cuts[u].points,x,v),x=x.reverse(),C.push(x),x=c(this.result[0],x),this.result[0]=x[0],this.result.push(x[1]);g=new CubicVR.Mesh;for(u=0;u<this.result.length;u++)s(g,this.result[u],e+n)}else{for(u=0;u<g.points.length;u++)g.points[u][2]=e;g.flipFaces()}d.booleanAdd(g);B&&a(d,y,this.points,b-f,b);F&&a(d,this.points,this.points,b,
e);D&&a(d,this.points,t,e,e+n);for(u=0;u<w.length;u++)x=this.cuts[u].points.slice(0).reverse(),B&&a(d,w[u],x,b-f,b),F&&a(d,x,x,b,e),D&&a(d,x,C[u],e,e+n);d.removeDoubles();return d}}};return{polygon:{triangulate2D:t,toMesh:s,findNearPair:function(a,b){for(var c=[0,0],e=n(a[0],b[0]),f=a.length,g=b.length,h=0;h<f;h++)for(var w=0;w<g;w++){var q=n(a[h],b[w]);q<e&&(c[0]=h,c[1]=w,e=q)}return c},subtract:c,addOffset:function(a,b){for(var c=[],e=0,f=a.length;e<f;e++){var g=a[e];c.push([g[0]+b[0],g[1]+b[1]])}return c}},
Polygon:b}});CubicVR.RegisterModule("Primitives",function(y){function t(c,d,m,f,g,h){var n=CubicVR.mat4,v=CubicVR.vec3,w=[],q,s=[0,1,0],t=[1,0,0],x=[0,0,0],u=c.points.length,y,D,B;for(y=q=0;y<b;y+=b/m){if(q===m)break;t=[Math.cos(y),0,Math.sin(y)];D=0;for(B=d.length;D<B;D++)x=v.add(v.multiply(t,d[D][0]),v.multiply(s,d[D][1])),w[q]===a&&(w[q]=[]),w[q].push(x);q++}B=null;g!==a&&(B=g.getResult!==a?g.getResult():g);for(D=0;D<m;D++){g=0;for(q=d.length;g<q;g++)B?c.addPoint(n.vec3_multiply(w[D][g],B)):c.addPoint(w[D][g])}c.setFaceMaterial(f);
for(g=0;g<m;g++){D=0;for(B=d.length-1;D<B;D++)n=D+d.length*g,w=D+d.length*((g+1)%m),v.equal(c.points[u+n],c.points[u+w])?c.addFace([u+n+1,u+w+1,u+w]):v.equal(c.points[u+n+1],c.points[u+w+1])?c.addFace([u+n,u+n+1,u+w]):c.addFace([u+n,u+n+1,u+w+1,u+w])}h!==a&&(d=null,h.apply!==a?d=h:h&&(d=new CubicVR.UVMapper(h)),d!==null&&(c.calcFaceNormals(),d.apply(c,f)))}function s(b,d,c,f,g){var h=CubicVR.mat4;d*=0.5;var n=b.points.length;b.setFaceMaterial(c);f!==a?(f=f.getResult!==a?f.getResult():f,b.addPoint([h.vec3_multiply([d,
-d,0],f),h.vec3_multiply([d,d,0],f),h.vec3_multiply([-d,d,0],f),h.vec3_multiply([-d,-d,0],f)])):b.addPoint([[d,-d,0],[d,d,0],[-d,d,0],[-d,-d,0]]);b.addFace([[n+0,n+1,n+2,n+3],[n+3,n+2,n+1,n+0]]);g!==a&&(h=null,g.apply!==a?h=g:g&&(h=new CubicVR.UVMapper(g)),h!==null&&(b.calcFaceNormals(),h.apply(b,c)))}function n(b,d,c,f,g){var h=CubicVR.mat4,n,v;typeof d==="object"?(n=d[0]/2,v=d[1]/2,d=d[2]/2):n=v=d/=2;var q=b.points.length;b.setFaceMaterial(c);f!==a?(f=f.getResult!==a?f.getResult():f,b.addPoint([h.vec3_multiply([n,
-v,d],f),h.vec3_multiply([n,v,d],f),h.vec3_multiply([-n,v,d],f),h.vec3_multiply([-n,-v,d],f),h.vec3_multiply([n,-v,-d],f),h.vec3_multiply([n,v,-d],f),h.vec3_multiply([-n,v,-d],f),h.vec3_multiply([-n,-v,-d],f)])):b.addPoint([[n,-v,d],[n,v,d],[-n,v,d],[-n,-v,d],[n,-v,-d],[n,v,-d],[-n,v,-d],[-n,-v,-d]]);b.addFace([[q+0,q+1,q+2,q+3],[q+7,q+6,q+5,q+4],[q+4,q+5,q+1,q+0],[q+5,q+6,q+2,q+1],[q+6,q+7,q+3,q+2],[q+7,q+4,q+0,q+3]]);g!==a&&(h=null,g.apply!==a?h=g:g&&(h=new CubicVR.UVMapper(g)),h!==null&&(b.calcFaceNormals(),
h.apply(b,c)))}function g(a,d,c,f,g,h,n,v){var q=[];c-=d;d+=c/2;for(var s=b/g,t=0,y=0;y<=g;y++)q.push([d+Math.cos(t)*c,Math.sin(t)*c,0]),t+=s;CubicVR.genLatheObject(a,q,f,h,n,v)}function c(a,d,b,c,f,g,h){CubicVR.genLatheObject(a,[[0,-b/2,0],[d/2,-b/2,0],[0,b/2,0]],c,f,g,h)}function q(a,d,b,c,f,g,h){CubicVR.genLatheObject(a,[[0,-b/2,0],[d,-b/2,0],[d,b/2,0],[0,b/2,0]],c,f,g,h)}function h(a,d,b,c,g,h,n){var v=[],c=(c/=2)|0;b|=0;for(var q=Math.PI/c,s=-f,t=0;t<=c;t++)v.push([Math.cos(s)*d,Math.sin(s)*
d,0]),s+=q;CubicVR.genLatheObject(a,v,b,g,h,n)}var a=y.undef,b=2*Math.PI,f=Math.PI/2;return{genPlaneObject:s,genBoxObject:n,genLatheObject:t,genTorusObject:g,genConeObject:c,genCylinderObject:q,genSphereObject:h,primitives:{lathe:function(b){var d,c;if(b.points==a)return null;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);c=b.material!==a?b.material:new CubicVR.Material;t(d,b.points,b.divisions!==a?b.divisions:24,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d},box:function(b){var d,
c;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);c=b.material!==a?b.material:new CubicVR.Material;n(d,b.size!==a?b.size:1,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d},plane:function(b){var d,c;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);c=b.material!==a?b.material:new CubicVR.Material;s(d,b.size!==a?b.size:1,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d},sphere:function(b){var d,c;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==
a?b.name:a);c=b.material!==a?b.material:new CubicVR.Material;h(d,b.radius!==a?b.radius:1,b.lon!==a?b.lon:24,b.lat!==a?b.lat:24,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d},torus:function(b){var d,c;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);c=b.material!==a?b.material:new CubicVR.Material;g(d,b.innerRadius!==a?b.innerRadius:0.75,b.outerRadius!==a?b.outerRadius:1,b.lon!==a?b.lon:24,b.lat!==a?b.lat:24,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:
a);return d},cone:function(b){var d,f;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);f=b.material!==a?b.material:new CubicVR.Material;c(d,b.base!==a?b.base:1,b.height!==a?b.height:1,b.lon!==a?b.lon:24,f,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d},cylinder:function(b){var d,c;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);c=b.material!==a?b.material:new CubicVR.Material;q(d,b.radius!==a?b.radius:1,b.height!==a?b.height:1,b.lon!==a?b.lon:24,c,b.transform!==
a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d}}}});CubicVR.RegisterModule("Renderer",function(y){var t=y.undef;return{renderObject:function(s,n,g,c,q,h){var a=!1,q=q||!1,h=h||!1;if(s.compiled!==null){var b=0,f=CubicVR.GLCore.gl,e,d=c===t?0:c.length,m,o=0,r,A=null,z=s.instanceMaterials||s.materials,v=!1,w,C,J;f.depthFunc(f.LEQUAL);g===t&&(g=cubicvr_identity);for(var O=0,x=s.compiled.elements_ref.length;O<x;O++){var A=z[O],u=0;e=!1;if(A.opacity<1&&q)a=!0;else if(!(h&&A.opacity>=1)){A.opacity!==1?(f.enable(f.BLEND),f.depthMask(0),f.blendFunc(f.SRC_ALPHA,
f.ONE_MINUS_SRC_ALPHA)):(f.depthMask(1),f.disable(f.BLEND),f.blendFunc(f.ONE,f.ONE));for(var F=0,D=s.compiled.elements_ref[O].length;F<D;F++)if(r=s.compiled.elements_ref[O][F][0],e=!1,o=s.compiled.elements_ref[O][F][1],u+=o,!s.segment_state[r])if(u>o){b+=o*2;u-=o;if(d){C=!1;for(w=0;w<d;){e=d-w;if(e>y.MAX_LIGHTS)e=y.MAX_LIGHTS;w>0&&!C&&(f.enable(f.BLEND),f.blendFunc(f.ONE,f.ONE),f.depthFunc(f.EQUAL),C=!0);m=c[w];J=m.light_type;for(o=0;o<e;o++)if(c[o+w].light_type!=J){e=o;break}A.use(m.light_type,e);
m=A.shader[m.light_type][e];f.uniformMatrix4fv(m.uMVMatrix,!1,n.mvMatrix);f.uniformMatrix4fv(m.uPMatrix,!1,n.pMatrix);f.uniformMatrix4fv(m.uOMatrix,!1,g);f.uniformMatrix3fv(m.uNMatrix,!1,n.nMatrix);v||(A.bindObject(s,m),v=m.aTextureCoord!=-1);for(o=0;o<e;o++)c[o+w].setupShader(m,o);f.drawElements(f.TRIANGLES,u,f.UNSIGNED_SHORT,b);w+=e}C&&(f.disable(f.BLEND),f.depthFunc(f.LEQUAL))}else A.use(0,0),f.uniformMatrix4fv(A.shader[0][0].uMVMatrix,!1,n.mvMatrix),f.uniformMatrix4fv(A.shader[0][0].uPMatrix,
!1,n.pMatrix),f.uniformMatrix4fv(A.shader[0][0].uOMatrix,!1,g),f.uniformMatrix3fv(A.shader[0][0].uNMatrix,!1,n.nMatrix),v||(A.bindObject(s,A.shader[0][0]),v=A.shader[0][0].aTextureCoord!=-1),f.drawElements(f.TRIANGLES,u,f.UNSIGNED_SHORT,b);b+=u*2;u=0;e=!0}else b+=u*2,u=0;if(!e&&s.segment_state[r]){if(d){C=!1;for(w=0;w<d;){e=d-w;if(e>y.MAX_LIGHTS)e=y.MAX_LIGHTS;w>0&&!C&&(f.enable(f.BLEND),f.blendFunc(f.ONE,f.ONE),f.depthFunc(f.EQUAL),C=!0);m=c[w];J=m.light_type;for(o=0;o<e;o++)if(c[o+w].light_type!=
J){e=o;break}A.use(m.light_type,e);m=A.shader[m.light_type][e];f.uniformMatrix4fv(m.uMVMatrix,!1,n.mvMatrix);f.uniformMatrix4fv(m.uPMatrix,!1,n.pMatrix);f.uniformMatrix4fv(m.uOMatrix,!1,g);f.uniformMatrix3fv(m.uNMatrix,!1,n.nMatrix);v||(A.bindObject(s,m),v=m.aTextureCoord!=-1);for(o=0;o<e;o++)c[o+w].setupShader(m,o);f.drawElements(f.TRIANGLES,u,f.UNSIGNED_SHORT,b);w+=e}C&&(f.disable(f.BLEND),f.depthFunc(f.LEQUAL))}else A.use(0,0),f.uniformMatrix4fv(A.shader[0][0].uMVMatrix,!1,n.mvMatrix),f.uniformMatrix4fv(A.shader[0][0].uPMatrix,
!1,n.pMatrix),f.uniformMatrix4fv(A.shader[0][0].uOMatrix,!1,g),f.uniformMatrix3fv(A.shader[0][0].uNMatrix,!1,n.nMatrix),v||(A.bindObject(s,A.shader[0][0]),v=A.shader[0][0].aTextureCoord!=-1),f.drawElements(f.TRIANGLES,u,f.UNSIGNED_SHORT,b);b+=u*2}}}A&&m?A.clearObject(s,m):A.clearObject(s,null);f.depthMask(1);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null);return a}}}});CubicVR.RegisterModule("EventHandler",function(y){function t(c){c=c||{};this.name=c.name;this.id=c.id;this.interval=c.interval||0;this.enabled=c.enabled||!0;this.action=c.action||null;this.properties=c.properties||{};this.event_properties=c.event_properties||{};this.buffered=c.buffered||!1;this.weight=c.weight===n?-1:c.weight;this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0;this.break_chain=!1}function s(){this.events=[];this.eventProperties=
[];this.eventPropertyCount=[];this.eventHandled=[];this.listeners=[];this.listenerNames=[];this.eventParameters=[]}var n=y.undef,g=CubicVR.enums;g.event={TICK:"tick",MOVE:"move",MATRIX_UPDATE:"matrixUpdate",OCTREE_ADJUST:"octreeAdjust",COLLIDE:"collide",CONTACT:"contact",CONTACT_ADD:"contactAdd",CONTACT_REMOVE:"contactRemove",CONTACT_GHOST:"contactGhost",RIGID_REST:"rigidRest",RIGID_AWAKE:"rigidAwake"};t.prototype={getName:function(){return this.name},setName:function(c){this.name=c},getId:function(){return this.id},
setId:function(c){this.id=c},isEnabled:function(){return this.enabled},disable:function(){this.setEnabled(!1)},enable:function(){this.setEnabled(!0)},setEnabled:function(c){if(c&&!this.enabled)this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0,this.break_chain=!1;this.enabled=c},isBuffered:function(){return this.buffered},setBuffered:function(c){this.buffered=c},setInterval:function(c){this.interval=c},getInterval:function(){return this.interval},
setAction:function(c){this.action=c},getAction:function(){return this.action},getProperties:function(){return this.properties},setProperties:function(c){this.properties=c},getProperty:function(c){return this.properties[c]},setProperty:function(c,g){this.properties[c]=g},setEventProperties:function(c){this.event_properties=c},getEventProperties:function(){return this.event_properties},getEventProperty:function(c){return this.event_properties[c]},setEventProperty:function(c,g){this.properties[c]=g},
getTimeSleeping:function(){return this.t_sleep},getTimeActive:function(){return this.t_active},getTimeUpdated:function(){return this.t_update},getRestInterval:function(){return this.t_rest},getLastUpdateSeconds:function(){return this.t_last},setRestInterval:function(c){this.t_rest=c},getUpdateCount:function(){return this.n_updates},breakChain:function(){this.break_chain=!0},isChainBroken:function(){return this.break_chain},rest:function(c){this.setRestInterval(c||0)},awake:function(){this.t_rest=
0},update:function(c,g){if(!this.enabled)return!1;var h=0,a=!0;if(this.n_updates===0)this.t_updatecall=this.t_update=c,h=1/60;else if(c!==this.t_update){if(!this.t_rest)this.t_last=c-this.t_update,this.t_update=c;h=c-this.t_updatecall;this.t_updatecall=c}else a=!1;if(this.t_rest>0){if(a&&(this.t_resting+=h,this.t_rest-=h,this.t_rest<0))this.t_rest=0}else{if(a){this.t_active+=this.t_last;if(!this.t_rest&&this.interval)this.t_rest=this.interval;this.n_updates++}this.callEvent(g);return!0}a&&this.n_updates++;
return!1},callEvent:function(c){if(!this.action)return!1;return this.action(this,c)}};s.prototype={addEvent:function(c){c.callEvent||(c=new t(c));var g=c.getId();this.eventProperties[g]||(this.eventProperties[g]={});this.listeners[g]=this.listeners[g]||0;this.listeners[g]++;this.events.push(c);this.listenerNames.indexOf(g)===-1&&this.listenerNames.push(g);return c},removeEvent:function(c){if(this.lockState){if(!this.lockRemovals)this.lockRemovals=[];this.lockRemovals.indexOf(c)==-1&&this.lockRemovals.push(c)}else{var g=
this.events.indexOf(c);g!==-1&&(c=c.getId(),this.events.splice(g,1),this.listeners[c]--,this.listeners[c]||(this.eventHandled[c]=!0,this.eventParameters[c]={},this.eventProperties[c]=[],this.eventPropertyCount[c]=0,g=this.listenerNames.indexOf(c),g>=0&&this.listenerNames.splice(g,1)))}},getProperties:function(c){this.eventParameters[c]=this.eventParameters[c]||{};return this.eventParameters[c]},setProperties:function(c,g){this.eventParameters[c]=g},getProperty:function(c,g){return this.getProperties(c)[g]},
setProperty:function(c,g,h){this.getProperties(c)[g]=h},hasEvent:function(c){return!!this.listeners[c]},triggerEvent:function(c,g){if(!this.listeners[c])return null;this.eventProperties[c]==n&&(this.eventProperties[c]=[]);var h=this.eventProperties[c];this.eventPropertyCount[c]===n&&(this.eventPropertyCount[c]=0);var a=this.eventPropertyCount[c];a>20&&console.log("Warning, event "+c+" count > 20: "+a);h[a]=g&&h?g:h[a]||{};this.eventPropertyCount[c]++;this.eventHandled[c]=!1;return h[a]},update:function(c){var n,
h,a,b,f,e;if(this.hasEvent(g.event.TICK)&&this.eventPropertyCount[g.event.TICK]===0&&(n=this.triggerEvent(g.event.TICK)))n.time=c,n.handler=this;this.lockState=!0;n=0;for(h=this.events.length;n<h;n++){f=this.events[n];e=f.getId();b=this.eventPropertyCount[e];var d=!1;a=!1;if(b){var m=this.eventProperties[e];if(f.isEnabled()){if(f.isBuffered()){if(m.length=b,f.setEventProperties(m),d=d||f.update(c,this),f.isChainBroken()){f.breakChain(!1);break}}else for(a=0;a<b;a++)if(f.setEventProperties(m[n]),d=
d||f.update(c,this),f.isChainBroken()){f.breakChain(!1);break}a=!0}}if(d||!a)this.eventHandled[e]=!0}n=0;for(h=this.listenerNames.length;n<h;n++)e=this.listenerNames[n],this.eventHandled[e]&&(this.eventPropertyCount[e]=0);this.lockState=!1;if(this.lockRemovals&&this.lockRemovals.length){n=0;for(h=this.lockRemovals.length;n<h;n++)this.removeEvent(this.lockRemovals[n]);this.lockRemovals.length=0}}};return{Event:t,EventHandler:s}});CubicVR.RegisterModule("Scene",function(y){function t(a,b){return a.light_type-b.light_type}function s(d,f){var e=null;d!==c&&d!==null&&(e=d.compile?null:d);e?(this.morphWeight=e.morphWeight||0,this.morphSource=e.morphSource||-1,this.morphTarget=e.morphTarget||-1,this.position=e.position===c?[0,0,0]:e.position,this.rotation=e.rotation===c?[0,0,0]:e.rotation,this.scale=e.scale===c?[1,1,1]:e.scale,this.shadowCast=e.shadowCast===c?!0:e.shadowCast,this.motion=e.motion===c?null:e.motion,this.obj=e.mesh===
c?d!==c&&e.faces!==c?d:null:e.mesh,this.name=e.name===c?f!==c?f:null:e.name,this.properties=e.properties||{}):(this.position=[0,0,0],this.rotation=[0,0,0],this.scale=[1,1,1],this.motion=null,this.obj=d,this.name=f,this.shadowCast=!0,this.properties={});this.parent=this.children=null;this.drawn_this_frame=!1;this.lposition=[0,0,0];this.lrotation=[0,0,0];this.lscale=[0,0,0];this.lMatrix=b.identity();this.tMatrix=b.identity();this.dirty=!0;this.aabb=[];this.id=-1;this.octree_leaves=[];this.octree_common_root=
null;this.octree_aabb=[[0,0,0],[0,0,0]];a.reset(this.octree_aabb,[0,0,0]);this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.dynamic_lights=[];this.static_lights=[];this.matrixLock=!1;this.eventHandler=this.instanceMaterials=null}function n(a,b,c,f,g,h){this.frames=0;this.sceneObjects=[];this.sceneObjectsByName=[];this.sceneObjectsById=[];this.lights=[];this.global_lights=[];this.dynamic_lights=[];this.pickables=[];this.stats=[];this.cameras=[];this.camerasByName=[];this.shadows_updated=
this.collect_stats=!1;typeof a==="object"?(this.octree=a.octree,this.skybox=a.skybox||null,this.camera=new CubicVR.Camera(a.width,a.height,a.fov,a.nearclip,a.farclip),this.name=a.name||"scene"+e,this.destroy=a.destroy||function(){},this.update=a.update||function(){},this.enable=a.enable||function(){},this.disable=a.disable||function(){},a=a.setup&&a.setup(this),this.update=a.update||this.update,this.enable=a.enable||this.enable,this.disable=a.disable||this.disable,this.destroy=a.destroy||this.destroy):
(this.skybox=null,this.octree=h,this.camera=new CubicVR.Camera(a,b,c,f,g),this.name="scene"+e);this.paused=!1;++e}function g(){this.meshBin={};this.imageBin={};this.meshMap={};this.imageMap={};this.imageBinPtr={};this.meshBinPtr={}}var c=y.undef,q=CubicVR.enums,h=y.GLCore,a=CubicVR.aabb,b=CubicVR.mat4,f=0;s.prototype={addEvent:function(a){if(!this.eventHandler)this.eventHandler=new CubicVR.EventHandler;return this.eventHandler.addEvent(a)},hasEvents:function(){return!!this.eventHandler},getEventHandler:function(){return this.eventHandler},
setMesh:function(a){this.obj=a},getMesh:function(){return this.obj},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a},getProperty:function(a){return this.properties[a]},setProperty:function(a,b){this.properties[a]=b},getInstanceMaterials:function(){if(!this.obj)return null;if(this.instanceMaterials)return this.instanceMaterials;this.instanceMaterials=[];for(var a=0,b=this.obj.materials.length;a<b;a++)this.instanceMaterials[a]=this.obj.materials[a].clone();
return this.instanceMaterials},getInstanceMaterial:function(a){for(var b=this.getInstanceMaterials(),c=0,f=b.length;c<f;c++)if(b[c].name==a)return b[c];return null},setMorphSource:function(a){this.morphSource=a},setMorphTarget:function(a){this.morphTarget=a},getMorphSource:function(){return this.morphSource},getMorphTarget:function(){return this.morphTarget},setMorphWeight:function(a){this.morphWeight=a},morphTargetCount:function(){return this.obj.morphTargets!==null?this.obj.morphTargets.length:
0},setMatrix:function(a){if(a){if(this.tMatrix=a.slice(0),this.matrixLock=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(q.event.MATRIX_UPDATE)))a.triggerEvent(q.event.MATRIX_UPDATE).matrix=this.tMatrix}else this.matrixLock=!1},doTransform:function(a){var f=CubicVR.vec3;if(!this.matrixLock&&(!f.equal(this.lposition,this.position)||!f.equal(this.lrotation,this.rotation)||!f.equal(this.lscale,this.scale)||a!==c))if(a!==c?this.tMatrix=a.slice(0):b.identity(this.tMatrix),b.identity(this.lMatrix),
b.translate(this.position[0],this.position[1],this.position[2],this.lMatrix),b.rotate(this.rotation[0],this.rotation[1],this.rotation[2],this.lMatrix),this.scale[0]===1&&this.scale[1]===1&&this.scale[2]===1||b.scale(this.scale[0],this.scale[1],this.scale[2],this.lMatrix),b.multiply(this.tMatrix.slice(0),this.lMatrix,this.tMatrix),this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],this.lposition[2]=this.position[2],this.lrotation[0]=this.rotation[0],this.lrotation[1]=this.rotation[1],
this.lrotation[2]=this.rotation[2],this.lscale[0]=this.scale[0],this.lscale[1]=this.scale[1],this.lscale[2]=this.scale[2],this.dirty=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(q.event.MOVE)))a=a.triggerEvent(q.event.MOVE),a.oldPosition=this.lposition,a.position=this.position,a.oldRotation=this.lrotation,a.rotation=this.rotation,a.oldScale=this.lscale,a.scale=this.scale},adjust_octree:function(){var b=this.getAABB(),f=this.octree_aabb,e=b[0][0],g=b[0][1],h=b[0][2],n=b[1][0],v=b[1][1],
q=b[1][2],s=f[0][0],t=f[0][1],y=f[0][2],x=f[1][0],u=f[1][1],f=f[1][2];if(this.octree_leaves.length>0&&(e<s||g<t||h<y||n>x||v>u||q>f)){for(e=0;e<this.octree_leaves.length;++e)this.octree_leaves[e].remove(this);this.octree_leaves=[];this.static_lights=[];e=this.octree_common_root;this.octree_common_root=null;if(e!==null){for(;;)if(!e.contains_point(b[0])||!e.contains_point(b[1]))if(e._root!==c&&e._root!==null)e=e._root;else break;else break;a.reset(this.octree_aabb,this.position);e.insert(this)}}},
bindChild:function(a){if(this.children===null)this.children=[];a.parent=this;this.children.push(a)},control:function(a,b,c){a===q.motion.POS?this.position[b]=c:a===q.motion.SCL?this.scale[b]=c:a===q.motion.ROT&&(this.rotation[b]=c)},getAABB:function(){var a=CubicVR.mat4,b=CubicVR.vec3;if(this.dirty){var f=Array(8);this.doTransform();var e,g;if(this.obj){if(!this.obj.bb)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,1],this.position)];e=this.obj.bb[0];g=this.obj.bb[1]}if(!this.obj||e===
c||g===c)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,1],this.position)];var h=e;e=b.subtract(g,e);f[0]=[h[0],h[1],h[2]];f[1]=[h[0],h[1],h[2]+e[2]];f[2]=[h[0]+e[0],h[1],h[2]];f[3]=[h[0]+e[0],h[1],h[2]+e[2]];f[4]=[h[0],h[1]+e[1],h[2]];f[5]=[h[0],h[1]+e[1],h[2]+e[2]];f[6]=[h[0]+e[0],h[1]+e[1],h[2]];f[7]=[h[0]+e[0],h[1]+e[1],h[2]+e[2]];h=a.vec3_multiply(f[0],this.tMatrix);e=[h[0],h[1],h[2]];g=[h[0],h[1],h[2]];for(b=1;b<8;++b)h=a.vec3_multiply(f[b],this.tMatrix),e[0]>h[0]&&(e[0]=h[0]),
e[1]>h[1]&&(e[1]=h[1]),e[2]>h[2]&&(e[2]=h[2]),g[0]<h[0]&&(g[0]=h[0]),g[1]<h[1]&&(g[1]=h[1]),g[2]<h[2]&&(g[2]=h[2]);this.aabb[0]=e;this.aabb[1]=g;this.dirty=!1}return this.aabb}};var e=0;n.prototype={attachOctree:function(b){this.octree=b;b.init&&b.init(this);b=this.lights;this.lights=[];for(var e=0,g=b.length;e<g;e++)this.bindLight(b[e]);b=this.sceneObjects;if(this.octree!==c){e=0;for(g=b.length;e<g;++e){var h=b[e];if(h.obj!==null){if(h.id<0)h.id=f,++f;this.sceneObjectsById[h.id]=h;a.reset(h.octree_aabb,
h.position);this.octree.insert(h);(h.octree_common_root===void 0||h.octree_common_root===null)&&log("!!",h.name,"octree_common_root is null")}}}},setSkyBox:function(a){this.skybox=a},getSceneObject:function(a){return this.sceneObjectsByName[a]},bindSceneObject:function(b,e,g){if(this.sceneObjects.indexOf(b)==-1){this.sceneObjects.push(b);e!==c&&e&&this.pickables.push(b);b.name!==null&&(this.sceneObjectsByName[b.name]=b);if(this.octree!==c&&(g===c||g==="true")){if(b.id<0)b.id=f,++f;this.sceneObjectsById[b.id]=
b;a.reset(b.octree_aabb,b.position);this.octree.insert(b)}if(b.children)for(var h=0,n=b.children.length;h<n;h++)this.bindSceneObject(b.children[h],e,g);return b}},removeLight:function(a){a=this.lights.indexOf(a);a>=0&&this.lights.splice(a,1)},removeSceneObject:function(a){var b;if(this.lockState){if(!this.lockRemovals)this.lockRemovals=[];this.lockRemovals.indexOf(a)==-1&&this.lockRemovals.push(a)}else if(b=this.sceneObjects.indexOf(a),b>=0&&this.sceneObjects.splice(b,1),b=this.pickables.indexOf(a),
b>=0&&this.pickables.splice(b,1),a.name!==null&&this.sceneObjectsByName[a.name]!==c&&delete this.sceneObjectsByName[a.name],a.children){b=0;for(var e=a.children.length;b<e;b++)this.removeSceneObject(a.children[b])}},bindLight:function(a,b){this.lights.push(a);if(this.octree!==c&&(b===c||b==="true"))a.method===q.light.method.GLOBAL?this.global_lights.push(a):(a.method===q.light.method.DYNAMIC&&this.dynamic_lights.push(a),this.octree.insert_light(a));this.lights=this.lights.sort(t)},bindCamera:function(a){this.cameras.indexOf(a)===
-1&&(this.cameras.push(a),this.camerasByName[a.name]=a);this.camera=a},removeCamera:function(a){typeof a!=="object"&&(a=this.getCamera(camName));this.cameras.indexOf(a)===-1&&(this.cameras.push(a),this.camerasByName[a.name]=a);return a},setCamera:function(a){if(a)typeof a!=="object"&&(a=this.getCamera(a)),this.camera=a},getCamera:function(a){if(a===c)return this.camera;return this.camerasByName[a]},evaluate:function(a){var b,c;b=0;for(c=this.sceneObjects.length;b<c;b++)this.sceneObjects[b].motion&&
this.sceneObjects[b].motion.apply(a,this.sceneObjects[b]);if(this.camera.motion!==null){if(this.camera.targetSceneObject!==null)this.camera.target=this.camera.targetSceneObject.position;this.camera.motion.apply(a,this.camera)}b=0;for(c=this.lights.length;b<c;b++){var e=this.lights[b];e.motion!==null&&e.motion.apply(a,e)}},prepareTransforms:function(a){var b,c;if(a){if(a.doTransform(),a.children){b=0;for(c=a.children.length;b<c;b++)a.children[b].doTransform(a.tMatrix),this.prepareTransforms(a.children[b])}}else if(this.sceneObjects.length!==
0){b=0;for(c=this.sceneObjects.length;b<c;++b)this.prepareTransforms(this.sceneObjects[b])}},updateShadows:function(a){var b=h.gl;if(this.shadows_updated)return!1;else a||this.doTransform(),this.shadows_updated=!0;if(y.features.lightShadows){for(var a=!1,c=b.getParameter(b.VIEWPORT),e=0,f=this.lights.length;e<f;e++){var g=this.lights[e];if(g.light_type==q.light.type.SPOT_SHADOW||g.light_type==q.light.type.SPOT_SHADOW_PROJECTOR||g.light_type==q.light.type.AREA){var a=!0,n=[new CubicVR.Light(q.light.type.DEPTH_PACK)];
if(g.light_type===q.light.type.AREA)g.areaCam=this.camera,g.updateAreaLight();h.shadow_near=g.dummyCam.nearclip;h.shadow_far=g.dummyCam.farclip;g.shadowBegin();for(var w=0,s=this.sceneObjects.length;w<s;w++){var t=this.sceneObjects[w];t.parent||t.visible===!1||t.shadowCast===!1||this.renderSceneObject(t,g.dummyCam,n,!1,!0)}g.shadowEnd()}}a&&b.viewport(c[0],c[1],c[2],c[3])}},updateCamera:function(){this.camera.manual===!1&&(this.camera.targeted?this.camera.lookat(this.camera.position[0],this.camera.position[1],
this.camera.position[2],this.camera.target[0],this.camera.target[1],this.camera.target[2],0,1,0):this.camera.calcProjection());h.depth_alpha_near=this.camera.nearclip;h.depth_alpha_far=this.camera.farclip},resize:function(a,b){this.camera&&this.camera.setDimensions(a,b)},doTransform:function(){for(var a=this.octree!==c,b=0,e=this.sceneObjects.length;b<e;b++){var f=this.sceneObjects[b];if(f.parent===null&&(this.prepareTransforms(f),a&&(lights=[],f.dirty&&f.obj!==null&&f.adjust_octree(),!(f.visible===
!1||a&&(f.ignore_octree||f.drawn_this_frame===!0||f.culled===!0)))))lights=f.dynamic_lights,lights=lights.concat(f.static_lights),lights=lights.concat(this.global_lights),this.collect_stats&&(lights_rendered=Math.max(lights.length,lights_rendered),lights_rendered===lights.length&&(lights_list=lights),++objects_rendered),lights=lights.length===0?[h.emptyLight]:lights.sort(t),f.drawn_this_frame=!0}},renderSceneObject:function(a,b,e,f,g,h,n){var q=!1,f=f!==c&&f,g=g||!1,h=h||!1;if(a.visible&&a.obj){a.scale[0]<
0&&(q=!q);a.scale[1]<0&&(q=!q);a.scale[2]<0&&(q=!q);q&&gl.cullFace(gl.FRONT);var s=a.obj;if(s.morphTargets!==null&&(a.morphSource!==-1&&s.setMorphSource(a.morphSource),a.morphTarget!==-1&&s.setMorphTarget(a.morphTarget),a.morphWeight!==null))s.morphWeight=a.morphWeight;a.instanceMaterials&&s.bindInstanceMaterials(a.instanceMaterials);CubicVR.renderObject(s,b,a.tMatrix,e,g,h)&&n&&n.push(a);a.instanceMaterials&&s.bindInstanceMaterials(null);q&&gl.cullFace(gl.BACK)}a=a.children;if(f&&a){f=0;for(q=a.length;f<
q;f++)this.renderSceneObject(a[f],b,e,!0,g,h,n)}},runEvents:function(a){var b,c;this.lockState=!0;a.getSeconds&&(a=a.getSeconds());b=0;for(c=this.sceneObjects.length;b<c;b++){var f=this.sceneObjects[b];f.hasEvents()&&f.getEventHandler().update(a)}this.lockState=!1;if(this.lockRemovals){b=0;for(c=this.lockRemovals.length;b<c;b++)this.removeSceneObject(this.lockRemovals[b])}this.lockRemovals=null},render:function(){++this.frames;var a=h.gl,f;f=0;if(this.octree!==c)this.octree.reset_node_visibility(),
this.octree.cleanup(),f=this.octree.get_frustum_hits(this.camera),f=f.lights.length;this.doTransform();this.updateCamera();this.updateShadows(!0);this.shadows_updated=!1;var e,g;e=0;for(g=this.lights.length;e<g;e++)this.lights[e].prepare(this.camera);var n=[],q=[],v=this.lights;e=0;for(g=this.sceneObjects.length;e<g;e++){var s=this.sceneObjects[e];s.visible===!1||s.parent!==null||this.renderSceneObject(s,this.camera,v,!0,!0,!1,q)}e=0;for(g=q.length;e<g;e++)this.renderSceneObject(q[e],this.camera,
v,!1,!1,!0);if(this.collect_stats)this.stats["objects.num_rendered"]=0,this.stats["lights.num_rendered"]=f,this.stats["lights.rendered"]=n,this.stats["lights.num_global"]=this.global_lights.length,this.stats["lights.num_dynamic"]=this.dynamic_lights.length;if(this.skybox!==null&&this.skybox.ready===!0)a.cullFace(a.FRONT),f=this.camera.farclip*2/Math.sqrt(3),this.skybox.scene_object.position=this.camera.parent?b.vec3_multiply(this.camera.position,this.camera.parent.tMatrix):[this.camera.position[0],
this.camera.position[1],this.camera.position[2]],this.skybox.scene_object.scale=[f,f,f],this.skybox.scene_object.doTransform(),CubicVR.renderObject(this.skybox.scene_object.obj,this.camera,this.skybox.scene_object.tMatrix,[]),a.cullFace(a.BACK)},bbRayTest:function(a,b,c){var f=CubicVR.vec3,e=[],b=b.length===2?this.camera.unProject(b[0],b[1]):f.add(a,b),g;for(g in this.pickables)if(this.pickables.hasOwnProperty(g)){var h=this.pickables[g];if(h.visible===!0){var n,q;q=h.getAABB();n=q[0];q=q[1];q[0]-
n[0]<0.2&&(n[0]-=0.1,q[0]+=0.1);q[1]-n[1]<0.2&&(n[1]-=0.1,q[1]+=0.1);q[2]-n[2]<0.2&&(n[2]-=0.1,q[2]+=0.1);var s=f.multiply(f.add(n,q),0.5),t=f.getClosestTo(a,b,s),s=f.length(f.subtract(t,s));(t[0]>=n[0]&&t[0]<=q[0]?1:0)+(t[1]>=n[1]&&t[1]<=q[1]?1:0)+(t[2]>=n[2]&&t[2]<=q[2]?1:0)>=c&&e.push({dist:s,obj:h})}}e.length&&e.sort(function(a,b){if(a.dist==b.dist)return 0;return a.dist<b.dist?-1:1});return e}};g.prototype={addMesh:function(a,b,f){this.meshBin[a]===c&&(this.meshBin[a]=[],this.meshBinPtr[a]===
c&&(this.meshBinPtr[a]=0));this.meshMap[b]===c&&(this.meshMap[b]=f,this.meshBin[a].push(f))},addImage:function(a,b,f){this.imageBin[a]===c&&(this.imageBin[a]=[],this.imageBinPtr[a]===c&&(this.imageBinPtr[a]=0));this.imageMap[b]===c&&(this.imageMap[b]=f,this.imageBin[a].push(f))},getMeshes:function(a){return this.meshBin[a]},getImages:function(a){return this.imageBin[a]},rewindMeshes:function(a){this.meshBinPtr[a]=0},rewindImages:function(a){this.imageBinPtr[a]=0},getNextMesh:function(a){var b=this.meshBinPtr[a];
if(b<this.meshBin[a].length)return this.meshBinPtr[a]++,this.meshBin[a][b];return null},loadNextMesh:function(a){a=this.getNextMesh(a);if(a!==null)return a.compiled===null&&(a.triangulateQuads(),a.compile(),a.clean()),!0;return!1},isMeshBinEmpty:function(a){return this.meshBinPtr[a]===this.meshBin[a].length},loadNextImage:function(a){a=this.getNextImage(a);if(a!==null)a.src=a.deferredSrc},getNextImage:function(a){var b=this.imageBinPtr[a];if(b<this.imageBin[a].length)return this.imageBinPtr[a]++,
this.imageBin[a][b];return null},isImageBinEmpty:function(a){return this.imageBinPtr[a]===this.imageBin[a].length}};return{Scene:n,SceneObject:s,SkyBox:function(a){var b=a.texture,a=a.mapping,c=this;this.mapping=null;this.ready=!1;this.texture=null;this.onready=function(){b.onready=null;var a=1/y.Images[c.texture.tex_id].width;if(c.mapping===null)c.mapping=[[1/3,0.5,2/3-a,1],[0,0.5,1/3,1],[0,0,1/3-a,0.5],[2/3,0,1,0.5],[2/3+a,0.5,1,1],[1/3,0,2/3,0.5]];var a=new CubicVR.Material({name:"skybox",textures:{color:b}}),
d=new CubicVR.Mesh;d.sky_mapping=c.mapping;CubicVR.primitives.box({mesh:d,size:1,material:a,uvmapper:{projectionMode:CubicVR.enums.uv.projection.SKY,scale:[1,1,1]}});d.prepare();c.scene_object=new CubicVR.SceneObject(d);c.ready=!0};if(b){if(typeof b==="string")b=new CubicVR.Texture(b,null,null,null,this.onready);else if(!b.loaded)b.onready=this.onready;this.texture=b;if(a)this.mapping=a,this.onready()}},DeferredBin:g}});CubicVR.RegisterModule("ScenePhysics",function(y){function t(a,b){b.setX(a[0]);b.setY(a[1]);b.setZ(a[2])}function s(a,b){b.setX(a.x);b.setY(a.y);b.setZ(a.z);b.setW(a.w)}function n(a,b){b.x=a.x();b.y=a.y();b.z=a.z();b.w=a.w()}function g(a){return new Ammo.btVector3(a[0],a[1],a[2])}function c(a){var b=new Ammo.btQuaternion;b.setEulerZYX(a[2]*(Math.PI/180),a[1]*(Math.PI/180),a[0]*(Math.PI/180));return b}function q(a){return[a.x(),a.y(),a.z()]}function h(a){this.setManifold(a)}var a=y.undef,b=CubicVR.enums,
f=y.nop;b.physics={body:{STATIC:0,DYNAMIC:1,GHOST:2,SOFT:3},constraint:{P2P:0},collision_flags:{STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32},rigid_flags:{DISABLE_WORLD_GRAVITY:1},collision_types:{COLLISION_OBJECT:1,RIGID_BODY:2,GHOST_OBJECT:3,SOFT_BODY:4,HF_FLUID:5}};var e,d,m,o,r,y=function(a,b){var d={};if(!a.position&&a.sceneObject)d=a,a=a.sceneObject,b=d.properties;this.properties=new CubicVR.RigidProperties(b?
b:{});this.collisionEvents=[];this.parent=null;this.init_position=a.position.slice(0);this.init_rotation=a.rotation.slice(0);this.init_linearVelocity=this.linearVelocity=d.linearVelocity||[0,0,0];this.init_angularVelocity=this.angularVelocity=d.angularVelocity||[0,0,0];this.init_impulse=this.impulse=d.impulse||[0,0,0];this.init_impulsePosition=this.impulsePosition=d.impulsePosition||[0,0,0];this.collision_flags=this.rigid_flags=null;this.sceneObject=a;this.transform=new Ammo.btTransform;this.transform.setIdentity();
this.transform.setOrigin(g(this.init_position));this.transform.setRotation(c(this.init_rotation));this.shape=null;this.motionState=new Ammo.btDefaultMotionState(this.transform);this.localInertia=new Ammo.btVector3(0,0,0);this.ghost=this.body=this.bodyInit=null;this.noDeactivate=!1};y.prototype={getProperties:function(){return this.properties},getSceneObject:function(){return this.sceneObject},getInitialPosition:function(){return this.init_position},getInitialRotation:function(){return this.init_rotation},
setInitialPosition:function(){this.init_position=init_position_in},setInitialRotation:function(){this.init_rotation=init_rotation_in},getType:function(){return this.properties.type},getMass:function(){return this.properties.mass},getRestitution:function(){return this.properties.restitution},getCollisionMap:function(){return this.properties.collision},setMass:function(a){this.properties.mass=a},setRestitution:function(a){this.restitution=a},getBody:function(){if(!this.body&&!this.ghost){var a=this.getCollisionShape();
this.getType()===b.physics.body.GHOST?(this.body=null,this.ghost=new Ammo.btGhostObject,this.ghost.setCollisionShape(a),this.ghost.setWorldTransform(this.transform),this.ghost._cvr_rigidbody=this):(this.getMass()&&a.calculateLocalInertia(this.getMass(),this.localInertia),this.bodyInit=new Ammo.btRigidBodyConstructionInfo(this.getMass(),this.motionState,a,this.localInertia),this.friction&&this.bodyInit.set_m_friction(this.friction),this.body=new Ammo.btRigidBody(this.bodyInit),this.getRestitution()&&
this.body.setRestitution(this.getRestitution()),t(this.linearVelocity,o),this.body.setLinearVelocity(o),t(this.angularVelocity,o),this.body.setAngularVelocity(o),CubicVR.vec3.equal([0,0,0],this.impulse)||(t(this.impulse,o),t(this.impulsePosition,r),this.body.applyImpulse(o,r)),this.rigid_flags&&this.body.setFlags(this.rigid_flags),this.collision_flags&&this.body.setFlags(this.collision_flags),this.body._cvr_rigidbody=this)}return this.body||this.ghost},updateSceneObject:function(a){if(this.body&&
(this.body.isActive()||a))return this.body.getMotionState().getWorldTransform(e),a=e.getOrigin(),a.x!=a.x?console.log("origin is NaN"):(this.sceneObject.position[0]=a.x(),this.sceneObject.position[1]=a.y(),this.sceneObject.position[2]=a.z()),a=e.getRotation(),d.x=a.x(),d.y=a.y(),d.z=a.z(),d.w=a.w(),d.x!=d.x?console.log("rotation is NaN"):(a=d.toEuler(),this.sceneObject.rotation[0]=a[0],this.sceneObject.rotation[1]=a[1],this.sceneObject.rotation[2]=a[2]),!0},reset:function(){if(this.body){var a=this.body.getWorldTransform().getOrigin();
t(this.init_position,a);var a=this.body.getWorldTransform().getRotation(),b=this.init_rotation;d.fromEuler(b[0],b[1],b[2]);a.setX(this.init_rotation[0]);a.setY(this.init_rotation[1]);a.setZ(this.init_rotation[2]);a.setW(this.init_rotation[3]);this.resetMotion();this.activate()}},resetMotion:function(){t(this.init_linearVelocity,o);this.body.setLinearVelocity(o);t(this.init_angularVelocity,o);this.body.setAngularVelocity(o);CubicVR.vec3.equal([0,0,0],this.init_impulse)||(t(this.init_impulse,o),t(this.init_impulsePosition,
r),this.body.applyImpulse(o,r))},getCollisionShape:function(){if(!this.shape){var a;a=this.getCollisionMap();if(a.getResult())a=a.getResult();else{var d=a.getShapes(),h,m,n,o,q,r,s,z=[];r=null;m=0;for(n=d.length;m<n;m++){h=d[m];r=null;if(h.type===b.collision.shape.BOX)r=new Ammo.btBoxShape(new Ammo.btVector3(h.size[0]/2,h.size[1]/2,h.size[2]/2));else if(h.type===b.collision.shape.SPHERE)r=new Ammo.btSphereShape(h.radius);else if(h.type===b.collision.shape.CAPSULE)r=new Ammo.btCapsuleShape(h.radius,
h.height);else if(h.type===b.collision.shape.CYLINDER)r=new Ammo.btCylinderShape(new Ammo.btVector3(h.size[0]/2,h.size[1]/2,h.size[2]/2));else if(h.type===b.collision.shape.CONE)r=new Ammo.btConeShape(h.radius,h.height);else if(h.type===b.collision.shape.MESH){s=h.mesh;var A=new Ammo.btTriangleMesh;r=h.size;var y=new Ammo.btVector3(0,0,0),E=new Ammo.btVector3(0,0,0),G=new Ammo.btVector3(0,0,0);o=0;for(q=s.faces.length;o<q;o++){var H=s.faces[o];H.points.length===3&&(y.setValue(s.points[H.points[0]][0]*
r[0],s.points[H.points[0]][1]*r[1],s.points[H.points[0]][2]*r[2]),E.setValue(s.points[H.points[1]][0]*r[0],s.points[H.points[1]][1]*r[1],s.points[H.points[1]][2]*r[2]),G.setValue(s.points[H.points[2]][0]*r[0],s.points[H.points[2]][1]*r[1],s.points[H.points[2]][2]*r[2]),A.addTriangle(y,E,G))}this.getMass()===0||this.getType()==b.physics.body.STATIC||this.getType()==b.physics.body.GHOST?(this.setMass(0),r=new Ammo.btBvhTriangleMeshShape(A,!0)):r=new Ammo.btConvexTriangleMeshShape(A,!0)}else if(h.type===
b.collision.shape.CONVEX_HULL){s=h.mesh;A=new Ammo.btVector3(0,0,0);r=new Ammo.btConvexHullShape;o=0;for(q=s.points.length;o<q;o++)t(s.points[o],A),r.addPoint(A)}else h.type===b.collision.shape.HEIGHTFIELD&&f();r&&(h.margin!==0&&r.setMargin(h.margin),z.push({cShape:h,btShape:r}))}d=null;if(z.length===1)d=z[0].btShape;else if(z.length>1){e=new Ammo.btTransform;d=new Ammo.btCompoundShape(!1);m=0;for(n=z.length;m<n;m++)e.setIdentity(),e.setOrigin(g(z[m].cShape.position)),e.setRotation(c(z[m].cShape.rotation)),
d.addChildShape(e,z[m].btShape)}a.setResult(d);a=d}this.shape=a}return this.shape},setAngularVelocity:function(a){this.angularVelocity=a;this.body&&(t(a,o),this.body.setAngularVelocity(o))},setGravity:function(a){this.gravity=a;this.body&&(t(a,o),this.body.setGravity(o))},getGravity:function(){if(this.gravity&&!this.body)return this.gravity;return q(this.body.getGravity())},setLinearVelocity:function(a){this.linearVelocity=a;this.body&&(t(a,o),this.body.setLinearVelocity(o))},applyImpulse:function(a,
b){this.impulse=a||[0,0,0];this.impulsePosition=b||[0,0,0];this.body&&!CubicVR.vec3.equal([0,0,0],a)&&(t(this.impulse,o),t(this.impulsePosition,r),this.body.applyImpulse(o,r))},applyForce:function(a,b){this.body&&!CubicVR.vec3.equal([0,0,0],a)&&(t(a,o),t(b,r),this.body.applyImpulse(o,r))},getAngularVelocity:function(){return q(this.body.getAngularVelocity())},getLinearVelocity:function(){return q(this.body.getLinearVelocity())},activate:function(a){this.noDeactivate=a||!1;this.body&&(this.noDeactivate&&
this.body.setActivationState(Ammo.DISABLE_DEACTIVATION),this.body.activate())},setAngularFactor:function(b){this.body&&b!==a&&(b.length||(b=[b,b,b]),t(b,o),this.body.setAngularFactor(o))},isActive:function(){if(this.body)this.body.isActive();else return!1},isStatic:function(){return this.properties.type==b.physics.body.STATIC},setRigidFlags:function(a){this.rigid_flags=a;this.body&&this.body.setFlags(a)},setCollisionFlags:function(a){this.collision_flags=a;this.body&&this.body.setCollisionFlags(a)},
setPosition:function(a){this.position=a;if(this.body||this.ghost)t(a,o),this.body&&this.body.getCenterOfMassTransform().setOrigin(o),this.ghost&&this.ghost.getWorldTransform().setOrigin(o)},getRotation:function(){if(!this.body&&!this.ghost)return this.init_rotation;this.body&&this.body.getCenterOfMassTransform().getRotation(m);this.ghost&&this.ghost.getWorldTransform().getRotation(m);var a=new CubicVR.Quaternion;n(m,a);return a},setRotation:function(a){this.rotation=a.toEuler();if(this.body||this.ghost)s(a,
m),this.body&&this.body.getCenterOfMassTransform().setRotation(m),this.ghost&&this.ghost.getWorldTransform().setRotation(m)},getRotationEuler:function(){if(!this.body&&!this.ghost)return this.init_rotation;var a=new CubicVR.Quaternion;this.body&&this.body.getCenterOfMassTransform().getRotation(m);this.ghost&&this.ghost.getWorldTransform().getRotation(m);n(m,a);return a.toEuler()},setRotationEuler:function(a){this.rotation=a;m.setEuler(this.rotation[2]*(Math.PI/180),this.rotation[1]*(Math.PI/180),
this.rotation[0]*(Math.PI/180));this.body&&this.body.getCenterOfMassTransform().setRotation(m);this.ghost&&this.body.getWorldTransform().setRotation(m)}};var A=function(c){c=c||{};this.ctype=c.ctype||b.physics.constraint.P2P;this.strength=c.strength||0.1;this.maxImpulse=c.maxImpulse||0;this.rigidBodyA=c.rigidBodyA||c.rigidBody||null;this.rigidBodyB=c.rigidBodyB||null;this.positionA=c.positionA||[0,0,0];this.positionB=c.positionB||c.position||[0,0,0];this.damping=c.damping!=a?c.damping:1;this.btConstraint=
null;this.localPivotA=g(this.positionA);this.localPivotB=g(this.positionB)};A.prototype={getConstraint:function(){if(!this.btConstraint){if(!this.rigidBodyA)return!1;if(this.ctype===b.physics.constraint.P2P&&(this.btConstraint=this.rigidBodyA&&this.rigidBodyB?new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.rigidBodyB.getBody(),this.localPivotA,this.localPivotB):new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.localPivotA),this.btConstraint.get_m_setting().set_m_tau(this.strength),
this.btConstraint.get_m_setting().set_m_damping(this.damping),this.maxImpulse&&this.btConstraint.get_m_setting().set_m_impulseClamp(this.maxImpulse),this.btConstraint===NULL))this.btConstraint=null}return this.btConstraint},setStrength:function(a){this.strength=a;this.btConstraint&&this.btConstraint.get_m_setting().set_m_tau(this.strength)},setDamping:function(a){this.damping=a;this.btConstraint&&this.btConstraint.get_m_setting().set_damping(this.damping)},setMaxImpulse:function(a){this.maxImpulse=
a;this.btConstraint&&this.btConstraint.get_m_setting().set_impulseClamp(this.maxImpulse)},getStrength:function(){return this.strength},setPosition:function(a){this.positionB=a;this.btConstraint&&(t(this.positionB,this.localPivotB),this.btConstraint.setPivotB(this.localPivotB))},getPosition:function(){return this.positionB}};h.prototype={getContact:function(){var a=this.manifold.getContactPoint(j);if(a===Ammo.NULL)return null;return{impulse:a.getAppliedImpulse(),lifetime:a.getLifeTime(),friction:a.get_m_combinedFriction(),
positionA:q(a.getPositionWorldOnA()),positionB:q(a.getPositionWorldOnB())}},setManifold:function(a){this.numContacts=a.getNumContacts();this.manifold=a}};var z=function(){this.rigidObjects=[];this.ghostObjects=[];this.contactObjects=[];this.collisionObjects=[];this.active_count=0;this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;this.solver=new Ammo.btSequentialImpulseConstraintSolver;
this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration);this.dynamicsWorld.setGravity(new Ammo.btVector3(0,-10,0));this.overlappingPairCache.getOverlappingPairCache().setInternalGhostPairCallback(new Ammo.btGhostPairCallback);if(!e||!d)o=new Ammo.btVector3,r=new Ammo.btVector3,e=new Ammo.btTransform,d=new CubicVR.Quaternion,m=new Ammo.btQuaternion};z.prototype={addConstraint:function(a){var b=a.getConstraint();if(b)return this.dynamicsWorld.addConstraint(b),
a.rigidBodyA.activate(!0),!0;return!1},removeConstraint:function(a){if(a=a.getConstraint())return this.dynamicsWorld.removeConstraint(a),!0;return!1},setGravity:function(a){t(a,o);this.dynamicsWorld.setGravity(o)},bindSceneObject:function(a,b){var c=new CubicVR.RigidBody(a,b);this.rigidObjects.push(c);c.getBody();c.activate();this.dynamicsWorld.addRigidBody(c.getBody());c.updateSceneObject(!0);return c},bindRigidBody:function(a){if(a.getType()===b.physics.body.GHOST){if(this.ghostObjects.indexOf(a)!==
-1)return;this.ghostObjects.push(a);var c=a.getBody();a.properties.blocker||c.setCollisionFlags(c.getCollisionFlags()+b.physics.collision_flags.NO_CONTACT_RESPONSE);this.dynamicsWorld.addCollisionObject(c)}else{if(this.rigidObjects.indexOf(a)!==-1)return;this.rigidObjects.push(a);c=a.getBody();a.activate();this.dynamicsWorld.addRigidBody(c);a.updateSceneObject(!0)}var d,f;if((d=a.getSceneObject())&&(f=d.getEventHandler()))f.hasEvent(b.event.CONTACT)&&this.contactObjects.push(a),f.hasEvent(b.event.COLLIDE)&&
this.collisionObjects.push(a)},getActiveCount:function(){return this.active_count},stepSimulation:function(a,b){this.dynamicsWorld.stepSimulation(a,b||2);for(var c=0,d=0,f=this.rigidObjects.length;d<f;d++)this.rigidObjects[d].updateSceneObject()&&c++;this.active_count=c},triggerEvents:function(){var a,c,d,f=this.dynamicsWorld;if(this.contactObjects.length){var e=f.getDispatcher().getNumManifolds();for(a=0;a<e;a++){var g,m=f.getDispatcher().getManifoldByIndexInternal(a),n=Ammo.wrapPointer(m.getBody0(),
Ammo.btRigidBody)._cvr_rigidbody||null,o=Ammo.wrapPointer(m.getBody1(),Ammo.btRigidBody)._cvr_rigidbody||null;if(n&&(g=n.getSceneObject())&&(c=g.getEventHandler())&&c.hasEvent(b.event.CONTACT))d=c.triggerEvent(b.event.CONTACT),d.self=n,d.other=o,d.contacts?d.contacts.setManifold(m):d.contacts=new h(m);else if(o&&o.isStatic()&&(g=o.getSceneObject())&&(c=g.getEventHandler())&&c.hasEvent(b.event.CONTACT))d=c.triggerEvent(b.event.CONTACT),d.other=n,d.self=o,d.contacts?d.contacts.setManifold(m):d.contacts=
new h(m)}}f=this.collisionObjects.length;for(a=0;a<f;a++)if(n=this.collisionObjects[a],(g=n.getSceneObject())&&(c=g.getEventHandler())&&c.hasEvent(b.event.COLLIDE))if(d=c.getProperties(b.event.COLLIDE),m=d.collidesWith,d.mf=d.mf||[],d.alg=d.alg||[],m&&m.length){e=[];n=n.getBody();a=0;for(iMax=m.length;a<iMax;a++){var o=m[a],q=o.getBody();d.mf[a]||(d.mf[a]=new Ammo.btManifoldResult(n,q));d.alg[a]||(d.alg[a]=this.dynamicsWorld.getDispatcher().findAlgorithm(n,q));d.alg[a].processCollision(n,q,this.dynamicsWorld.getDispatchInfo(),
d.mf[a]);d.mf[a].getPersistentManifold().getNumContacts()>0&&(e.push(o),this.dynamicsWorld.getDispatcher().clearManifold(d.mf[a].getPersistentManifold()))}if(e.length&&(d=c.triggerEvent(b.event.COLLIDE)))d.collisions=e}f=this.ghostObjects.length;for(a=0;a<f;a++)if(d=this.ghostObjects[a],g=d.getSceneObject())if((c=g.getEventHandler())&&c.hasEvent(b.event.CONTACT_GHOST))if(g=d.getBody(),e=g.getNumOverlappingObjects()){d=c.triggerEvent(b.event.CONTACT_GHOST);d.contacts=d.contacts||[];if(d.contacts.length>
e)d.contacts.length=e;for(c=0;c<e;c++)m=Ammo.btRigidBody.prototype.upcast(g.getOverlappingObject(c)),d.contacts[c]=m._cvr_rigidbody||null}},reset:function(){for(var a=0,b=this.rigidObjects.length;a<b;a++)this.rigidObjects[a].reset()},getRayHit:function(a,b,c,d){var f,a=g(a);f=g(b);c=c||!1;d=d||!1;b=new Ammo.ClosestRayResultCallback(a,f);this.dynamicsWorld.rayTest(a,f,b);if(b.hasHit()&&(body=Ammo.btRigidBody.prototype.upcast(b.get_m_collisionObject()),body!==NULL&&!(body.isStaticObject()&&!c||body.isKinematicObject()&&
!d)))return c=body,d=b.get_m_hitPointWorld(),a=c.getCenterOfMassTransform().inverse().op_mul(d),(f=c._cvr_rigidbody)?(Ammo.destroy(b),{position:q(d),localPosition:q(a),rigidBody:f,ammoBody:c}):(Ammo.destroy(b),{position:q(d),localPosition:q(a),rigidBody:null,ammoBody:c});Ammo.destroy(b)}};return{ScenePhysics:z,Constraint:A,RigidProperties:function(c){this.type=c.type!==a?c.type:b.physics.body.DYNAMIC;this.mass=c.mass!==a?c.mass:this.type?1:0;this.size=c.size||[1,1,1];this.restitution=c.restitution||
(this.type?0:1);this.friction=c.friction||1;if((this.collision=c.collision)&&!this.collision.getShapes)this.collision=new CubicVR.CollisionMap(this.collision);this.blocker=c.blocker||!1},RigidBody:y,vec3bt_copy:t,btvec3_copy:function(a,b){b[0]=a.x();b[1]=a.y();b[2]=a.z()},quatbt_copy:s,btquat_copy:n}});CubicVR.RegisterModule("Shader",function(y){function t(a,b){var c=CubicVR.util,e,d;this.uniforms=[];this.uniform_type=[];this.uniform_typelist=[];a.indexOf("\n")!==-1?e=q(n.gl,a,"x-shader/x-vertex"):(e=h(n.gl,a),e===null&&(d=c.getURL(a),e=q(n.gl,d,"x-shader/x-vertex")));b.indexOf("\n")!==-1?d=q(n.gl,b,"x-shader/x-fragment"):(d=h(n.gl,b),d===null&&(d=c.getURL(b),d=q(n.gl,d,"x-shader/x-fragment")));this.shader=n.gl.createProgram();n.gl.attachShader(this.shader,e);n.gl.attachShader(this.shader,d);n.gl.linkProgram(this.shader);
if(!n.gl.getProgramParameter(this.shader,n.gl.LINK_STATUS))throw Error("Could not initialise shader vert("+a+"), frag("+b+")");}var s=y.undef,n=y.GLCore,g=CubicVR.enums,c=y.log;g.shader={map:{COLOR:1,SPECULAR:2,NORMAL:4,BUMP:8,REFLECT:16,ENVSPHERE:32,AMBIENT:64,ALPHA:128,COLORMAP:256},uniform:{MATRIX:0,VECTOR:1,FLOAT:2,ARRAY_VERTEX:3,ARRAY_UV:4,ARRAY_FLOAT:5,INT:6}};var q=function(a,b,f){if(f==="x-shader/x-fragment")f=a.createShader(a.FRAGMENT_SHADER);else if(f==="x-shader/x-vertex")f=a.createShader(a.VERTEX_SHADER);
else return null;a.shaderSource(f,b);a.compileShader(f);if(!a.getShaderParameter(f,a.COMPILE_STATUS))return c(a.getShaderInfoLog(f)),null;return f},h=function(a,b){var f=document.getElementById(b);if(!f)return null;for(var e="",d=f.firstChild;d;)d.nodeType===3&&(e+=d.textContent),d=d.nextSibling;if(f.type==="x-shader/x-fragment")f=a.createShader(a.FRAGMENT_SHADER);else if(f.type==="x-shader/x-vertex")f=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(f,e);a.compileShader(f);a.getShaderParameter(f,
a.COMPILE_STATUS)||c(a.getShaderInfoLog(f));return f};t.prototype={bindSelf:function(a){var b,c,e;a.indexOf(".")!==-1?a.indexOf("[")!==-1?(b=a.split("["),e=b[0],b=b[1].split("]"),c=b[0],b=b[1].split("."),b=b[1],this[e]===s&&(this[e]=[]),this[e][c]===s&&(this[e][c]={}),this[e][c][b]=this.uniforms[a]):(b=a.split("."),e=b[0],b=b[1],this[e]===s&&(this[e]={}),this[e][b]=this.uniforms[a]):a.indexOf("[")!==-1?(b=a.split("["),e=b[0],b=b[1].split("]"),c=b[0],this[e]===s&&(this[e]=[]),this[e][c]=this.uniforms[a]):
this[a]=this.uniforms[a]},addMatrix:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=g.shader.uniform.MATRIX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==s&&this.setMatrix(a,b);this.bindSelf(a);return this.uniforms[a]},addVector:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=g.shader.uniform.VECTOR;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
b!==s&&this.setVector(a,b);this.bindSelf(a);return this.uniforms[a]},addFloat:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=g.shader.uniform.FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==s&&this.setFloat(a,b);this.bindSelf(a);return this.uniforms[a]},addVertexArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=g.shader.uniform.ARRAY_VERTEX;this.uniform_typelist.push([this.uniforms[a],
this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addUVArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=g.shader.uniform.ARRAY_UV;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addFloatArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=g.shader.uniform.ARRAY_FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
this.bindSelf(a);return this.uniforms[a]},addInt:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=g.shader.uniform.INT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==s&&this.setInt(a,b);this.bindSelf(a);return this.uniforms[a]},use:function(){n.gl.useProgram(this.shader)},setMatrix:function(a,b){var c=this.uniforms[a];if(c!==null){var e=b.length;e===16?n.gl.uniformMatrix4fv(c,!1,b):e===9?n.gl.uniformMatrix3fv(c,!1,b):e===
4&&n.gl.uniformMatrix2fv(c,!1,b)}},setInt:function(a,b){var c=this.uniforms[a];c!==null&&n.gl.uniform1i(c,b)},setFloat:function(a,b){var c=this.uniforms[a];c!==null&&n.gl.uniform1f(c,b)},setVector:function(a,b){var c=this.uniforms[a];if(c!==null){var e=b.length;e==3?n.gl.uniform3fv(c,b):e==2?n.gl.uniform2fv(c,b):n.gl.uniform4fv(c,b)}},clearArray:function(a){a=this.uniforms[a];a!==null&&n.gl.disableVertexAttribArray(a)},bindArray:function(a,b){var c=n.gl,e=this.uniforms[a];if(e!==null){var d=this.uniform_type[a];
d===g.shader.uniform.ARRAY_VERTEX?(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(e,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(e)):d===g.shader.uniform.ARRAY_UV?(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(e,2,c.FLOAT,!1,0,0)):d===g.shader.uniform.ARRAY_FLOAT&&(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(e,1,c.FLOAT,!1,0,0))}}};return{Shader:t}});CubicVR.RegisterModule("UVMapper",function(y){function t(a){a!==s?(this.rotation=a.rotation===s?[0,0,0]:a.rotation,this.scale=a.scale===s?[1,1,1]:a.scale,this.center=a.center===s?[0,0,0]:a.center,this.projection_mode=a.projectionMode===s?n.uv.projection.PLANAR:a.projectionMode,this.projection_axis=a.projectionAxis===s?n.uv.axis.X:a.projectionAxis,this.wrap_w_count=a.wrapW===s?1:a.wrapW,this.wrap_h_count=a.wrapH===s?1:a.wrapH):(this.rotation=[0,0,0],this.scale=[1,1,1],this.center=[0,0,0],this.projection_mode=
n.uv.projection.PLANAR,this.projection_axis=n.uv.axis.X,this.wrap_h_count=this.wrap_w_count=1)}var s=y.undef,n=CubicVR.enums,g=2*Math.PI,c=Math.PI/2;n.uv={axis:{X:0,Y:1,Z:2},projection:{UV:0,PLANAR:1,CYLINDRICAL:2,SPHERICAL:3,CUBIC:4,SKY:5}};var q=function(a,b,f){return a===0&&f===0?0:f===0?a<0?c:-c:f<0?-Math.atan(a/f)+Math.PI:-Math.atan(a/f)},h=function(a,b,f){var e;a===0&&f===0?(e=0,a=b!==0?b<0?-c:c:0):(e=f===0?a<0?c:-c:f<0?-Math.atan(a/f)+Math.PI:-Math.atan(a/f),a=Math.sqrt(a*a+f*f),a=a===0?b<
0?-c:c:Math.atan(b/a));return[e,a]};t.prototype={setRotation:function(a){this.rotation=a},setScale:function(a){this.scale=a},setCenter:function(a){this.center=a},setProjectionAxis:function(a){this.projection_axis=a},setProjectionMode:function(a){this.projection_mode=a},setWrapW:function(a){this.wrap_w_count=a},setWrapH:function(a){this.wrap_h_count=a},apply:function(a,b,f,e,d){var m=CubicVR.mat4,o,r,t,z,v,w=new CubicVR.Transform,y=!1,J=null;if(this.center[0]||this.center[1]||this.center[2])w.translate(-this.center[0],
-this.center[1],-this.center[2]),y=!0;if(this.rotation[0]||this.rotation[1]||this.rotation[2])this.rotation[0]&&w.rotate(this.rotation[2],0,0,1),this.rotation[1]&&w.rotate(this.rotation[1],0,1,0),this.rotation[2]&&w.rotate(this.rotation[0],1,0,0),y=!0;y&&(J=w.getResult());typeof b==="object"&&(b=a.materials.indexOf(b));var w=0,O=a.faces.length;e&&(w=e);for(d&&(O=d+1);w<O;w++)if(a.faces[w].material===b&&!(f!==s&&a.faces[w].segment!==f)){var x,u,F;if(this.projection_mode===n.uv.projection.CUBIC||this.projection_mode===
n.uv.projection.SKY)x=Math.abs(a.faces[w].normal[0]),u=Math.abs(a.faces[w].normal[1]),F=Math.abs(a.faces[w].normal[2]);for(var e=[],d=0,D=a.faces[w].points.length;d<D;d++){r=a.faces[w].points[d];var B=a.faces[w].points[(d+1)%3],U=a.faces[w].points[(d+2)%3];o=a.points[r];var K=a.points[B],E=a.points[U],G;y&&(o=m.vec3_multiply(o,J));G=this.projection_mode;if(G===n.uv.projection.SKY)r=a.sky_mapping,x>=u&&x>=F&&(t=o[2]/this.scale[2]+this.scale[2]/2,z=-o[1]/this.scale[1]+this.scale[1]/2,a.faces[w].normal[0]<
0?(t=(r[2][2]-r[2][0])*(1-t),z=1-(r[2][3]-r[2][1])*z,t+=r[2][0],z+=r[2][1]):(t*=r[3][2]-r[3][0],z=1-(r[3][3]-r[3][1])*z,t+=r[3][0],z+=r[3][1])),u>=x&&u>=F&&(t=o[0]/this.scale[0]+this.scale[0]/2,z=-o[2]/this.scale[2]+this.scale[2]/2,a.faces[w].normal[1]<0?(t*=r[1][2]-r[1][0],z=1-(r[1][3]-r[1][1])*z,t+=r[1][0],z-=r[1][1]):(t*=r[0][2]-r[0][0],z=1-(r[0][3]-r[0][1])*z,t+=r[0][0],z-=r[0][1])),F>=x&&F>=u&&(t=o[0]/this.scale[0]+this.scale[0]/2,z=o[1]/this.scale[1]+this.scale[1]/2,a.faces[w].normal[2]<0?(t*=
r[4][2]-r[4][0],z=1-(r[4][3]-r[4][1])*(1-z),t+=r[4][0],z-=r[4][1]):(t=(r[5][2]-r[5][0])*(1-t),z=1-(r[5][3]-r[5][1])*(1-z),t+=r[5][0],z+=r[5][1])),a.faces[w].setUV([t,z],d);else if(G===n.uv.projection.CUBIC)x>=u&&x>=F&&(t=o[2]/this.scale[2]+0.5,z=o[1]/this.scale[1]+0.5),u>=x&&u>=F&&(t=-o[0]/this.scale[0]+0.5,z=o[2]/this.scale[2]+0.5),F>=x&&F>=u&&(t=-o[0]/this.scale[0]+0.5,z=o[1]/this.scale[1]+0.5),a.faces[w].normal[0]>0&&(t=-t),a.faces[w].normal[1]<0&&(t=-t),a.faces[w].normal[2]>0&&(t=-t),a.faces[w].setUV([t,
z],d);else if(G===n.uv.projection.PLANAR)t=this.projection_axis===n.uv.axis.X?o[2]/this.scale[2]+0.5:-o[0]/this.scale[0]+0.5,z=this.projection_axis===n.uv.axis.Y?o[2]/this.scale[2]+0.5:o[1]/this.scale[1]+0.5,a.faces[w].setUV([t,z],d);else{if(G===n.uv.projection.CYLINDRICAL)G=this.projection_axis,G===n.uv.axis.X?(v=q(o[2],o[0],-o[1]),z=-o[0]/this.scale[0]+0.5):G===n.uv.axis.Y?(v=q(-o[0],o[1],o[2]),z=-o[1]/this.scale[1]+0.5):G===n.uv.axis.Z&&(v=q(-o[0],o[2],-o[1]),z=-o[2]/this.scale[2]+0.5),v=1-v/g,
this.wrap_w_count!==1&&(v*=this.wrap_w_count),o=v,r=z;else if(G===n.uv.projection.SPHERICAL){var H,N,I;G=this.projection_axis;G===n.uv.axis.X?(H=e[r]?e[r]:h(o[2],o[0],-o[1]),e[r]||(e[r]=H),N=e[B]?e[B]:h(K[2],K[0],-K[1]),e[B]||(e[B]=N),I=e[U]?e[U]:h(E[2],E[0],-E[1]),e[U]||(e[U]=I)):G===n.uv.axis.Y?(H=e[r]?e[r]:h(o[0],-o[1],o[2]),e[r]||(e[r]=H),N=e[B]?e[B]:h(K[0],-K[1],K[2]),e[B]||(e[B]=N),I=e[U]?e[U]:h(E[0],-E[1],E[2]),e[U]||(e[U]=I)):G===n.uv.axis.Z&&(H=e[r]?e[r]:h(-o[0],o[2],-o[1]),e[r]||(e[r]=H),
N=e[B]?e[B]:h(-K[0],K[2],-K[1]),e[B]||(e[B]=N),I=e[U]?e[U]:h(-E[0],E[2],-E[1]),e[U]||(e[U]=I));Math.abs(H[0]-N[0])>c&&Math.abs(H[0]-I[0])>c&&(H[0]>N[0]&&H[0]>I[0]?H[0]-=g:H[0]+=g);Math.abs(H[1]-N[1])>c&&Math.abs(H[1]-I[1])>c&&(H[1]>N[1]&&H[1]>I[1]?H[1]-=g:H[1]+=g);v=1-H[0]/g;r=0.5-H[1]/Math.PI;this.wrap_w_count!==1&&(v*=this.wrap_w_count);this.wrap_h_count!==1&&(r*=this.wrap_h_count);o=v}else r=o=0;a.faces[w].setUV([o,r],d)}}}return this}};return{UVMapper:t}});CubicVR.RegisterModule("Utility",function(y){var t=y.undef;return{util:{getScriptContents:function(s){var n=document.getElementById(s),g="",c="";if(n){if(n.src!==""||n.attributes.srcUrl!==t)c=n.src!==""?n.src:n.attributes.srcUrl.value}else c=s;if(c.length!==0){if(s=new XMLHttpRequest,s.open("GET",c,!1),s.send(null),s.status===200||s.status===0)g=s.responseText}else for(c=n.firstChild;c;)c.nodeType===3&&(g+=c.textContent),c=c.nextSibling;return g},getURL:function(s){try{var n=new XMLHttpRequest;n.open("GET",
s,!1);n.send(null);if(n.status===200||n.status===0)if(n.responseText.length)return n.responseText;else if(n.responseXML)return n.responseXML}catch(g){alert(s+" failed to load.")}return null},getXML:function(s){try{var n=new XMLHttpRequest;n.open("GET",s,!1);n.overrideMimeType("application/xml");n.send(null);if(n.status===200||n.status===0)return n.responseXML}catch(g){try{alert(s+" failed to load.")}catch(c){throw g;}}return null},getJSON:function(s){try{var n=new XMLHttpRequest;n.open("GET",s,!1);
n.overrideMimeType("application/json");n.send(null);if(n.status===200||n.status===0)return eval("("+n.responseText+")")}catch(g){try{alert(s+" failed to load.")}catch(c){throw g;}}return null},repackArray:function(s,n,g){s.length!==parseInt(n,10)*parseInt(g,10)&&log("array repack error, data size !== stride*count: data.length="+s.length+" stride="+n+" count="+g);for(var g=[],c=0,q=0,h=s.length;q<h;q++){var a=q%n;a===0&&(g[c]=[]);g[c][a]=s[q];a===n-1&&c++}return g},collectTextNode:function(s){if(!s)return"";
for(var n="",s=s.childNodes,g=0,c=s.length;g<c;g++)n+=s[g].nodeValue;return n},floatDelimArray:function(s,n){for(var g=s.split(n?n:","),c=0,q=g.length;c<q;c++)g[c]=parseFloat(g[c]);g[g.length-1]!==g[g.length-1]&&g.pop();return g},intDelimArray:function(s,n){for(var g=s.split(n?n:","),c=0,q=g.length;c<q;c++)g[c]=parseInt(g[c],10);g[g.length-1]!==g[g.length-1]&&g.pop();return g},textDelimArray:function(s,n){for(var g=s.split(n?n:","),c=0,q=g.length;c<q;c++)g[c]=g[c];return g},xml2badgerfish:function(s){var n=
{},g=[],c,q,h,a,b,f=/^\s+|\s+$/g;s.jsonParent=n;for(g.push(s);g.length;){q=g.pop();var e=null;h=q.jsonParent;s=0;for(c=q.childNodes.length;s<c;s++)a=q.childNodes[s],b=a.tagName,b!==t&&(e=e||{},e[b]=e[b]||0,e[b]++);if(q.attributes&&q.attributes.length){s=0;for(c=q.attributes.length;s<c;s++)a=q.attributes[s],h["@"+a.name]=a.value}s=0;for(c=q.childNodes.length;s<c;s++)if(a=q.childNodes[s],b=a.tagName,a.nodeType===1)e[b]>1?(h[b]=h[b]||[],h[b].push({}),a.jsonParent=h[b][h[b].length-1]):(h[b]=h[b]||{},
a.jsonParent=h[b]),g.push(a);else if(a.nodeType===3&&a.nodeValue.replace(f,"")!=="")h.$=h.$||"",h.$+=a.nodeValue}return n}}}});CubicVR.RegisterModule("Worker",function(y){function t(a){var b=this;this.message=a.message||function(){};this.send=function(a,b){postMessage({message:a,data:b})};self.addEventListener("message",function(a){a.data.message!=="init"&&b.message(a.data)},!1)}function s(a){function b(a){setTimeout(function(){c.send("test",a)},1E3)}a&&b(a);var c=new t({message:b})}function n(a){function b(a){a=r.getURL(a);c.send("done",a.length)}var c;c=new t({message:function(a){b(a)}});a&&b(a)}function g(a){function b(a){a=
r.getURL(a);c.send("loaded",a)}var c,d;c=new t({message:function(a){if(a.message==="parse")d=new o,CubicVR.loadCollada("","",d,a.data),c.send("parsed");else if(a.message==="getMesh"){if(a=d.meshMap[":"+a.data]){var b=a.triangulateQuads().compileVBO(a.compileMap());c.send("getMesh",{mesh:a,vbo:b})}}else throw Error("Not a SceneFileWorker command: "+a.message);}});a&&b(a)}function c(b){function c(b){var e=new a,f;for(f in b)b.hasOwnProperty(f)&&(e[f]=b[f]);b=e.triangulateQuads().compileVBO(e.compileMap());
d.send("done",b)}var d;d=new t({message:function(a){c(a)}});b&&c(b)}try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(q){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}var h=y.undef,a=CubicVR.Mesh,b=CubicVR.Texture,f=CubicVR.Material,e=CubicVR.SceneObject,d=CubicVR.Motion,m=CubicVR.Envelope,o=CubicVR.DeferredBin,r=CubicVR.util;return{Worker:function(a){this.worker=new Worker(CubicVR.getScriptLocation()+"CubicVR.js");
this.message=a.message||function(){};this.error=a.error||function(a){console.log("Error: "+a.message+": "+a.lineno)};this.type=a.type;var b=this;this.worker.onmessage=function(a){b.message(a.data)};this.worker.onerror=function(a){b.error(a)};this.init=function(a){b.send("init",{type:b.type,data:a})};this.send=function(a,c){b.worker.postMessage({message:a,data:c})};this.send("CubicVR_InitWorker",CubicVR.getScriptLocation());(a.data||a.autoStart)&&b.init(a.data)},ResourcePool:function(){function c(b){var d=
b.parsed||function(){},e={},f;b.url.match(/\.dae/)&&(f=new CubicVR.Worker({type:"sceneFile",data:b.url,message:function(b){if(b.message==="loaded"){var b=(new DOMParser).parseFromString(b.data,"text/xml"),c=r.xml2badgerfish(b);console.log(b);f.send("parse",c)}else if(b.message==="getMesh"){var c=new a,g;for(g in b.data.mesh)b.data.mesh.hasOwnProperty(g)&&(c[g]=b.data.mesh[g]);c.bindBuffer(c.bufferVBO(b.data.vbo));e.getMesh&&e.getMesh(c)}else b.message==="parsed"&&d()}}));this.getSceneObject=function(a,
b){f.send("getMesh",a);e.getMesh=b}}function d(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}var g=this,h={};this.createSceneFileManager=function(a){var b=new c({url:a.url,parsed:a.parsed});return h[a.url]=b};this.removeSceneFileManager=function(a){if(typeof settings==="string")delete h[settings];else for(var b in h)h[b]===a&&delete h[b]};this.createSceneObjectFromMesh=function(c){var h=c.scene,m=c.object,n=c.assetBase||"",o=g.createSceneFileManager({url:c.mesh,parsed:function(){m&&
o.getSceneObject(m,function(c){for(var c=d(c,new a),g=0,m=c.materials.length;g<m;++g){for(var o=d(c.materials[g],new f),q=0,r=o.textures.length;q<r;++q){var s=o.textures[g];o.textures[g]=new b(n+s.img_path,s.filter_type)}c.materials[g]=o}c=new e(c);h.bindSceneObject(c)})}})};this.loadFile=function(a,b){b=b||function(){};new CubicVR.Worker({type:"file",data:mesh,message:function(a){b(a.data)}})}},loadColladaWorker:function(c,g,n,o){var q;try{q=new Worker(CubicVR.getScriptLocation()+"collada.js")}catch(r){throw Error("Can't find collada.js");
}var s=[],t=[];q.onmessage=function(g){function q(a,b){for(var c in a)b[c]=a[c]}function r(a){if(a.motion){for(var b=a.motion.controllers,c=[],e=0,f=b.length;e<f;++e){var g=b[e];if(g){for(var h=[],n=0,o=g.length;n<o;++n){var s=g[n];if(s){var t=s.keys[0];if(s.keys.length>1)t.prev=null,t.next=s.keys[1],t=s.keys[1];for(var u=1,v=s.keys.length-1;u<v;++u)t.prev=s.keys[u-1],t.next=s.keys[u+1],t=s.keys[u+1];if(s.keys.length>1)t=s.keys[s.keys.length-1],t.prev=s.keys[s.keys.length-2],t.next=null;s.firstKey=
s.keys[0];s.lastKey=s.keys[s.keys.length-1];s.keys=s.firstKey;t=new m;q(s,t);h[n]=t}else g[n]=null}c[e]=h}else b[e]=null}a.motion.controllers=c;b=new d;q(a.motion,b);a.motion=b}}function y(b){var d=new e;q(b,d);if(b.obj!==null){var f=t[b.obj.id];if(f===h)if(f=new a,q(b.obj,f),d.obj=f,t[b.obj.id]=f,o){if(f.points.length>0){o.addMesh(c,c+":"+f.id,f);for(var g=0,m=f.faces.length;g<m;++g){var n=f.faces[g],r=n.material;n.material=s[r]!==h?s[r]:0}}}else d.obj.triangulateQuads(),d.obj.calcNormals(),d.obj.compile(),
d.obj.clean();else d.obj=f}d.trans=new Transform;if(b.children&&b.children.length>0&&(d.children=[],b.children)){f=0;for(g=b.children.length;f<g;++f)m=y(b.children[f]),d.bindChild(m)}return d}var z;z=g.data.message;if(z=="materials"){var C=JSON.parse(g.data.data),g=0;for(z=C.length;g<z;++g){var E=new f(C[g].name),G=E.material_id;q(C[g],E);E.material_id=G;s[C[g].material_id]=G;for(var G=0,H=C[g].textures.length;G<H;++G){var J=C[g].textures[G];if(J){var I=Texture_ref[J.img_path];I===h?(J=new b(J.img_path,
J.filter_type,o,c),E.textures[G]=J):E.textures[G]=Textures_obj[I]}else E.textures[G]=0}}}else if(z=="scene"){C=JSON.parse(g.data.data);g=0;for(z=C.sceneObjects.length;g<z;++g){E=C.sceneObjects[g];E.obj!==null&&nop();if(E.reassembled===h)r(E),E.reassembled=!0;C.sceneObjects[g]=y(E)}E=new Scene;g=E.camera;z=g.transform;q(C.camera,g);q(C.camera.transform,z);r(g);E.camera=g;E.camera.transform=z;E.camera.frustum=new Frustum;g=0;for(z=C.sceneObjects.length;g<z;++g){G=C.sceneObjects[g];E.bindSceneObject(G);
try{G.getAABB()}catch(R){}}g=0;for(z=C.lights.length;g<z;++g)G=new Light,q(C.lights[g],G),G.trans=new Transform,r(G),E.bindLight(G);n(E)}else console.log("message from collada worker:",g.data.message)};q.onerror=function(a){console.log("error from collada worker:",a.message)};q.postMessage({message:"start",params:{meshUrl:c,prefix:g,rootDir:CubicVR.getScriptLocation()}})},InitWorker:function(){var a={test:s,prepareMesh:c,file:n,sceneFile:g};self.addEventListener("message",function(b){if(b.data.message===
"init"){var c=b.data.data.type;if(c in a)new a[c](b.data.data.data);else throw Error("Invalid worker type.");}},!1)}}});
/* Auto Embed ./CubicVR_Core.vs */
window.CubicVR.CubicVRCoreVS="attribute vec3 aVertexPosition;\nattribute vec3 aNormal;\nattribute vec2 aTextureCoord;\n#if hasVertexColorMap\nattribute vec3 aColor;\nvarying vec3 cmapColor;\n#endif\n#if hasMorph\nattribute vec3 amVertexPosition;\nattribute vec3 amNormal;\nuniform float morphWeight;\n#endif\nvarying vec2 vTextureCoord;\nuniform vec2 uTexOffset;\n#if !perPixel\n#if lightPoint||lightDirectional||lightSpot||lightArea\nuniform vec3 lDir[loopCount];\nuniform vec3 lPos[loopCount];\nuniform vec3 lSpec[loopCount];\nuniform vec3 lDiff[loopCount];\nuniform float lInt[loopCount];\nuniform float lDist[loopCount];\n#if lightSpot\nuniform float lCut[loopCount];\n#endif\nvarying vec3 vColor;\nvarying vec3 vSpec;\n#endif\nuniform vec3 mDiff;\nuniform vec3 mSpec;\nuniform float mShine;\n#endif\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nuniform mat4 uOMatrix;\nuniform mat3 uNMatrix;\nvarying vec3 vNormal;\nvarying vec4 vPosition;\n#if !depthPack\n#if hasShadow\nvarying vec4 shadowProj[loopCount];\nuniform mat4 spMatrix[loopCount];\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nvarying vec3 u;\n#else\nvarying vec2 vEnvTextureCoord;\n#endif\n#endif\n#if hasBumpMap||hasNormalMap\nvarying vec3 eyeVec;\n#endif\n#endif \nvoid main(void)\n{\nmat4 uMVOMatrix = uMVMatrix * uOMatrix;\nmat4 uMVPMatrix = uPMatrix * uMVMatrix;\n#if hasMorph\nvPosition = uMVOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0);\ngl_Position = uMVPMatrix * uOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0);\n#else\nvPosition = uMVOMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = uMVPMatrix * uOMatrix * vec4(aVertexPosition, 1.0);\n#endif\nvTextureCoord = aTextureCoord + uTexOffset;\n#if !depthPack\n#if hasVertexColorMap\ncmapColor = aColor;\n#endif\n#if hasMorph\nvNormal = uNMatrix * normalize(uOMatrix*vec4(aNormal+(amNormal-aNormal)*morphWeight,0.0)).xyz;\n#else\nvNormal = uNMatrix * normalize(uOMatrix*vec4(aNormal,0.0)).xyz;\n#endif\n#if !perPixel\n#if lightPoint\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < loopCount; i++) {\nvec3 lDir = lPos[i]-vPosition.xyz;\nfloat dist = length(lDir);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lDir);\nfloat NdotL = max(dot(normalize(lDir),vNormal),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\naccum += att * NdotL * lDiff[i] * mDiff;\nfloat NdotHV = max(dot(vNormal, halfVector),0.0);\nvec3 spec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\nspecTotal += spec2;\n}\n}\nvColor = accum;\nvSpec = specTotal;\n#endif\n#if lightDirectional\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < loopCount; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lDir[i]);\nNdotL = max(dot(normalize(-lDir[i]),vNormal),0.0);\nif (NdotL > 0.0)   {\naccum += lInt[i] * mDiff * lDiff[i] * NdotL;\nNdotHV = max(dot(vNormal, halfVector),0.0);\nspec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\nspecTotal += spec2;\n}\n}\nvColor = accum;\nvSpec = specTotal;\n#endif\n#if lightSpot\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < loopCount; i++) {\nvec3 l = lPos[i]-vPosition.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lDir[i]));\nif ( spotDot < cos((lCut[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\natt *= spotEffect;\nvec3 v = normalize(-vPosition.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(vNormal, normalize(l)));\nfloat NdotH = max(0.0, dot(vNormal, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, mShine);\n}\nelse {\npower = 0.0;\n}\naccum += att * lDiff[i] * mDiff * NdotL;\nspec2 = lSpec[i] * mSpec * power;\nspecTotal += spec2*spotEffect;\n}\nvColor = accum;\nvSpec = specTotal;\n#endif\n#endif \n#if hasBumpMap||hasNormalMap\nvec3 tangent;\nvec3 binormal;\nvec3 c1 = cross( aNormal, vec3(0.0, 0.0, 1.0) );\nvec3 c2 = cross( aNormal, vec3(0.0, 1.0, 0.0) );\nif ( length(c1) > length(c2) )  {\ntangent = c1;\n}  else {\ntangent = c2;\n}\ntangent = normalize(tangent);\nbinormal = cross(aNormal, tangent);\nbinormal = normalize(binormal);\nmat3 TBNMatrix = mat3( (vec3 (uMVOMatrix * vec4 (tangent, 0.0))),\n(vec3 (uMVOMatrix * vec4 (binormal, 0.0))),\n(vec3 (uMVOMatrix * vec4 (aNormal, 0.0)))\n);\neyeVec = vec3(uMVOMatrix * vec4(aVertexPosition,1.0)) * TBNMatrix;\n#endif\n#if (lightSpot||lightArea) && hasShadow\nfor (int i = 0; i < loopCount; i++)\n{\n#if hasShadow\n#if hasMorph\nshadowProj[i] = spMatrix[i] * (uOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0));\n#else\nshadowProj[i] = spMatrix[i] * (uOMatrix * vec4(aVertexPosition, 1.0));\n#endif\n#endif\n}\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nu = normalize( vPosition.xyz );\n#else\nvec3 ws = (uMVMatrix * vec4(aVertexPosition,1.0)).xyz;\nvec3 u = normalize( vPosition.xyz );\nvec3 r = reflect(ws, vNormal );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvEnvTextureCoord.s = r.x/m + 0.5;\nvEnvTextureCoord.t = r.y/m + 0.5;\n#endif\n#endif\n#endif \n}\n";
/* Auto Embed ./CubicVR_Core.fs */
window.CubicVR.CubicVRCoreFS="#ifdef GL_ES\n#if perPixel\nprecision highp float;\n#else\nprecision lowp float;\n#endif\n#endif\nuniform vec3 mAmb;\nuniform vec3 lAmb;\nuniform vec3 mColor;\n#if perPixel\nuniform vec3 mDiff;\nuniform vec3 mSpec;\nuniform float mShine;\n#if lightPoint||lightDirectional||lightSpot||lightArea\nuniform vec3 lDir[loopCount];\nuniform vec3 lPos[loopCount];\nuniform vec3 lSpec[loopCount];\nuniform vec3 lDiff[loopCount];\nuniform float lInt[loopCount];\nuniform float lDist[loopCount];\n#if lightSpot\nuniform float lCut[loopCount];\n#endif\n#endif\n#if hasProjector\nuniform sampler2D lProjTex[loopCount];\n#endif\n#if hasShadow\nvarying vec4 shadowProj[loopCount];\nuniform sampler2D lDepthTex[loopCount];\nuniform vec3 lDepth[loopCount];\n#endif\n#else \nvarying vec3 vColor;\nvarying vec3 vSpec;\n#endif  \nvarying vec3 vNormal;\nvarying vec2 vTextureCoord;\n#if hasVertexColorMap\nvarying vec3 cmapColor;\n#endif\n#if alphaDepth||depthPack||hasShadow\nuniform vec3 depthInfo;\nfloat ConvertDepth3(float d) { return (depthInfo.x*depthInfo.y)/(depthInfo.y-d*(depthInfo.y-depthInfo.x));  }\nfloat DepthRange( float d ) { return ( d - depthInfo.x ) / ( depthInfo.y - depthInfo.x ); }\nfloat ConvertDepth3A(float d, float near, float far) { return (near*far)/(far-d*(far-near));  }\nfloat DepthRangeA( float d, float near, float far ) { return ( d - near ) / ( far - near ); }\n#endif\n#if depthPack\nvec4 packFloatToVec4i(const float value)\n{\nconst vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\nconst vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\nvec4 res = fract(value * bitSh);\nres -= res.xxyz * bitMsk;\nreturn res;\n}\n#endif\n#if hasShadow\nfloat unpackFloatFromVec4i(const vec4 value)\n{\nconst vec4 bitSh = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\nreturn(dot(value, bitSh));\n}\n#if softShadow\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec2 filterTaps[6];\nfilterTaps[0] = vec2(-0.326212,-0.40581);\nfilterTaps[1] = vec2(-0.840144,-0.07358);\nfilterTaps[2] = vec2(-0.695914,0.457137);\nfilterTaps[3] = vec2(-0.203345,0.620716);\nfilterTaps[4] = vec2(0.96234,-0.194983);\nfilterTaps[5] = vec2(0.473434,-0.480026);\n/*  filterTaps[6] = vec2(0.519456,0.767022);\nfilterTaps[7] = vec2(0.185461,-0.893124);\nfilterTaps[8] = vec2(0.507431,0.064425);\nfilterTaps[9] = vec2(0.89642,0.412458) ;\nfilterTaps[10] =vec2(-0.32194,-0.932615);\nfilterTaps[11] =vec2(-0.791559,-0.59771); */\nfloat shadow = 0.0;\nvec4  shadowSample;\nfloat distanceFromLight;\nfor (int i = 0; i < 6; i++) {\nshadowSample = texture2D(shadowTex,shadowCoord.st+filterTaps[i]*(2.0*texel_size));\ndistanceFromLight = unpackFloatFromVec4i(shadowSample);\nshadow += distanceFromLight <= shadowCoord.z ? 0.0 : 1.0 ;\n}\nshadow /= 6.0;\nreturn shadow;\n}\n#else\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec4 shadowSample = texture2D(shadowTex,shadowCoord.st);\nfloat distanceFromLight = unpackFloatFromVec4i(shadowSample);\nfloat shadow = 1.0;\nshadow = distanceFromLight <= (shadowCoord.z) ? 0.0 : 1.0 ;\nreturn shadow;\n}\n#endif\n#endif\n#if !depthPack\n#if hasColorMap\nuniform sampler2D colorMap;\n#endif\n#if hasBumpMap\nvarying vec3 eyeVec;\nuniform sampler2D bumpMap;\n#endif\n#if hasEnvSphereMap\nuniform sampler2D envSphereMap;\nuniform float envAmount;\n#if hasNormalMap\nvarying vec3 u;\n#else\nvarying vec2 vEnvTextureCoord;\n#endif\n#endif\n#if hasReflectMap\nuniform sampler2D reflectMap;\n#endif\n#if hasNormalMap\nuniform sampler2D normalMap;\n#endif\nuniform float mAlpha;\n#if hasAmbientMap\nuniform sampler2D ambientMap;\n#endif\n#if hasSpecularMap\nuniform sampler2D specularMap;\n#endif\n#endif \n#if hasAlphaMap\nuniform sampler2D alphaMap;\n#endif\nvarying vec4 vPosition;\nuniform mat4 uPMatrix;\nvoid main(void)\n{\n#if depthPack\nvec2 texCoord = vTextureCoord;\n#else\nvec3 n;\nvec4 color = vec4(0.0,0.0,0.0,0.0);\n#if hasBumpMap\nfloat height = texture2D(bumpMap, vTextureCoord.xy).r;\nfloat v = (height) * 0.05 - 0.04; \nvec3 eye = normalize(eyeVec);\nvec2 texCoord = vTextureCoord.xy + (eye.xy * v);\n#else\nvec2 texCoord = vTextureCoord;\n#endif\n#if hasNormalMap\nvec3 bumpNorm = vec3(texture2D(normalMap, texCoord));\nn = (vec4(normalize(vNormal),1.0)).xyz;\nbumpNorm = (bumpNorm-0.5)*2.0;\nbumpNorm.y = -bumpNorm.y;\nn = normalize((n+bumpNorm)/2.0);\n#else\nn = normalize(vNormal);\n#endif\n#if hasColorMap\n#if !(lightPoint||lightDirectional||lightSpot||lightArea)\ncolor = texture2D(colorMap, vec2(texCoord.s, texCoord.t)).rgba;\ncolor.rgb *= mColor;\n#else\ncolor = texture2D(colorMap, vec2(texCoord.s, texCoord.t)).rgba;\ncolor.rgb *= mColor;\n#endif\nif (color.a<=0.9) discard;\n#else\n#if hasVertexColorMap\ncolor = vec4(cmapColor,1.0);\n#else\ncolor = vec4(mColor,1.0);\n#endif\n#endif\n#if hasAlphaMap\ncolor.a = texture2D(alphaMap, texCoord).r;\n#if alphaDepth\nif (color.a < 0.9) discard;\n#else\n#if !hasAlpha\nif (color.a<0.9) discard;\n#else\nif (color.a==0.0) discard;\n#endif\n#endif\n#else\n#if hasAlpha\ncolor.a = mAlpha;\n#endif\n#endif\nvec3 accum = lAmb;\n#if perPixel\n#if lightPoint\nvec3 specTotal = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < loopCount; i++) {\nvec3 lDir = lPos[i]-vPosition.xyz;\nfloat dist = length(lDir);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lDir);\nfloat NdotL = max(dot(normalize(lDir),n),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\naccum += att * NdotL * lDiff[i] * mDiff;\nfloat NdotHV = max(dot(n, halfVector),0.0);\n#if hasSpecularMap\nvec3 spec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nvec3 spec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightDirectional\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < loopCount; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lDir[i]);\nNdotL = max(dot(normalize(-lDir[i]),n),0.0);\nif (NdotL > 0.0)   {\naccum += lInt[i] * mDiff * lDiff[i] * NdotL;\nNdotHV = max(dot(n, halfVector),0.0);\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nspec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightArea\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 halfVector;\nfor (int i = 0; i < loopCount; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lDir[i]);\nNdotL = max(dot(normalize(-lDir[i]),n),0.0);\nif (NdotL > 0.0)   {\nNdotHV = max(dot(n, halfVector),0.0);\n#if hasShadow\nvec4 shadowCoord = shadowProj[i] / shadowProj[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lDepth[i].x,lDepth[i].y),lDepth[i].x,lDepth[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s > 0.000&&shadowCoord.s < 1.000 && shadowCoord.t > 0.000 && shadowCoord.t < 1.000) if (i == 0) { shadow = getShadowVal(lDepthTex[0],shadowCoord,shadowProj[i].w,lDepth[i].z);}\n#if loopCount>1\nelse if (i == 1) { shadow = getShadowVal(lDepthTex[1],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>2\nelse if (i == 2) { shadow = getShadowVal(lDepthTex[2],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>3\nelse if (i == 3) { shadow = getShadowVal(lDepthTex[3],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>4\nelse if (i == 4) { shadow = getShadowVal(lDepthTex[4],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>5\nelse if (i == 5) { shadow = getShadowVal(lDepthTex[5],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>6\nelse if (i == 6) { shadow = getShadowVal(lDepthTex[6],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>7\nelse if (i == 7) { shadow = getShadowVal(lDepthTex[7],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\naccum += shadow * lInt[i] * mDiff * lDiff[i] * NdotL;\n#else\naccum += lInt[i] * mDiff * lDiff[i] * NdotL;\n#endif\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nspec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\n#if hasShadow\nspec2 *= shadow;\n#endif\nspecTotal += spec2;\n#if hasShadow\n#endif\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightSpot\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < loopCount; i++) {\nvec3 l = lPos[i]-vPosition.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lDir[i]));\nif ( spotDot < cos((lCut[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\n#if !hasProjector\natt *= spotEffect;\n#endif\nvec3 v = normalize(-vPosition.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(n, normalize(l)));\nfloat NdotH = max(0.0, dot(n, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, mShine);\n}\nelse {\npower = 0.0;\n}\n#if hasShadow\nvec4 shadowCoord = shadowProj[i] / shadowProj[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lDepth[i].x,lDepth[i].y),lDepth[i].x,lDepth[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s >= 0.000&&shadowCoord.s <= 1.000 && shadowCoord.t >= 0.000 && shadowCoord.t <= 1.000) if (i == 0) { shadow = getShadowVal(lDepthTex[0],shadowCoord,shadowProj[i].w,lDepth[i].z);}\n#if loopCount>1\nelse if (i == 1) { shadow = getShadowVal(lDepthTex[1],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>2\nelse if (i == 2) { shadow = getShadowVal(lDepthTex[2],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>3\nelse if (i == 3) { shadow = getShadowVal(lDepthTex[3],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>4\nelse if (i == 4) { shadow = getShadowVal(lDepthTex[4],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>5\nelse if (i == 5) { shadow = getShadowVal(lDepthTex[5],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>6\nelse if (i == 6) { shadow = getShadowVal(lDepthTex[6],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>7\nelse if (i == 7) { shadow = getShadowVal(lDepthTex[7],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\natt = att * shadow;\n#endif\n#if hasProjector && hasShadow\nif (shadowCoord.s >= 0.0&&shadowCoord.s <= 1.0 && shadowCoord.t >= 0.0 && shadowCoord.t <= 1.0 && spotDot > cos((90.0)*(3.14159/180.0))) {\nvec3 projTex = texture2D(lProjTex[i],shadowCoord.st).rgb;\naccum += att * projTex * lInt[i] * mDiff * lDiff[i] * NdotL;\n}\n#else\naccum += att * lDiff[i] * mDiff * NdotL;\n#endif\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * power;\n#else\nspec2 = lSpec[i] * mSpec * power;\n#endif\n#if hasShadow\nspec2 *= shadow;\n#endif\nspecTotal += spec2*spotEffect;\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#if hasShadow\n#endif\n#endif\n#else\n#if lightPoint||lightDirectional||lightSpot||lightArea\ncolor.rgb *= vColor;\ncolor.rgb += vSpec;\n#endif\n#endif \n#if hasReflectMap\nfloat environmentAmount = texture2D( reflectMap, texCoord).r;\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nvec3 r = reflect( u, n );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvec3 coord;\ncoord.s = r.x/m + 0.5;\ncoord.t = r.y/m + 0.5;\n#if hasReflectMap\ncolor.rgb += mColor*accum*texture2D( envSphereMap, coord.st).rgb * environmentAmount;\n#else\ncolor.rgb += mColor*accum*texture2D( envSphereMap, coord.st).rgb * envAmount;\n#endif\n#else\n#if hasReflectMap\ncolor.rgb += mColor*accum*texture2D( envSphereMap, vEnvTextureCoord).rgb * environmentAmount;\n#else\ncolor.rgb += mColor*accum*texture2D( envSphereMap, vEnvTextureCoord).rgb*envAmount;\n#endif\n#endif\n#endif\n#if hasAmbientMap\n#if lightPoint||lightDirectional||lightSpot||lightArea\ncolor.rgb += texture2D(ambientMap, texCoord).rgb*(vec3(1.0,1.0,1.0)+mColor*mAmb);\n#else\ncolor.rgb = color.rgb*texture2D(ambientMap, texCoord).rgb;\n#endif\n#else\n#if !hasColorMap\ncolor.rgb += mColor*mAmb;\n#else\ncolor.rgb += mAmb*texture2D(colorMap, texCoord).rgb;\n#endif\n#endif\n#if alphaDepth\n#if !hasAlpha\nfloat linear_depth = DepthRange( ConvertDepth3(gl_FragCoord.z) );\ncolor.a = linear_depth;\n#endif\n#endif\ngl_FragColor = clamp(color,0.0,1.0);\n#endif \n#if depthPack\n#if hasAlphaMap\nfloat alphaVal = texture2D(alphaMap, texCoord).r;\nif (alphaVal < 0.9) discard;\n#endif\ngl_FragColor = packFloatToVec4i(DepthRange( ConvertDepth3(gl_FragCoord.z)));\n#endif\n}\n";
